                      ***********************************************************************
                      *
                      *               CXCMD, CPU X-3 Command Monitor
                      *
                      *               Master file for CXCMD                   Version 3.02
                      *
                      * (c) Copyright 1995. Roger Landen
                      * (c) Copyright 2025. Roger Landen
                      ***********************************************************************
                      
0000                                  INCLUDE         "mpxdef.asm"
                      ***********************************************************************
                      *
                      *               CXCMD, CPU X-3 Command Monitor
                      *
                      *               Constant Definitions for CPU X-3        Version 3.02
                      *
                      * (c) Copyright 1987,1995,2025. Roger Landen            { MPXDEF.ASM }
                      ***********************************************************************
                      
                      *=============  Address in CPUX3  ===============
0000                  RAM             EQU     $0000                   ; Start of RAM area
DF00                  CLRRAM          EQU     $DF00                   ; Start of Monitor system RAM area To CLEAR
DFFF                  SYSMEMend       EQU     $DFFF                   ; The end of Monitor System Memory
0BFF                  SYSMEMlen       EQU     $0BFF                   ; Total Size 3K, 0-3071
D400                  SYSMEMbeg       EQU     SYSMEMend-SYSMEMlen     ; Start Address of Monitor System Memory
DF00                  SYSRAM          EQU     SYSMEMend & $FF00       ; Start of Monitor SYStem [DP] RAM area
00DF                  CXCMD_DP        EQU     SYSRAM>>8               ; CXCMD [DP] {zero} page # in RAM
DF00                  RESET_STACK     EQU     SYSRAM                  ; Stack pointer for RESET until memtest is done
D800                  SYSSTACK        EQU     SYSMEMbeg+$0400         ; Stack pointer in System Memory (reservd size of 1K)
BFFF                  MAXRAM          EQU     $BFFF                   ; The Designed max Memory address
C000                  EPROM_X         EQU     $C000                   ; Start of Extra EPROM area
E000                  EPROM           EQU     $E000                   ; Start of EPROM area
E800                  EPROM_2         EQU     $E800                   ; Start of EPROM area 2K #2
F000                  EPROM_3         EQU     $F000                   ; Start of EPROM area 2K #3
F800                  EPROM_4         EQU     $F800                   ; Start of EPROM area 2K #4
                                                                      ; UTILS Function JUMP Tabel
E080                  EPROM_firq      EQU     EPROM+$80               ; Start of EPROM FIRQ code area
E100                  EPROM_irq       EQU     EPROM+$100              ; Start of EPROM IRQ code area
E180                  EPROM_nmi       EQU     EPROM+$180              ; Start of EPROM NMI code area
E200                  EPROM_code      EQU     EPROM+$200              ; Start of EPROM CODE area
                      
FF00                  CODEINT         EQU     $FF00                   ; [Interupt] Jump Table
FFF0                  CODEVECTOR      EQU     $FFF0                   ; CPU HW [Interupt] Vector list
                      
                      *=============  IO-devices CPUX3  ===============
                      
                      *-------------  TIMER PTM01  --------------------
D028                  TIMER           EQU     $D028                   ; Timer, Baud rate generators. Rev 3
D028                  TimerControl31  EQU     TIMER                   ; Timer control register 3 or 1
D029                  TimerControl2   EQU     TIMER+1                 ; Timer control register 2
D02A                  Timer_1         EQU     TIMER+2                 ; Timer #1 High Byte
D02B                  Timer_1L        EQU     TIMER+3                 ; Timer #1 Low  Byte
D02C                  Timer_2         EQU     TIMER+4                 ; Timer #2 High Byte
D02D                  Timer_2L        EQU     TIMER+5                 ; Timer #2 Low  Byte
D02E                  Timer_3         EQU     TIMER+6                 ; Timer #3 High Byte
D02F                  Timer_3L        EQU     TIMER+7                 ; Timer #3 Low  Byte
                      
                      *-------------  ACIA MC6850 Status flags  -------
0001                  RDRFm           EQU     %00000001               ; Receive Data Register Full    MC6850
0002                  TDREm           EQU     %00000010               ; Transmit Data Register Empty  MC6850
0010                  FERRm           EQU     %00010000               ; Framing Error                 MC6850
                      
                      *------------------------------------------------
                      
                      * Rev 3
                      *-------------  Serial ACIA1  -------------------
D006                  ACIA01_Status   EQU     $D006                   ; Status register ACIA 01
D007                  ACIA01_Data     EQU     $D007                   ; Data   register ACIA 01
                      *
                      *-------------  Serial ACIA2  -------------------
D016                  ACIA02_Status   EQU     $D016                   ; Status register ACIA 02
D017                  ACIA02_Data     EQU     $D017                   ; Data   register ACIA 02
                      *
                      *-------------  ACIA R6551 Status flags---------
0008                  RDRFr           EQU     %00001000               ; Receive Data Register Full    R6551
0010                  TDREr           EQU     %00010000               ; Transmit Data Register Empty  R6551
0002                  FERRr           EQU     %00000010               ; Framing Error                 R6551
                      *
                      *-------------  Serial R6551  -------------------
D034                  R6551           EQU     $D034                   ; Rockwell ACIA 6551    Rev 3
D034                  R6551data       EQU     R6551                   ; Transmit / Receiver Data Register
D035                  R6551status     EQU     R6551+1                 ; Prog Reset / Status Register
D036                  R6551cmd        EQU     R6551+2                 ; Command Register
D037                  R6551ctrl       EQU     R6551+3                 ; Control Register
                      
                      *------------------------------------------------
                      
                      * Rev 3
                      * PIAs registers
                      * RS0 => A0
                      * RS1 => A1
                      *-------------  Peripheral PIA01  ---------------
D04C                  PIA01_DataA     EQU     $D04C                   ; PIA 01 Data register A
D04D                  PIA01_CtrlA     EQU     $D04D                   ; PIA 01 Control register A
D04E                  PIA01_DataB     EQU     $D04E                   ; PIA 01 Data register B
D04F                  PIA01_CtrlB     EQU     $D04F                   ; PIA 01 Control register B
                      * PIA01_DataDir EQU     $D04C                   ; PIA 01 Data direction register A/B(+1)
                      * PIA01_Control EQU     $D04E                   ; PIA 01 Control register A/B(+1)
                      
                      *-------------  Peripheral PIA02  ---------------
D05C                  PIA02_DataA     EQU     $D05C                   ; PIA 02 Data register A
D05D                  PIA02_CtrlA     EQU     $D05D                   ; PIA 02 Control register A
D05E                  PIA02_DataB     EQU     $D05E                   ; PIA 02 Data register B
D05F                  PIA02_CtrlB     EQU     $D05F                   ; PIA 02 Control register B
                      * PIA02_DataDir EQU     $D05C                   ; PIA 02 Data direction register A/B(+1)
                      * PIA02_Control EQU     $D05E                   ; PIA 02 Control register A/B(+1)
                      
                      *-------------  Peripheral PIA03  ---------------
D06C                  PIA03_DataA     EQU     $D06C                   ; PIA 03 Data register A
D06D                  PIA03_CtrlA     EQU     $D06D                   ; PIA 03 Control register A
D06E                  PIA03_DataB     EQU     $D06E                   ; PIA 03 Data register B
D06F                  PIA03_CtrlB     EQU     $D06F                   ; PIA 03 Control register B
                      * PIA03_DataDir EQU     $D06C                   ; PIA 03 Data direction register A/B(+1)
                      * PIA03_Control EQU     $D06E                   ; PIA 03 Control register A/B(+1)
                      
                      *------------------------------------------------
0000                                  INCLUDE         "macdef.mac"
                      *               PRAGMA  nodollarlocal
                      
                      Anrop           MACRO   
                      \1              *
                                      EXPORT  \1
                                      ENDM
                      
                      NewLine         MACRO
                                      FCB     CR,LF
                                      ENDM
                      
                      NewLineEnd      MACRO
                                      FCB     CR,LF,End
                                      ENDM
                      
                      *.$Text         MACRO
                      *               FCC     \*
                      *               FCB     CR,LF
                      *               ENDM
                      *
                      *.$TextEnd      MACRO
                      *               FCC     \*
                      *               FCB     CR,LF,End
                      *               ENDM
                      *
                      *.$Line         MACRO
                      *               FCC     \*
                      *               FCB     End
                      *               ENDM
                      
                      CMDTAB          MACRO
                                      FDB     \1-EPROM_code,\2-EPROM_code,\3-EPROM_code
                                      ENDM
                      
                      CMDLIST         MACRO
                                      FCB     \1,\2
                                      FDB     \3-EPROM_code,\4-EPROM_code
                                      ENDM
                                      
                      *               Macro to handle diffrent data-segment
                      *============================================================
                      *ZPAGE          MACRO
                      *               ORG     ZPAGE_current
                      *               ENDM
                      *
                      *ZPAGEend       MACRO
                      *ZPAGE_current  SET     *
                      *               ENDM
                      *               
                      *---------------
                      *DATA           MACRO
                      *               ORG     DATA_current
                      *               ENDM
                      *
                      *DATAend                MACRO
                      *DATA_current   SET     *
                      *               ENDM
                      *
                      *               
                      *---------------
                      *CODE           MACRO
                      *               ORG     CODE_current
                      *               ENDM
                      *
                      *CODEend                MACRO
                      *CODE_current   SET     *
                      *               ENDM
                      *
                      *.DEFINE                MACRO
                      *               ENDM
                      *
                      *.DEFINE_end    MACRO
                      *               ENDM
                      *
                      *.DIRECTP       MACRO
                      *               ORG     ZPAGE_current
                      *               ENDM
                      *
                      *.DIRECTP_end   MACRO
                      *ZPAGE_current  SET     *
                      *               ENDM
                      *
                      *.DATA          MACRO
                      *               ORG     DATA_current
                      *               ENDM
                      *
                      *.DATA_end      MACRO
                      *DATA_current   SET     *
                      *               ENDM
0000                                  INCLUDE         "ccflags.asm"
                      ***********************************************************************
                      *
                      *             CC-flags Definitions for MC6809
                      *
                      * 2021. Roger Landen                                    { ccflags.asm }
                      ***********************************************************************
                      
                      *--- Condition Code flags ---
                      
0080                  CC_E    EQU     %10000000       ; Entire Flag
0040                  CC_F    EQU     %01000000       ; FIRQ Mask 
0020                  CC_H    EQU     %00100000       ; Half Carry
0010                  CC_I    EQU     %00010000       ; IRQ Mask
0008                  CC_N    EQU     %00001000       ; Negative
0004                  CC_Z    EQU     %00000100       ; Zero
0002                  CC_O    EQU     %00000010       ; Overflow
0001                  CC_C    EQU     %00000001       ; Carry
                      
0080                  CC_EntireFlag   EQU     CC_E
0040                  CC_FIRQmask     EQU     CC_F
0020                  CC_HalfCarry    EQU     CC_H
0010                  CC_IRQmask      EQU     CC_I
0008                  CC_Negative     EQU     CC_N
0004                  CC_Zero         EQU     CC_Z
0002                  CC_Overflow     EQU     CC_O
0001                  CC_Carry        EQU     CC_C
                      
0080                  SET_EntireFlag  EQU     CC_E            ; $80
0040                  SET_FIRQmask    EQU     CC_F            ; $40
0020                  SET_HalfCarry   EQU     CC_H            ; $20
0010                  SET_IRQmask     EQU     CC_I            ; $10
0008                  SET_Negative    EQU     CC_N            ; $08
0004                  SET_Zero        EQU     CC_Z            ; $04
0002                  SET_Overflow    EQU     CC_O            ; $02
0001                  SET_Carry       EQU     CC_C            ; $01
                      
FF7F                  CLR_EntireFlag  EQU     ~CC_E           ; $7F
FFBF                  CLR_FIRQmask    EQU     ~CC_F           ; $BF
FFDF                  CLR_HalfCarry   EQU     ~CC_H           ; $DF
FFEF                  CLR_IRQmask     EQU     ~CC_I           ; $EF
FFF7                  CLR_Negative    EQU     ~CC_N           ; $F7
FFFB                  CLR_Zero        EQU     ~CC_Z           ; $FB
FFFD                  CLR_Overflow    EQU     ~CC_O           ; $FD
FFFE                  CLR_Carry       EQU     ~CC_C           ; $FE
                      
                      *-----------------------------
                      *********************************
                      *               ASCII
                      *********************************
                      ;NUL            EQU     $00
                      ;SP             EQU     $20
0000                                  INCLUDE         /ascii_ctrl.asm/
                      *--- Some ASCII Characters ---
                      
0000                  End             EQU     $00             ; End Of String
0000                  NUL             EQU     $00             ; Null character                ( ^@ )
0001                  SOH             EQU     $01             ; Start Of Heading              ( ^A )
0002                  STX             EQU     $02             ; Start Of Text                 ( ^B )
0003                  ETX             EQU     $03             ; End Of Text                   ( ^C )
0004                  EOT             EQU     $04             ; End Of Transmission           ( ^D )
0004                  EOL             EQU     $04             ; End Of Line                   ( ^D )
0007                  BEL             EQU     $07             ; Bell                          ( ^G )
0008                  BS              EQU     $08             ; Back Space                    ( ^H )
0009                  TAB             EQU     $09             ; Horizontal TABulator          ( ^I )
000A                  LF              EQU     $0A             ; Line Feed                     ( ^J )
000D                  CR              EQU     $0D             ; Carrige Return                ( ^M )
0010                  DLE             EQU     $10             ; DATA LINK ESCAPE              ( ^P )
0011                  XON             EQU     $11             ; Hanshake Xmit On              ( ^Q )
0013                  XOFF            EQU     $13             ; Handshake Xmit Off            ( ^S )
0018                  CAN             EQU     $18             ; Cancel                        ( ^X )
001B                  ESC             EQU     $1B             ; Escape                        ( ^[ )
0020                  SPACE           EQU     $20             ; Space
0020                  SP              EQU     $20             ; Space
007F                  DEL             EQU     $7F             ; Delete
                      
                      
                      *---------------------------------------------------------------------
                      *               CXCMD   Setup
                      *---------------------------------------------------------------------
                      *               ZeroPage section
                      *---------------================----------------
F181                                  RAM
                      *               Memory start
                      *               ============
DF00                                  ORG     SYSRAM
DF00                                  SETDP   CXCMD_DP
                      
                      *               Data section
                      *---------------============--------------------
0000                                  DATA
0100                                  ORG     RAM+$0100
0100                                  SETDP   CXCMD_DP
                      
                      *               EPROM CODE section
                      *---------------==================--------------------
0000                                  CODE
E000                                  ORG     EPROM                   ; Start of EPROM chip
E000                                  SETDP   CXCMD_DP
                      
                      ***********************************************************************
                      *       Fill out/Mark the start of EPROM chip 
                      ***********************************************************************
E000  415353495354303920666F722043505520582D33 HELLO           FCB     "ASSIST09 for CPU X-3"
E014  0400                            FCB     EOT,NUL
                      
                      *---------------------------------------------------------------------
                      *               Tiny BASIC code
                      *---------------------------------------------------------------------
E016                                  INCLUDE         /basic.asm/
                      *       WRITTEN 20-OCT-77 BY JOHN BYRNS
                      *       REVISED 30-DEC-77
                      *       REVISED 18-JAN-78
                      *       REVISED 10-APR-78
                      *       REVISED 08-MAY-79 TO ELIMINATE USE OF SP
                      *       REVISED 24-JAN-80 TO USE 6801 ON CHIP RAM
                      *       REVISED 26-JAN-80 FOR NEW 6801 INSTRUCTIONS
                      *       REVISED 24-JUL-81 FOR WHISTON BOARD
                      *       REVISED 24-SEP-81 INCLUDE USER FUNCTION
                      *       REVISED 08-APR-82 MAKE STANDALONE INCLUDE HEX CONSTANTS AND MEM FUNCTION
                      *       REVISED 21-NOV-84 FOR 6809
                      *       REVISED FEB 94 ADAPTED TO SIMULATOR AND BUGFIXES BY L.C. BENSCHOP.
                      *       Adoptet for MDLX-3 / fre  5 mar 2021 18:02:12 CET
                      *       Adoptet for CXCMD, CPU X-3 Command Monitor / Fri Feb  7 19:10:42 CET 2025
                      *       Adoptet for ASSIST09 on CPU X-3 SBC / Sat Dec  6 14:51:50 CET 2025
                      *
                      
                      *               Interna Defines
                      *---------------===============-----------------
                      
                      *-------- Konstanter --------
                      *
                      *       ASCII <ctrl>
                      *EOL            EQU     $04
                      *ETX            EQU     $03
                      *SPACE          EQU     $20
                      *CR             EQU     $0D
                      *LF             EQU     $0A
                      *BS             EQU     $08
                      *CAN            EQU     $18
                      *BELL           EQU     $07
                      *FILL           EQU     $00
                      *DEL            EQU     $7F
                      
0049                  BSIZE           EQU     73
0030                  STKCUS          EQU     48
                      *---------------------------
                      
                      *-------- SWI Assist09 Func --------------------
                      
                      *               INCLUDE /swi_func.asm/
                      
                      *-------- Adresser --------
                      *
                      * ACIA          EQU     $E000
                      * RMCR          EQU     ACIA
                      * TRCS          EQU     ACIA
                      * RECEV         EQU     ACIA+1
                      * TRANS         EQU     ACIA+1
                      * CNTL1         EQU     $03
                      * CNTL2         EQU     $15
                      * RDRF          EQU     $01
                      * ORFE          EQU     $20
                      * TDRE          EQU     $02
                      * EDIT THE FOLLOWING EQUATES TO REFLECT THE
                      * DESIRED ROM AND RAM LAYOUT
                      * LORAM         EQU     $0080   ; ADDRESS OF DIRECT PAGE SCRATCH RAM
                      * BUFFER        EQU     $4000   ; ADDRESS OF MAIN RAM
                      * RAMSIZ        EQU     $2000   ; SIZE OF MAIN RAM
                      * ROMADR        EQU     $400    ; ADDRESS OF TINY BASIC ROM
                      *
                      * RAMBEG        EQU     BUFFER+BSIZE
                      * RAMEND        EQU     BUFFER+RAMSIZ
                      * RAMEND                EQU     RAM+RamLength
                      *
AA0F                  RAMPAT          EQU     $AA0F
F055                  ROMPAT          EQU     $F055
                      *
                      *---------------------------
                      
                      *               ZEROP DATA
                      *---------------============--------------------
DF00                                  RAM
DF00                                  SETDP   CXCMD_DP
                      
                      *----- Variable Area -------
DF00                  RAMSIZE         RMB     2       ; What RAM size did we find we have
DF02                  USRBAS          RMB     2       ; Basic prog BAS
DF04                  USRTOP          RMB     2       ; Basic prog current END (TOP)
DF06                  STKLIM          RMB     2       ; Stack Point Limit
DF08                  STKTOP          RMB     2       ; Stack Point Top
DF0A                  CURSOR          RMB     2
DF0C                  SAVESP          RMB     2       ; Saved Stack Point
DF0E                  LINENB          RMB     2
DF10                  SCRTCH          RMB     2
DF12                  CHAR            RMB     2
DF14                  ZONE            RMB     1
DF15                  TapeMODE        RMB     1
DF16                  RESRVD          RMB     1
DF17                  LOEND           EQU     *
                      
                      *               RAM DATA
                      *---------------============--------------------
0100                                  DATA
0100                                  SETDP   CXCMD_DP
                      
0100                  BUFFER          RMB     BSIZE
0149                  RAMBEG          RMB     1
                      *
                      *               CODE section
                      *---------------============--------------------
E016                                  CODE
E016                                  SETDP   CXCMD_DP
                      *
E016                                  Anrop   /BASIC/
E016                  \1              *
                                      EXPORT  \1
E016  2008                            BRA     SETUP
E018  10DE08          WARMS           LDS     STKTOP
E01B  17087D                          LBSR    INTEEE
E01E  2016                            BRA     WMS05
                      ; SETUP         LDS     #RAMEND-52
E020  DC00            SETUP           LDD     RAMSIZE
E022  830034                          SUBD    #52
E025  1F04                            TFR     D,S
                      
E027  10DF08          SET03           STS     STKTOP
E02A  17086E                          LBSR    INTEEE
                      *
E02D  CC0149          CLEAR           LDD     #RAMBEG
E030  DD02                            STD     USRBAS
E032  DD04                            STD     USRTOP
E034  DD06            CLR02           STD     STKLIM
E036  BDE15A          WMS05           JSR     CRLF
E039  8EE091                          LDX     #VerSTR
E03C  170114                          LBSR    PUTSTR
                      *
E03F  10DE08          CMDB            LDS     STKTOP          ; Set Stack Pointer
E042  0F15                            CLR     TapeMODE        ; Not in Paper Tape mode, Normal cmd
E044  170113                          LBSR    CRLF            ; NewLine...
E047  9E02                            LDX     USRBAS          ; Get Basic program Start
E049  9F0A                            STX     CURSOR          ; Set Current pos in Basic prog
E04B  8E0000          CMDE            LDX     #0000
E04E  9F0E                            STX     LINENB
E050  0D15                            TST     TapeMODE        ; Paper Tape mode ?
E052  2605                            BNE     CMD01           ; Yes, skip cmd-prompt
E054  863E                            LDA     #'>             ; cmd-prompt...
E056  17083E                          LBSR    PUTCHR          ; print...
                      *
E059  170188          CMD01           LBSR    GETLIN          ; Get Line in
E05C  1702D2                          LBSR    TSTNBR          ; Test for Number
E05F  240E                            BCC     CMD02           ; There is a number
E061  292B                            BVS     CMD05
E063  17023C                          LBSR    SKIPSP          ; Skip over space
E066  8104                            CMPA    #EOL            ; End Of Line ?
E068  27E1                            BEQ     CMDE            ; Next Line...
E06A  1701E7                          LBSR    MSLINE
E06D  20D0                            BRA     CMDB
                      
E06F  3410            CMD02           PSHS    X
E071  9E04                            LDX     USRTOP          ; Basic End
E073  9C06                            CMPX    STKLIM          ; == Stack limit ?
E075  3510                            PULS    X
E077  2703                            BEQ     CMD03           ; Yes, End Of Memory
E079  160132                          LBRA    ERRORR          ; 'HOW ?'
                      *
E07C  C30000          CMD03           ADDD    #0
E07F  270D                            BEQ     CMD05
E081  3406            CMD04           PSHS    D
E083  83270F                          SUBD    #9999
E086  3506                            PULS    D
E088  2204                            BHI     CMD05
E08A  8D1D                            BSR     EDITOR
E08C  20BD                            BRA     CMDE
E08E  1600DC          CMD05           LBRA    CMDERRORS
                      *
E091  54494E592056312E33372E32205B41535349535430395D VerSTR          FCC     "TINY V1.37.2 [ASSIST09]"
E0A8  04                              FCB     EOL
                      ******************************
                      
                      ******************************
E0A9  3406            EDITOR  PSHS    D
E0AB  BDE2A2                  JSR     SKIPSP
E0AE  9F10                    STX     SCRTCH
E0B0  A6E4                    LDA     0,S
E0B2  9E0A                    LDX     CURSOR
E0B4  9C04                    CMPX    USRTOP
E0B6  2705                    BEQ     ED00
E0B8  10A384                  CMPD    0,X
E0BB  2402                    BCC     ED01
E0BD  9E02            ED00    LDX     USRBAS
E0BF  BDE40C          ED01    JSR     FNDLIN
E0C2  9F0A                    STX     CURSOR
E0C4  2522                    BCS     ED04
E0C6  9F0C                    STX     SAVESP
E0C8  3002                    LEAX    2,X
E0CA  A680            ED02    LDA     ,X+
E0CC  8104                    CMPA    #EOL
E0CE  26FA                    BNE     ED02
E0D0  9C04            ED03    CMPX    USRTOP
E0D2  270E                    BEQ     ED35
E0D4  A680                    LDA     ,X+
E0D6  9F12                    STX     CHAR
E0D8  9E0C                    LDX     SAVESP
E0DA  A780                    STA     ,X+
E0DC  9F0C                    STX     SAVESP
E0DE  9E12                    LDX     CHAR
E0E0  20EE                    BRA     ED03
E0E2  9E0C            ED35    LDX     SAVESP
E0E4  9F04                    STX     USRTOP
E0E6  9F06                    STX     STKLIM
E0E8  9E10            ED04    LDX     SCRTCH
E0EA  C6FF                    LDB     #-1
E0EC  5C              ED05    INCB
E0ED  A680                    LDA     ,X+
E0EF  8104                    CMPA    #EOL
E0F1  26F9                    BNE     ED05
E0F3  5D                      TSTB
E0F4  2603                    BNE     ED55
E0F6  3262                    LEAS    2,S
E0F8  39                      RTS
E0F9  301F            ED55    LEAX    -1,X
E0FB  CB04                    ADDB    #4
E0FD  301F            ED06    LEAX    -1,X
E0FF  5A                      DECB
E100  A684                    LDA     0,X
E102  8120                    CMPA    #SPACE
E104  27F7                    BEQ     ED06
E106  8604                    LDA     #EOL
E108  A701                    STA     1,X
E10A  4F                      CLRA
E10B  9E04                    LDX     USRTOP
E10D  9F12                    STX     CHAR
E10F  D304                    ADDD    USRTOP
E111  DD04                    STD     USRTOP
E113  DD06                    STD     STKLIM
E115  BDE3A8                  JSR     TSTSTK
E118  2407                    BCC     ED07
E11A  9F04                    STX     USRTOP
E11C  9F06                    STX     STKLIM
E11E  7EE165                  JMP     ERRORF
E121  9E04            ED07    LDX     USRTOP
E123  9F0C            ED08    STX     SAVESP
E125  9E12                    LDX     CHAR
E127  9C0A                    CMPX    CURSOR
E129  270A                    BEQ     ED09
E12B  A682                    LDA     ,-X
E12D  9F12                    STX     CHAR
E12F  9E0C                    LDX     SAVESP
E131  A782                    STA     ,-X
E133  20EE                    BRA     ED08
E135  3506            ED09    PULS    D
E137  9E0A                    LDX     CURSOR
E139  ED81                    STD     ,X++
E13B  9F12                    STX     CHAR
E13D  9E10            ED10    LDX     SCRTCH
E13F  A680                    LDA     ,X+
E141  9F10                    STX     SCRTCH
E143  9E12                    LDX     CHAR
E145  A780                    STA     ,X+
E147  9F12                    STX     CHAR
E149  8104                    CMPA    #EOL
E14B  26F0                    BNE     ED10
E14D  39                      RTS
                      ******************************
                      ******************************
E14E  BDE897          PUTS01  JSR     PUTCHR
E151  3001                    LEAX    1,X
E153  A684            PUTSTR  LDA     0,X
E155  8104                    CMPA    #EOL
E157  26F5                    BNE     PUTS01
E159  39                      RTS
                      ******************************
                      ******************************
E15A  8EE162          CRLF            LDX     #CRLFST
E15D  8DF4                            BSR     PUTSTR
E15F  0F14                            CLR     ZONE
E161  39                              RTS
                      
                      *+CRLFST        FCB     CR,LF,DEL,FILL,FILL,FILL,EOL    ; Paper Tape Read time fill
E162  0D0A04          CRLFST          FCB     CR,LF,EOL
                      ******************************
                      ******************************
E165  8D5E            ERRORF          BSR     PrintError
E167  534F525259                      FCC     "SORRY"
E16C  04                              FCB     EOL
                      *
E16D  8D56            CMDERRORS       BSR     PrintError
E16F  434D44204552523F                 FCC     "CMD ERR?"
E177  04                              FCB     EOL
                      *
E178  8D4B            USRERRORS       BSR     PrintError
E17A  555352204552523F                 FCC     "USR ERR?"
E182  04                              FCB     EOL
                      *
E183  8D40            POKEERRORS      BSR     PrintError
E185  504F4B45204552523F                 FCC     "POKE ERR?"
                      
E18E  04                              FCB     EOL
                      *
E18F  8D34            EOLERRORS       BSR     PrintError
E191  454F4C204552523F                 FCC     "EOL ERR?"
E199  04                              FCB     EOL
                      *
E19A  8D29            PRTERRORS       BSR     PrintError
E19C  505254204552523F                 FCC     "PRT ERR?"
E1A4  04                              FCB     EOL
                      *
E1A5  8D1E            ERRORS          BSR     PrintError
E1A7  57484154203F                    FCC     "WHAT ?"
E1AD  04                              FCB     EOL
                      *
E1AE  8D15            ERRORR          BSR     PrintError
E1B0  484F57203F                      FCC     "HOW ?"
E1B5  04                              FCB     EOL
                      *
E1B6  8D0D            BREAKERR        BSR     PrintError
E1B8  425245414B                      FCC     "BREAK"
E1BD  04                              FCB     EOL
                      *
E1BE  8D05            END             BSR     PrintError
E1C0  53544F50                        FCC     "STOP"
E1C4  04                              FCB     EOL
                      *
E1C5  8D93            PrintError      BSR     CRLF
E1C7  8607                            LDA     #BEL
E1C9  BDE897                          JSR     PUTCHR
E1CC  DC0E                            LDD     <LINENB
E1CE  BDE6A6                          JSR     PRNT4
E1D1  8620                            LDA     #SPACE
E1D3  BDE897                          JSR     PUTCHR
E1D6  3510                            PULS    X
E1D8  17FF78                          LBSR    PUTSTR
E1DB  17FF7C                          LBSR    CRLF
E1DE  7EE03F                          JMP     CMDB
                      ******************************
                      
                      ******************************
E1E1  17FF76          GL00            LBSR    CRLF
E1E4  8E0100          GETLIN          LDX     #BUFFER         ; Get Start of input buffert
E1E7  BDE886          NextCharIn      JSR     GETCHR          ; Get a char in
E1EA  8120                            CMPA    #SPACE          ; Compare with <SPACE>
E1EC  2514                            BCS     GL05            ; Less than - <CTRL>-char
E1EE  817F                            CMPA    #DEL            ; <DEL> ?
E1F0  272B                            BEQ     BackSpaceB      ; Same as BackSpace
E1F2  8C0148                          CMPX    #BUFFER+BSIZE-1 ; input buffert full ?
E1F5  2604                            BNE     GL04            ;  No
E1F7  8607                            LDA     #BEL            ; <PLING>
E1F9  2002                            BRA     EchoCharIn      ; write
E1FB  A780            GL04            STA     ,X+             ; Save char in input buffert
E1FD  BDE897          EchoCharIn      JSR     PUTCHR          ; Echo Char
E200  20E5                            BRA     NextCharIn      ; Next Char
                      *
E202  8108            GL05            CMPA    #BS             ; <BackSpace> ?
E204  2717                            BEQ     BackSpaceB      ;  Yes
E206  8118                            CMPA    #CAN            ; <CANcel> ?
E208  27D7                            BEQ     GL00            ;  Yes
                      *-              CMPA    #LF             ; <LineFeed> ?
                      *-              BEQ     LineFeedB       ;  Yes
E20A  810D                            CMPA    #CR             ; <CarrigeReturn> ?
E20C  26D9                            BNE     NextCharIn      ;  No
                      *-              TST     TapeMODE
                      *-              BEQ     GL06
                      *-              JSR     PUTCHR
                      *-              BRA     GL08
                      *
E20E  3410            GL06            PSHS    X               ; Save Buffert Pointer
E210  BDE15A                          JSR     CRLF            ; Make a new line on Screen
E213  3510                            PULS    X               ; Restore Buffert Pointer
E215  8604            GL08            LDA     #EOL            ; <EndOfLine>
E217  A784                            STA     0,X             ; Set end of input line
E219  8E0100                          LDX     #BUFFER         ; Set Pointer to start of input buffert
E21C  39                              RTS
                      *
E21D  8C0100          BackSpaceB      CMPX    #BUFFER         ; At buffert start ?
E220  27C5                            BEQ     NextCharIn      ;  Yes
E222  301F                            LEAX    -1,X            ; Go one step back in buffert
E224  8608                            LDA     #BS
E226  BDE897                          JSR     PUTCHR          ; Step back on screen
E229  8620                            LDA     #SPACE
E22B  BDE897                          JSR     PUTCHR          ; Clear char on screen
E22E  8608                            LDA     #BS             ; Go back again
E230  20CB                            BRA     EchoCharIn
                      *
E232  1A01            LineFeedB       ORCC    #CC_Carry
E234  0615                            ROR     TapeMODE
E236  20C5                            BRA     EchoCharIn
                      ******************************
                      
                      ******************************
E238  3001            REM00   LEAX    1,X
E23A  8D66            REM     BSR     SKIPSP
E23C  8104                    CMPA    #EOL
E23E  26F8                    BNE     REM00
E240  BDE579          ENDSMT  JSR     TSTEOL
E243  960E            ENDS02  LDA     LINENB
E245  9A0F                    ORA     LINENB+1
E247  2714                    BEQ     REM09
E249  9C04            REM05   CMPX    USRTOP
E24B  2603                    BNE     NXTLIN
E24D  7EE1AE                  JMP     ERRORR
E250  EC81            NXTLIN  LDD     ,X++
E252  DD0E                    STD     LINENB
E254  17061B          MSLINE  LBSR    TestBreak
E257  8D08                    BSR     IFAN
E259  2503                    BCS     IMPLET
E25B  3406                    PSHS    D
E25D  39              REM09   RTS
E25E  7EE58A          IMPLET  JMP     LET
                      ******************************
                      ******************************
E261  8D3F            IFAN    BSR     SKIPSP
E263  9F0A                    STX     CURSOR
E265  8EE799                  LDX     #VERBT
E268  A680            FAN00   LDA     ,X+
E26A  8104                    CMPA    #EOL
E26C  2605                    BNE     FAN04
E26E  9E0A                    LDX     CURSOR
E270  1A01                    ORCC    #$01
E272  39                      RTS
                      
E273  9F12            FAN04   STX     CHAR
E275  9E0A                    LDX     CURSOR
E277  9F10                    STX     SCRTCH
E279  9E10            FAN05   LDX     SCRTCH
E27B  A184                    CMPA    0,X
E27D  2615                    BNE     FAN07
E27F  3001                    LEAX    1,X
E281  9F10                    STX     SCRTCH
E283  9E12                    LDX     CHAR
E285  A680                    LDA     ,X+
E287  9F12                    STX     CHAR
E289  8104                    CMPA    #EOL
E28B  26EC                    BNE     FAN05
E28D  EC84                    LDD     0,X
E28F  9E10                    LDX     SCRTCH
E291  1CFE                    ANDCC   #$FE
E293  39                      RTS
E294  9E12            FAN07   LDX     CHAR
E296  A680            FAN08   LDA     ,X+
E298  8104                    CMPA    #EOL
E29A  26FA                    BNE     FAN08
E29C  3002                    LEAX    2,X
E29E  20C8                    BRA     FAN00
                      ******************************
                      
                      * Skip SPACE in input line
                      ******************************
E2A0  3001            NextSP          LEAX    1,X             ; input line pointer++
E2A2  A684            SKIPSP          LDA     0,X             ; Get CHAR from input line
                      * DBG           LBSR    WriteChar
E2A4  8120                            CMPA    #SPACE          ; == ' '
E2A6  27F8                            BEQ     NextSP          ; YES
E2A8  39                              RTS
                      ******************************
                      
                      * Test if it is HEX #
                      ******************************
E2A9                  TSTHEX
E2A9  8D1A                            BSR     TSTDIG          ; Is it a digit ?
E2AB  240A                            BCC     TSTok
                      *               ANDA    #%01011111      ;Make it to upper case
E2AD  8141                            CMPA    #'A             ; Test
E2AF  2511                            BCS     TSTerr          ; < 'A'
E2B1  8146                            CMPA    #'F             ; Test
E2B3  220D                            BHI     TSTerr          ; > 'F'
E2B5  8037                            SUBA    #'A-10          ; make binary of $A-F
E2B7  1CFE            TSTok           ANDCC   #CLR_Carry      ; Yes, it's ok, was a hexdigit
E2B9  39                              RTS
                      ******************************
                      
                      * Test if it is a Letter
                      ******************************
E2BA                  TSTLTR
E2BA  8141                            CMPA    #'A             ; Test
E2BC  2504                            BCS     TSTerr          ; < 'A'
E2BE  815A                            CMPA    #'Z             ; Test
E2C0  23F5                            BLS     TSTok           ; <= 'F'
E2C2  1A01            TSTerr          ORCC    #SET_Carry      ; No, it was wrong
E2C4  39                              RTS
                      ******************************
                      
                      * Test if it is digit
                      ******************************
E2C5                  TSTDIG
E2C5  8130                            CMPA    #'0             ; Test
E2C7  25F9                            BCS     TSTerr          ; < '0'
E2C9  8139                            CMPA    #'9             ; Test
E2CB  22F5                            BHI     TSTerr          ; > '9'
E2CD  8030                            SUBA    #'0             ; Make it to binary
E2CF  1CFE                            ANDCC   #CLR_Carry      ; Yes, it's ok, was a digit
E2D1  39                              RTS
                      ******************************
                      
                      *
                      ******************************
E2D2  8DCE            TSTVAR          BSR     SKIPSP
E2D4  8DE4                            BSR     TSTLTR
E2D6  2512                            BCS     TSTV03
E2D8  1F89                            TFR     A,B
E2DA  A601                            LDA     1,X
E2DC  8DDC                            BSR     TSTLTR
E2DE  24E2                            BCC     TSTerr
E2E0  3001                            LEAX    1,X
E2E2  C041                            SUBB    #'A
E2E4  58                              ASLB
E2E5  4F                              CLRA
E2E6  D308                            ADDD    STKTOP
E2E8  1CFE            TSTV02          ANDCC   #CLR_Carry
E2EA  39              TSTV03          RTS
                      ******************************
                      ******************************
E2EB  BDE558          USER            JSR     ARGONE
E2EE  3406                            PSHS    D
E2F0  BDE2A2                          JSR     SKIPSP
E2F3  812C                            CMPA    #',
E2F5  2709                            BEQ     USER03
E2F7  8129                            CMPA    #')
E2F9  1A01                            ORCC    #SET_Carry
E2FB  2715                            BEQ     USER05
E2FD  7EE178          USER02          JMP     USRERRORS
                      
E300  3001            USER03          LEAX    1,X
E302  BDE48B                          JSR     EXPR
E305  3402                            PSHS    A
E307  BDE2A2                          JSR     SKIPSP
E30A  8129                            CMPA    #')
E30C  3502                            PULS    A
E30E  26ED                            BNE     USER02
E310  1CFE                            ANDCC   #CLR_Carry
E312  3001            USER05          LEAX    1,X
E314  9F0A                            STX     CURSOR
E316  ADF1                            JSR     [,S++]
E318  9E0A                            LDX     CURSOR
E31A  1CFE                            ANDCC   #CLR_Carry
E31C  39                              RTS
                      ******************************
                      ******************************
E31D  BDE2A2          TSTSNB          JSR     SKIPSP
E320  812D                            CMPA    #'-
E322  260D                            BNE     TSTNBR
E324  3001                            LEAX    1,X
E326  8D09                            BSR     TSTNBR
E328  2506                            BCS     TSN02
E32A  40                              NEGA
E32B  50                              NEGB
E32C  8200                            SBCA    #0
E32E  1CFE                            ANDCC   #CLR_Carry
E330  39              TSN02           RTS
                      ******************************
                      
                      * Test if ther is a number,  $nn -> HexNumber
                      ******************************
E331  17FF6E          TSTNBR          LBSR    SKIPSP          ; Skip SPACE
E334  8D8F                            BSR     TSTDIG          ; Test if digit
E336  242F                            BCC     TSTN02
E338  8124                            CMPA    #'$
E33A  1A01                            ORCC    #SET_Carry
E33C  2660                            BNE     TSTN09
E33E  3001            TSTN20          LEAX    1,X
E340  6FE2                            CLR     ,-S
E342  6FE2                            CLR     ,-S
E344  A684            TSTN23          LDA     0,X
E346  BDE2A9                          JSR     TSTHEX
E349  254F                            BCS     TSTN07
E34B  3001                            LEAX    1,X
E34D  3410                            PSHS    X
E34F  3402                            PSHS    A
E351  EC63                            LDD     3,S
E353  85F0                            BITA    #$F0
E355  264A                            BNE     TSTN11
E357  58                              ASLB
E358  49                              ROLA
E359  58                              ASLB
E35A  49                              ROLA
E35B  58                              ASLB
E35C  49                              ROLA
E35D  58                              ASLB
E35E  49                              ROLA
E35F  EBE0                            ADDB    ,S+
E361  ED62                            STD     2,S
E363  3510                            PULS    X
E365  20DD                            BRA     TSTN23
E367  3001            TSTN02          LEAX    1,X
E369  3402                            PSHS    A
E36B  6FE2                            CLR     ,-S
E36D  A684            TSTN03          LDA     0,X
E36F  BDE2C5                          JSR     TSTDIG
E372  2526                            BCS     TSTN07
E374  3001                            LEAX    1,X
E376  3410                            PSHS    X
E378  3402                            PSHS    A
E37A  EC63                            LDD     3,S
E37C  58                              ASLB
E37D  49                              ROLA
E37E  2921                            BVS     TSTN11
E380  58                              ASLB
E381  49                              ROLA
E382  291D                            BVS     TSTN11
E384  E363                            ADDD    3,S
E386  2919                            BVS     TSTN11
E388  58                              ASLB
E389  49                              ROLA
E38A  2915                            BVS     TSTN11
E38C  EBE4                            ADDB    0,S
E38E  8900                            ADCA    #0
E390  290F                            BVS     TSTN11
E392  ED63                            STD     3,S
E394  3261                            LEAS    1,S
E396  3510                            PULS    X
E398  20D3                            BRA     TSTN03
E39A  3506            TSTN07          PULS    D
E39C  1CFE                            ANDCC   #CLR_Carry
E39E  1CFD            TSTN09          ANDCC   #CLR_Overflow
E3A0  39                              RTS
E3A1  AE61            TSTN11          LDX     1,S
E3A3  3265                            LEAS    5,S
E3A5  1A03                            ORCC    #SET_Carry|SET_Overflow
E3A7  39                              RTS
                      ******************************
                      ******************************
E3A8  10DF0C          TSTSTK  STS     SAVESP
E3AB  DC0C                    LDD     SAVESP
E3AD  830030                  SUBD    #STKCUS
E3B0  9306                    SUBD    STKLIM
E3B2  39                      RTS
                      ******************************
                      ******************************
E3B3  BDE545          PEEK    JSR     PAREXP
E3B6  3406                    PSHS    D
E3B8  3410                    PSHS    X
E3BA  E6F802                  LDB     [2,S]
E3BD  3510                    PULS    X
E3BF  3262                    LEAS    2,S
E3C1  4F                      CLRA
E3C2  39                      RTS
                      ******************************
                      ******************************
E3C3  BDE545          POKE    JSR     PAREXP
E3C6  3406                    PSHS    D
E3C8  BDE2A2                  JSR     SKIPSP
E3CB  813D                    CMPA    #'=
E3CD  2703                    BEQ     POKE05
E3CF  7EE183                  JMP     POKEERRORS
                      *
E3D2  3001            POKE05  LEAX    1,X
E3D4  BDE48B                  JSR     EXPR
E3D7  BDE579                  JSR     TSTEOL
E3DA  3410                    PSHS    X
E3DC  E7F802                  STB     [2,S]
E3DF  3510                    PULS    X
E3E1  3262                    LEAS    2,S
E3E3  7EE243                  JMP     ENDS02
                      ******************************
                      ******************************
E3E6  BDE2A2          TSTFUN  JSR     SKIPSP
E3E9  9F0A                    STX     CURSOR
E3EB  8EE3F6                  LDX     #FUNT
E3EE  BDE268                  JSR     FAN00
E3F1  2502                    BCS     TSTF05
E3F3  3406                    PSHS    D
E3F5  39              TSTF05  RTS
                      ******************************
                      ******************************
E3F6  555352          FUNT            FCC     "USR"
E3F9  04                              FCB     EOL
E3FA  E2EB                            FDB     USER
E3FC  5045454B                        FCC     "PEEK"
E400  04                              FCB     EOL
E401  E3B3                            FDB     PEEK
E403  4D454D                          FCC     "MEM"
E406  04                              FCB     EOL
E407  E3A8                            FDB     TSTSTK
E409  04                              FCB     EOL
                      ******************************
                      ******************************
E40A  9E02            FLINE   LDX     USRBAS
E40C  9C04            FNDLIN  CMPX    USRTOP
E40E  2603                    BNE     FND03
E410  1A03                    ORCC    #SET_Carry|SET_Overflow
E412  39                      RTS
E413  10A384          FND03   CMPD    0,X
E416  2603                    BNE     FND05
E418  1CFC                    ANDCC   #$FC
E41A  39                      RTS
E41B  2405            FND05   BCC     FND07
E41D  1A01                    ORCC    #SET_Carry
E41F  1CFD                    ANDCC   #CLR_Overflow
E421  39                      RTS
E422  3402            FND07   PSHS    A
E424  8604                    LDA     #EOL
E426  3001                    LEAX    1,X
E428  3001            FND09   LEAX    1,X
E42A  A184                    CMPA    0,X
E42C  26FA                    BNE     FND09
E42E  3502                    PULS    A
E430  3001                    LEAX    1,X
E432  20D8                    BRA     FNDLIN
                      ******************************
                      ******************************
E434  8D55            RELEXP  BSR     EXPR
E436  3406                    PSHS    D
E438  5F                      CLRB
E439  BDE2A2                  JSR     SKIPSP
E43C  813D                    CMPA    #'=
E43E  2723                    BEQ     REL06
E440  813C                    CMPA    #'<
E442  2610                    BNE     REL03
E444  3001                    LEAX    1,X
E446  5C                      INCB
E447  BDE2A2                  JSR     SKIPSP
E44A  813E                    CMPA    #'>
E44C  2611                    BNE     REL05
E44E  3001                    LEAX    1,X
E450  CB04                    ADDB    #4
E452  2013                    BRA     REL07
E454  813E            REL03   CMPA    #'>
E456  265F                    BNE     EXPR06
E458  3001                    LEAX    1,X
E45A  CB04                    ADDB    #4
E45C  BDE2A2                  JSR     SKIPSP
E45F  813D            REL05   CMPA    #'=
E461  2604                    BNE     REL07
E463  3001            REL06   LEAX    1,X
E465  CB02                    ADDB    #2
E467  3404            REL07   PSHS    B
E469  8D20                    BSR     EXPR
E46B  3410                    PSHS    X
E46D  A363                    SUBD    3,S
E46F  1FA8                    TFR     CC,A
E471  44                      LSRA
E472  1F89                    TFR     A,B
E474  48                      ASLA
E475  48                      ASLA
E476  3404                    PSHS    B
E478  ABE0                    ADDA    ,S+
E47A  8406                    ANDA    #$06
E47C  2601                    BNE     REL08
E47E  4C                      INCA
E47F  5F              REL08   CLRB
E480  A462                    ANDA    2,S
E482  2701                    BEQ     REL09
E484  53                      COMB
E485  4F              REL09   CLRA
E486  3510                    PULS    X
E488  3263                    LEAS    3,S
E48A  39                      RTS
                      ******************************
                      ******************************
E48B  6FE2            EXPR    CLR     ,-S
E48D  6FE2                    CLR     ,-S
E48F  BDE2A2                  JSR     SKIPSP
E492  812D                    CMPA    #'-
E494  2717                    BEQ     EXPR05
E496  812B                    CMPA    #'+
E498  2602                    BNE     EXPR03
E49A  3001            EXPR02  LEAX    1,X
E49C  8D1C            EXPR03  BSR     TERM
E49E  E3E4            EXPR04  ADDD    0,S
E4A0  EDE4                    STD     0,S
E4A2  BDE2A2                  JSR     SKIPSP
E4A5  812B                    CMPA    #'+
E4A7  27F1                    BEQ     EXPR02
E4A9  812D                    CMPA    #'-
E4AB  260A                    BNE     EXPR06
E4AD  3001            EXPR05  LEAX    1,X
E4AF  8D09                    BSR     TERM
E4B1  40                      NEGA
E4B2  50                      NEGB
E4B3  8200                    SBCA    #0
E4B5  20E7                    BRA     EXPR04
E4B7  3506            EXPR06  PULS    D
E4B9  39                      RTS
                      ******************************
                      ******************************
E4BA  BDE52D          TERM    JSR     FACT
E4BD  3406                    PSHS    D
E4BF  BDE2A2          TERM03  JSR     SKIPSP
E4C2  812A                    CMPA    #'*
E4C4  2748                    BEQ     TERM07
E4C6  812F                    CMPA    #'/
E4C8  2703                    BEQ     TERM05
E4CA  3506                    PULS    D
E4CC  39                      RTS
E4CD  3001            TERM05  LEAX    1,X
E4CF  8D5C                    BSR     FACT
E4D1  3410                    PSHS    X
E4D3  3062                    LEAX    2,S
E4D5  3406                    PSHS    D
E4D7  A884                    EORA    0,X
E4D9  BDE56C                  JSR     ABSX
E4DC  30E4                    LEAX    0,S
E4DE  BDE56C                  JSR     ABSX
E4E1  3402                    PSHS    A
E4E3  8611                    LDA     #17
E4E5  3402                    PSHS    A
E4E7  4F                      CLRA
E4E8  5F                      CLRB
E4E9  A362            DIV05   SUBD    2,S
E4EB  2406                    BCC     DIV07
E4ED  E362                    ADDD    2,S
E4EF  1CFE                    ANDCC   #CLR_Carry
E4F1  2002                    BRA     DIV09
E4F3  1A01            DIV07   ORCC    #SET_Carry
E4F5  6967            DIV09   ROL     7,S
E4F7  6966                    ROL     6,S
E4F9  59                      ROLB
E4FA  49                      ROLA
E4FB  6AE4                    DEC     0,S
E4FD  26EA                    BNE     DIV05
E4FF  A661                    LDA     1,S
E501  3264                    LEAS    4,S
E503  4D                      TSTA
E504  2A04                    BPL     TERM06
E506  3062                    LEAX    2,S
E508  8D66                    BSR     NEGX
E50A  3510            TERM06  PULS    X
E50C  20B1                    BRA     TERM03
E50E  3001            TERM07  LEAX    1,X
E510  8D1B                    BSR     FACT
E512  3404            MULT    PSHS    B
E514  E662                    LDB     2,S
E516  3D                      MUL
E517  A661                    LDA     1,S
E519  E761                    STB     1,S
E51B  E6E4                    LDB     0,S
E51D  3D                      MUL
E51E  A662                    LDA     2,S
E520  E762                    STB     2,S
E522  3504                    PULS    B
E524  3D                      MUL
E525  ABE4                    ADDA    0,S
E527  AB61                    ADDA    1,S
E529  EDE4                    STD     0,S
E52B  2092                    BRA     TERM03
                      ******************************
                      ******************************
E52D  BDE2D2          FACT    JSR     TSTVAR
E530  2509                    BCS     FACT03
E532  3410                    PSHS    X
E534  1F01                    TFR     D,X
E536  EC84                    LDD     0,X
E538  3510                    PULS    X
E53A  39              FACT02  RTS
                      *
E53B  BDE331          FACT03  JSR     TSTNBR
E53E  24FA                    BCC     FACT02
E540  BDE3E6                  JSR     TSTFUN
E543  24F5                    BCC     FACT02
E545  8D11            PAREXP  BSR     ARGONE
E547  3402                    PSHS    A
E549  BDE2A2                  JSR     SKIPSP
E54C  8129                    CMPA    #')
E54E  3502                    PULS    A
E550  2603                    BNE     FACT05
E552  3001                    LEAX    1,X
E554  39                      RTS
E555  7EE1A5          FACT05  JMP     ERRORS
                      ******************************
                      ******************************
E558  BDE3A8          ARGONE  JSR     TSTSTK
E55B  2403                    BCC     FACT04
E55D  7EE165                  JMP     ERRORF
E560  BDE2A2          FACT04  JSR     SKIPSP
E563  8128                    CMPA    #'(
E565  26EE                    BNE     FACT05
E567  3001                    LEAX    1,X
E569  7EE48B                  JMP     EXPR
                      ******************************
                      ******************************
E56C  6D84            ABSX    TST     0,X
E56E  2A08                    BPL     NEG05
E570  6084            NEGX    NEG     0,X
E572  6001                    NEG     1,X
E574  2402                    BCC     NEG05
E576  6A84                    DEC     0,X
E578  39              NEG05   RTS
                      ******************************
                      ******************************
E579  3402            TSTEOL  PSHS    A
E57B  BDE2A2                  JSR     SKIPSP
E57E  8104                    CMPA    #EOL
E580  2703                    BEQ     TEOL03
E582  7EE18F                  JMP     EOLERRORS
                      *
E585  3001            TEOL03  LEAX    1,X
E587  3502                    PULS    A
E589  39                      RTS
                      ******************************
                      ******************************
E58A  BDE2D2          LET     JSR     TSTVAR
E58D  2403                    BCC     LET03
E58F  7EE1A5                  JMP     ERRORS
                      *
E592  3406            LET03   PSHS    D
E594  BDE2A2                  JSR     SKIPSP
E597  813D                    CMPA    #'=
E599  2703                    BEQ     LET05
E59B  7EE1A5                  JMP     ERRORS
                      *
E59E  3001            LET05   LEAX    1,X
E5A0  BDE48B                  JSR     EXPR
E5A3  8DD4                    BSR     TSTEOL
E5A5  9F0A                    STX     CURSOR
E5A7  3510                    PULS    X
E5A9  ED84                    STD     0,X
E5AB  9E0A                    LDX     CURSOR
E5AD  7EE243                  JMP     ENDS02
                      ******************************
                      ******************************
E5B0  BDE434          IF      JSR     RELEXP
E5B3  5D                      TSTB
E5B4  2703                    BEQ     IF03
E5B6  7EE254                  JMP     MSLINE
E5B9  7EE23A          IF03    JMP     REM
                      ******************************
                      ******************************
E5BC  BDE48B          GOTO    JSR     EXPR
E5BF  8DB8                    BSR     TSTEOL
E5C1  BDE40A                  JSR     FLINE
E5C4  250F                    BCS     GOSB04
E5C6  7EE250                  JMP     NXTLIN
                      ******************************
                      ******************************
E5C9  BDE48B          GOSUB   JSR     EXPR
E5CC  8DAB                    BSR     TSTEOL
E5CE  9F0A                    STX     CURSOR
E5D0  BDE40A                  JSR     FLINE
E5D3  2403                    BCC     GOSB03
E5D5  7EE1AE          GOSB04  JMP     ERRORR
E5D8  BDE3A8          GOSB03  JSR     TSTSTK
E5DB  2403                    BCC     GOSB05
E5DD  7EE165                  JMP     ERRORF
E5E0  DC0A            GOSB05  LDD     CURSOR
E5E2  3406                    PSHS    D
E5E4  DC0E                    LDD     LINENB
E5E6  3406                    PSHS    D
E5E8  BDE250                  JSR     NXTLIN
E5EB  3506                    PULS    D
E5ED  DD0E                    STD     LINENB
E5EF  3510                    PULS    X
E5F1  7EE243                  JMP     ENDS02
                      ******************************
                      ******************************
E579                  RETURN  EQU     TSTEOL
                      ******************************
                      ******************************
E5F4  BDE2A2          PRINT   JSR     SKIPSP
E5F7  812C            PR01    CMPA    #',
E5F9  2736                    BEQ     PR05
E5FB  813B                    CMPA    #';
E5FD  273D                    BEQ     PR07
E5FF  8104                    CMPA    #EOL
E601  2725                    BEQ     PR04
E603  8122                    CMPA    #'"
E605  2606                    BNE     PR02
E607  3001                    LEAX    1,X
E609  8D42                    BSR     PRNTQS
E60B  2009                    BRA     PR03
E60D  BDE48B          PR02    JSR     EXPR
E610  3410                    PSHS    X
E612  8D47                    BSR     PRNTN
E614  3510                    PULS    X
E616  BDE2A2          PR03    JSR     SKIPSP
E619  812C                    CMPA    #',
E61B  2714                    BEQ     PR05
E61D  813B                    CMPA    #';
E61F  271B                    BEQ     PR07
E621  8104                    CMPA    #EOL
E623  2703                    BEQ     PR04
E625  7EE19A                  JMP     PRTERRORS
                      *
E628  3410            PR04    PSHS    X
E62A  BDE15A                  JSR     CRLF
E62D  3510                    PULS    X
E62F  2014                    BRA     PR08
E631  C607            PR05    LDB     #$7
E633  8620            PR06    LDA     #SPACE
E635  BDE897                  JSR     PUTCHR
E638  D514                    BITB    ZONE
E63A  26F7                    BNE     PR06
E63C  3001            PR07    LEAX    1,X
E63E  BDE2A2                  JSR     SKIPSP
E641  8104                    CMPA    #EOL
E643  26B2                    BNE     PR01
E645  3001            PR08    LEAX    1,X
E647  7EE243                  JMP     ENDS02
                      *
                      *
E64A  BDE897          PRQ01   JSR     PUTCHR
E64D  A680            PRNTQS  LDA     ,X+
E64F  8104                    CMPA    #EOL
E651  2603                    BNE     PRQ03
E653  7EE19A                  JMP     PRTERRORS
                      *
E656  8122            PRQ03   CMPA    #'"
E658  26F0                    BNE     PRQ01
E65A  39                      RTS
                      *
E65B  4D              PRNTN   TSTA
E65C  2A0D                    BPL     PRN03
E65E  40                      NEGA
E65F  50                      NEGB
E660  8200                    SBCA    #0
E662  3402                    PSHS    A
E664  862D                    LDA     #'-
E666  BDE897                  JSR     PUTCHR
E669  3502                    PULS    A
E66B  8EE69A          PRN03   LDX     #PRNPT-2
E66E  3002            PRN05   LEAX    2,X
E670  10A384                  CMPD    0,X
E673  2405                    BCC     PRN07
E675  8CE6A4                  CMPX    #PRNPTO
E678  26F4                    BNE     PRN05
E67A  0F12            PRN07   CLR     CHAR
E67C  10A384          PRN09   CMPD    0,X
E67F  2506                    BCS     PRN11
E681  A384                    SUBD    0,X
E683  0C12                    INC     CHAR
E685  20F5                    BRA     PRN09
E687  3402            PRN11   PSHS    A
E689  8630                    LDA     #'0
E68B  9B12                    ADDA    CHAR
E68D  BDE897                  JSR     PUTCHR
E690  3502                    PULS    A
E692  8CE6A4                  CMPX    #PRNPTO
E695  2704                    BEQ     PRN13
E697  3002                    LEAX    2,X
E699  20DF                    BRA     PRN07
E69B  39              PRN13   RTS
E69C  2710            PRNPT   FDB     10000
E69E  03E8                    FDB     1000
E6A0  0064                    FDB     100
E6A2  000A                    FDB     10
E6A4  0001            PRNPTO  FDB     1
                      *
E6A6  8EE69E          PRNT4   LDX     #PRNPT+2
E6A9  20CF                    BRA     PRN07
                      ******************************
                      ******************************
E6AB  BDE2D2          INPUT   JSR     TSTVAR
E6AE  253C                    BCS     IN11
E6B0  3406                    PSHS    D
E6B2  9F0A                    STX     CURSOR
E6B4  863F            IN03    LDA     #'?
E6B6  BDE897                  JSR     PUTCHR
E6B9  BDE1E4                  JSR     GETLIN
E6BC  BDE2A2          IN05    JSR     SKIPSP
E6BF  8104                    CMPA    #EOL
E6C1  27F1                    BEQ     IN03
E6C3  BDE31D                  JSR     TSTSNB
E6C6  240B                    BCC     IN07
E6C8  8EE700                  LDX     #RMESS
E6CB  BDE153                  JSR     PUTSTR
E6CE  BDE15A                  JSR     CRLF
E6D1  20E1                    BRA     IN03
E6D3  9F10            IN07    STX     SCRTCH
E6D5  3510                    PULS    X
E6D7  ED84                    STD     0,X
E6D9  9E0A                    LDX     CURSOR
E6DB  BDE2A2                  JSR     SKIPSP
E6DE  812C                    CMPA    #',
E6E0  2703                    BEQ     IN09
E6E2  7EE240                  JMP     ENDSMT
E6E5  3001            IN09    LEAX    1,X
E6E7  BDE2D2                  JSR     TSTVAR
E6EA  2403                    BCC     IN13
E6EC  7EE1A5          IN11    JMP     ERRORS
                      *
E6EF  3406            IN13    PSHS    D
E6F1  3410                    PSHS    X
E6F3  9E10                    LDX     SCRTCH
E6F5  BDE2A2                  JSR     SKIPSP
E6F8  812C                    CMPA    #',
E6FA  26C0                    BNE     IN05
E6FC  3001                    LEAX    1,X
E6FE  20BC                    BRA     IN05
E700  52452D454E544552 RMESS   FCC     "RE-ENTER"
E708  04                      FCB     EOL
                      ******************************
                      ******************************
E709  9E08            RUN     LDX     STKTOP
E70B  8634                    LDA     #52
E70D  6F80            RUN01   CLR     ,X+
E70F  4A                      DECA
E710  26FB                    BNE     RUN01
E712  9E02                    LDX     USRBAS
E714  7EE249                  JMP     REM05
                      ******************************
                      ******************************
E717  BDE331          LIST    JSR     TSTNBR
E71A  2408                    BCC     LIST03
E71C  4F                      CLRA
E71D  5F                      CLRB
E71E  DD0A                    STD     CURSOR
E720  867F                    LDA     #$7F
E722  2017                    BRA     LIST07
E724  DD0A            LIST03  STD     CURSOR
E726  BDE2A2                  JSR     SKIPSP
E729  812C                    CMPA    #',
E72B  2704                    BEQ     LIST05
E72D  960A                    LDA     CURSOR
E72F  200A                    BRA     LIST07
E731  3001            LIST05  LEAX    1,X
E733  BDE331                  JSR     TSTNBR
E736  2403                    BCC     LIST07
E738  7EE1A5                  JMP     ERRORS
                      *
E73B  BDE579          LIST07  JSR     TSTEOL
E73E  3406                    PSHS    D
E740  DC0A                    LDD     CURSOR
E742  9F0A                    STX     CURSOR
E744  BDE40A                  JSR     FLINE
E747  9C04            LIST09  CMPX    USRTOP
E749  2728                    BEQ     LIST10
E74B  3506                    PULS    D
E74D  10A384                  CMPD    0,X
E750  2528                    BCS     LIST11
E752  3406                    PSHS    D
E754  EC81                    LDD     ,X++
E756  3410                    PSHS    X
E758  17FF4B                  LBSR    PRNT4
E75B  3510                    PULS    X
E75D  8620                    LDA     #SPACE
E75F  170135                  LBSR    PUTCHR
E762  17F9EE                  LBSR    PUTSTR
E765  3001                    LEAX    1,X
E767  3410                    PSHS    X
E769  17F9EE                  LBSR    CRLF
E76C  3510                    PULS    X
E76E  170101                  LBSR    TestBreak
E771  20D4                    BRA     LIST09
E773  3262            LIST10  LEAS    2,S
E775  8603                    LDA     #ETX
E777  17011D                  LBSR    PUTCHR
E77A  9E0A            LIST11  LDX     CURSOR
E77C  7EE243                  JMP     ENDS02
                      ******************************
                      ******************************
E77F                  MONITOR 
E77F  8EDFF4                          LDX     #VECTAB+_ECHO   ; Address to a WORD
E782  3F                              SWI
E783  05                              FCB     OUT4HS          ; Print the WORD value
                      
E784  8632                            LDA     #_ECHO          ; Change the ECHO flag
E786  8EFFFF                          LDX     #$FFFF          ; No local echo on input
E789  3F                              SWI                     ; call assist09
E78A  09                              FCB     VCTRSW          ; Change vectro value
                      
E78B  8EDFF4                          LDX     #VECTAB+_ECHO   ; Address to a WORD
E78E  3F                              SWI
E78F  05                              FCB     OUT4HS          ; Print the WORD value
                      
E790  3F                              SWI
E791  06                              FCB     PCRLF           ; new line
                      
                      ;-              SWI
                      ;-              FCB     MONITR
E792  6E9FFFFE                        JMP     [$FFFE]         ; Restart
E796  16F87F                          LBRA    WARMS
                      ******************************
                      ******************************
E799  4C4554          VERBT           FCC     "LET"
E79C  04                              FCB     EOL
E79D  E58A                            FDB     LET
                      
E79F  4946                            FCC     "IF"
E7A1  04                              FCB     EOL
E7A2  E5B0                            FDB     IF
                      
E7A4  474F544F                        FCC     "GOTO"
E7A8  04                              FCB     EOL
E7A9  E5BC                            FDB     GOTO
                      
E7AB  474F535542                      FCC     "GOSUB"
E7B0  04                              FCB     EOL
E7B1  E5C9                            FDB     GOSUB
                      
E7B3  52455455524E                    FCC     "RETURN"
E7B9  04                              FCB     EOL
E7BA  E579                            FDB     RETURN
                      
E7BC  504F4B45                        FCC     "POKE"
E7C0  04                              FCB     EOL
E7C1  E3C3                            FDB     POKE
                      
E7C3  5052494E54                      FCC     "PRINT"
E7C8  04                              FCB     EOL
E7C9  E5F4                            FDB     PRINT
                      
E7CB  494E505554                      FCC     "INPUT"
E7D0  04                              FCB     EOL
E7D1  E6AB                            FDB     INPUT
                      
E7D3  52454D                          FCC     "REM"
E7D6  04                              FCB     EOL
E7D7  E23A                            FDB     REM
                      
E7D9  53544F50                        FCC     "STOP"
E7DD  04                              FCB     EOL
E7DE  E1BE                            FDB     END
                      
E7E0  454E44                          FCC     "END"
E7E3  04                              FCB     EOL
E7E4  E1BE                            FDB     END
                      
E7E6  52554E                          FCC     "RUN"
E7E9  04                              FCB     EOL
E7EA  E709                            FDB     RUN
                      
E7EC  4C495354                        FCC     "LIST"
E7F0  04                              FCB     EOL
E7F1  E717                            FDB     LIST
                      
E7F3  4E4557                          FCC     "NEW"
E7F6  04                              FCB     EOL
E7F7  E02D                            FDB     CLEAR
                      
E7F9  4D4F4E49544F52                  FCC     "MONITOR"
E800  04                              FCB     EOL
E801  E77F                            FDB     MONITOR
                      
E803  3F                              FCC     "?"
E804  04                              FCB     EOL
E805  E5F4                            FDB     PRINT
                      
E807  6C6574          VERBTlowcase    FCC     "let"
E80A  04                              FCB     EOL
E80B  E58A                            FDB     LET
                      
E80D  6966                            FCC     "if"
E80F  04                              FCB     EOL
E810  E5B0                            FDB     IF
                      
E812  676F746F                        FCC     "goto"
E816  04                              FCB     EOL
E817  E5BC                            FDB     GOTO
                      
E819  676F737562                      FCC     "gosub"
E81E  04                              FCB     EOL
E81F  E5C9                            FDB     GOSUB
                      
E821  72657475726E                    FCC     "return"
E827  04                              FCB     EOL
E828  E579                            FDB     RETURN
                      
E82A  706F6B65                        FCC     "poke"
E82E  04                              FCB     EOL
E82F  E3C3                            FDB     POKE
                      
E831  7072696E74                      FCC     "print"
E836  04                              FCB     EOL
E837  E5F4                            FDB     PRINT
                      
E839  696E707574                      FCC     "input"
E83E  04                              FCB     EOL
E83F  E6AB                            FDB     INPUT
                      
E841  72656D                          FCC     "rem"
E844  04                              FCB     EOL
E845  E23A                            FDB     REM
                      
E847  73746F70                        FCC     "stop"
E84B  04                              FCB     EOL
E84C  E1BE                            FDB     END
                      
E84E  656E64                          FCC     "end"
E851  04                              FCB     EOL
E852  E1BE                            FDB     END
                      
E854  72756E                          FCC     "run"
E857  04                              FCB     EOL
E858  E709                            FDB     RUN
                      
E85A  6C697374                        FCC     "list"
E85E  04                              FCB     EOL
E85F  E717                            FDB     LIST
                      
E861  6E6577                          FCC     "new"
E864  04                              FCB     EOL
E865  E02D                            FDB     CLEAR
                      
E867  6D6F6E69746F72                  FCC     "monitor"
E86E  04                              FCB     EOL
E86F  E77F                            FDB     MONITOR
                      
E871  04                              FCB     EOL
                      ******************************
                      
                      *-----------------------------
E872  3403            TestBreak       PSHS    A,CC
                                      * CIDTA - RETURN CONSOLE INPUT CHARACTER
                                      * OUTPUT: C=0 IF NO DATA READY, C=1 A=CHARACTER
                                      * U VOLATILE
E874  AD9DF760                        JSR     [VECTAB+_CIDTA,PCR]     ; read CONSOLE input
E878  2404                            BCC     NoBreak                 ; Did not get a char
E87A  8103                            CMPA    #ETX                    ; <ctrl>-C
E87C  2703                            BEQ     GotBreak                ; Got it
E87E  3503            NoBreak         PULS    A,CC                    ; Restore A & CC
E880  39                              RTS
                      
E881  3503            GotBreak        PULS    A,CC                    ; Clear stack
E883  16F930                          LBRA    BREAKERR                ; Got BREAK
                      
                      *-----------------------------
E886                  GETCHR
E886  3440                            PSHS    U
E888                  tstchr
                                      * CIDTA - RETURN CONSOLE INPUT CHARACTER
                                      * OUTPUT: C=0 IF NO DATA READY, C=1 A=CHARACTER
                                      * U VOLATILE
E888  AD9DF74C                        JSR     [VECTAB+_CIDTA,PCR]     ; read CONSOLE input
E88C  24FA                            BCC     tstchr                  ; Did not get a char
E88E  8103                            CMPA    #ETX                    ; <ctrl>-C
E890  1027F922                        LBEQ    BREAKERR                ; Got BREAK
E894  3540                            PULS    U
E896  39                              RTS
                      
                      *-----------------------------
E897                  PUTCHR
E897  AD9DF743                        JSR     [VECTAB+_CODTA,PCR]     ; write CONSOLE output
E89B                  INTEEE          EQU     *
E89B  39                              RTS
                      *-----------------------------
                      
                      ******************************
                      *TestBreak      bsr     BRKEEE
                      *       beq     GETC05
                      *GETCHR bsr     INEEE
                      *       CMPA    #ETX
                      *       BNE     GETC05
                      *       JMP     BREAK
                      *GETC05 RTS
                      *PUTCHR INC     ZONE
                      *       JMP     OUTEEE
                      ******************************
                      
                      ******************************
                      *INEEE  BSR     BRKEEE
                      *       BEQ     INEEE
                      *       LDA     RECEV
                      *       ANDA    #$7F
                      *       RTS
                      *OUTEEE PSHS    A
                      *OUT01  LDA     TRCS
                      *       BITA    #TDRE
                      *       BEQ     OUT01
                      *       PULS    A
                      *       STA     TRANS
                      *       RTS
                      *BRKEEE PSHS    A
                      *BRK03  LDA     TRCS
                      *       BITA    #ORFE
                      *       BEQ     BRK05
                      *       LDA     RECEV
                      *       BRA     BRK03
                      *BRK05  BITA    #RDRF
                      *       PULS    A
                      *       RTS
                      **
                      *       LDA     #CNTL1
                      *       STA     RMCR
                      *       LDA     #CNTL2
                      *       STA     TRCS
                      *INTEEE  EQU     *
                      *       RTS
                      *
                      ******************************
                      
                      *               CODEend
                      *---------------============--------------------
                      
                      *---------------------------------------------------------------------
                      *               MONITOR extended ROM code
                      *---------------------------------------------------------------------
E89C                                  INCLUDE         /extend_a09.asm/
                      ********************************************************************************
                      * 
                      * This is a extension to Assist09 ROM
                      *
                      * Made for CPU X-3, by Roger Landen 2025-12-06
                      *
                      ********************************************************************************
                      
F000                                  ORG     EPROM_3
F000                                  Anrop   /INITEXTA09/
F000                  \1              *
                                      EXPORT  \1
F000  20FE                            BRA     *                       ; Mark it as ASSIST09 rom extension
                      ; Assist09 have not done this yet
F002  AD9DEFD0                        JSR     [VECTAB+_CION,PCR]      ; READY CONSOLE INPUT
F006  AD9DEFD2                        JSR     [VECTAB+_COON,PCR]      ; READY CONSOLE OUTPUT
                      
F00A  308DEFF2                        LEAX    HELLO,PCR               ; Get address to EPROM HELLO
F00E  3F                              SWI                             ; a09
F00F  03                              FCB     PDATA                   ; PRINT CR,LF STRING
F010  308D00BB                        LEAX    EXTEND09,PCR            ; Extended SIGNON EYE-CATCHER
F014  3F                              SWI                             ; a09
F015  02                              FCB     PDATA1                  ; PRINT STRING
                      
F016  8D23                            BSR     CHK309                  ; Check if 6809 | 6309
F018  2706                            BEQ     lbl6809
F01A  308D00D2                        LEAX    HD6309,PCR              ; cpu 63C09
F01E  2004                            BRA     lblcpuprt
F020                  lbl6809
F020  308D00C5                        LEAX    MC6809,PCR              ; cpu 6809
F024                  lblcpuprt
F024  3F                              SWI                             ; a09
F025  02                              FCB     PDATA1                  ; PRINT STRING
                      
F026  308D00CE                        LEAX    CMDTBLext,PCR           ; Extend CMD Table, with lower caps
F02A  8602                            LDA     #_CMDL1                 ; CMDTL #2
F02C  3F                              SWI
F02D  09                              FCB     VCTRSW
                      
                      ; We have to replace Assist09 Reset routin
F02E  328DEDCE                        LEAS    STACK,PCR               ; SETUP INITIAL STACK, Restore/Clear the stack
                      
F032                                  Anrop   /RESET3/
F032                  \1              *
                                      EXPORT  \1
F032  4F                              CLRA                            ;
F033  1F8B                            TFR     A,DP                    ; Default to PAGE ZERO
F035  86FF                            LDA     #$FF                    ; A#0 OMIT CONSOLE INIT AND STARTUP MESSAGE
F037  3F                              SWI                             ; Perform MONITOR fireup
F038  08                              FCB     MONITR                  ; To enter COMMAND processing
F039  20F7                            BRA     RESET3                  ; reenter MONITOR if 'CONTINUE'
                      
                      
                      * - - - - - - - - - - - - - - - - - - - - - - - -
                      * Determine whether processor is 6309 or 6809
                      * Returns Z clear if 6309, set if 6809
                      * - - - - - - - - - - - - - - - - - - - - - - - -
F03B  3406            CHK309          PSHS    D                       ; Save Reg-D
F03D  1043                            FDB     $1043                   ; 6309 COMD instruction (COMA on 6809)
F03F  E161                            CMPB    1,S                     ; not equal if 6309
F041  3586                            PULS    D,PC                    ; exit, restoring D
                      
                      * - - - - - - - - - - - - - - - - - - - - - - - -
                      ;-Delay
                      ;-              PSHS    A,B
                      ;-              LDD     #$2000
                      ;-Loop1         SUBD    #1
                      ;-              BNE     Loop1
                      ;-              PULS    A,B,PC
                      
                      
                      ********************************************************************************
                      * 
                      * Extende ROM <CMD>
                      *
                      ********************************************************************************
                      
                      ********************************************************************************
                      *               BASIC INIT in ASSIST09
                      *---------------======================----------
                      
F043                                  Anrop   /BASICINIT/
F043                  \1              *
                                      EXPORT  \1
                      
                      * - - - - - - - - - - - - - - - - - - - - - - - -
                      *       --------------------------------
                      *               Simple Memory test
                      *               To find memory Size/End
                      *       --------------------------------
F043  8EF08E                          LDX     #MemTst                 ; Get Memory Test text
F046  17F10A                          LBSR    PUTSTR                  ; Console write str [direct io]
                      
F049  108E0000                        LDY     #RAM                    ; First Memadr to test
F04D                  TestMem
F04D  865A                            LDA     #$5A                    ; tst pattern 1
F04F  A7A4                            STA     ,Y                      ; Store it
F051  A1A4                            CMPA    ,Y
F053  2627                            BNE     NoMem                   ; Not the same 
                      
F055  86A5                            LDA     #$A5                    ; tst pattern 2
F057  A7A4                            STA     ,Y                      ; Store it
F059  A1A4                            CMPA    ,Y
F05B  261F                            BNE     NoMem                   ; Not the same 
                      
F05D  8658                            LDA     #'X                     ; Save some prt char
F05F  A7A0                            STA     ,Y+
                      
F061  1F20                            TFR     Y,D                     ; Get Tested Address 
F063  C53F                            BITB    #$3F
F065  260A                            BNE     NoPrt
                      
F067  860D                            LDA     #CR
F069  BDE897                          JSR     PUTCHR                  ; Jump back on line
F06C  1F20                            TFR     Y,D
F06E  170052                          LBSR    WriteHexWord            ; Write the Testaddress
                      
                      ;-              LDB     PIA02_DataA             ; get privous Status....
                      ;-              INCB                            ; toggel status bit...
                      ;-              STB     PIA02_DataA             ; Status light
                      
F071  109F00          NoPrt           STY     RAMSIZE                 ; Save current good size
F074  1083BFFF                        CMPD    #MAXRAM                 ; Max memory address
F078  2702                            BEQ     NoMem                   ; At end of memory
F07A  20D1                            BRA     TestMem                 ; Test next address
F07C                  NoMem                                           ; No More MEM
F07C  8EF09E                          LDX     #MemEnd                 ; Print that we ended the mem test
F07F  17F0D1                          LBSR    PUTSTR                  ; Console write str [direct io]
                      
                      
                      ;-              LDX     #VECTAB+_ECHO   ; Address to a WORD
                      ;-              SWI
                      ;-              FCB     OUT4HS          ; Print the WORD value
F082  8632                            LDA     #_ECHO          ; Change the ECHO flag
F084  8E0000                          LDX     #$0000          ; No local echo on input
F087  3F                              SWI                     ; call assist09
F088  09                              FCB     VCTRSW          ; Change vectro value
                      ;-              LDX     #VECTAB+_ECHO   ; Address to a WORD
                      ;-              SWI
                      ;-              FCB     OUT4HS          ; Print the WORD value
F089  3F                              SWI
F08A  06                              FCB     PCRLF           ; new line
                      
                      ;-              LDD     #MAXRAM         ; Set the RAM end address
                      ;-              STD     RAMSIZE         
F08B  16EF88                          LBRA    BASIC           ; Jump to BASIC now
                      
F08E  0A0D30303030204D656D6F727904 MemTst          FCB     LF,CR,"0000 Memory",EOT
F09C  0D04            MemBck          FCB     CR,EOT
F09E  0D0A4F4B2104    MemEnd          FCB     CR,LF,"OK!",EOT
                      
                      ***********************************************************************
                      *
                      *               WriteNibel
                      *               ==========
                      *
                      *  Write out a nibel in Hex
                      *
                      *  Input:
                      *       A-acc the nibel
                      *
                      *  Destroy:
                      ***********************************************************************
                      
F0A4                                  Anrop   /WriteNibel/
F0A4                  \1              *
                                      EXPORT  \1
F0A4  3402                            PSHS    A
F0A6  840F                            ANDA    #$0F            ; Mask out the nibel
F0A8  8B90                            ADDA    #$90            ; Convert it to ascii char
F0AA  19                              DAA
F0AB  8940                            ADCA    #$40
F0AD  19                              DAA
F0AE  17F7E6                          LBSR    PUTCHR          ; Write it on the console
F0B1  3582                            PULS    A,PC
                      
                      ***********************************************************************
                      *
                      *               WriteHexByte
                      *               ============
                      *
                      *  Write out a byte in Hex
                      *
                      *  Input:
                      *       A-acc the byte
                      *
                      *  Destroy:
                      ***********************************************************************
                      
F0B3                                  Anrop   /WriteHexByte/
F0B3                  \1              *
                                      EXPORT  \1
F0B3  3403                            PSHS    CC,A
F0B5  3402                            PSHS    A
F0B7  44                              LSRA                    ; Shift
F0B8  44                              LSRA                    ;   down
F0B9  44                              LSRA                    ;     high
F0BA  44                              LSRA                    ;       nibel
F0BB  8DE7                            BSR     WriteNibel      ; Write High Nibel
F0BD  3502                            PULS    A
F0BF  8DE3                            BSR     WriteNibel      ; Write low Nibel
F0C1  3583                            PULS    CC,A,PC
                      
                      ***********************************************************************
                      *
                      *               WriteHexWord
                      *               ============
                      *
                      *  Write out a Word in Hex
                      *
                      *  Input:
                      *       D-acc the word
                      *
                      *  Destroy:
                      ***********************************************************************
                      
F0C3                                  Anrop   /WriteHexWord/
F0C3                  \1              *
                                      EXPORT  \1
F0C3  3407                            PSHS    CC,A,B
F0C5  17FFEB                          LBSR    WriteHexByte            ; Write High Byte
F0C8  1F98                            TFR     B,A
F0CA  17FFE6                          LBSR    WriteHexByte            ; Write Low Byte
F0CD  3587                            PULS    CC,A,B,PC
                      
                      *===============================================================================
                      *               Data area
                      *===============================================================================
F0CF  2C205769746820524F4D20457874656E73696F6E206F6E20 EXTEND09        FCC     /, With ROM Extension on /
F0E7  0400                            FCB     EOT,NUL         ; SIGNON EYE-CATCHER
F0E9  4D433638303904  MC6809          FCB     "MC6809",EOT
F0F0  4844363343303904 HD6309          FCB     "HD63C09",EOT
                      
                      * THIS IS a fix of DEFAULT COMMAND LIST ENTRY. Added lower caps fix
                      
F0F8                  CMDTBLext       EQU     *               ; MONITOR extended COMMAND TABLE
F0F8  04                              FCB     4
F0F9  62                              FCC     /b/             ; 'BREAKPOINT' COMMAND
F0FA  0DF1                            FDB     CBKPT-*
F0FC  04                              FCB     4
F0FD  42                              FCC     /B/             ; 'BREAKPOINT' COMMAND
F0FE  0DED                            FDB     CBKPT-*
F100  04                              FCB     4
F101  63                              FCC     /c/             ; 'CALL' COMMAND
F102  0CB7                            FDB     CCALL-*
F104  04                              FCB     4
F105  43                              FCC     /C/             ; 'CALL' COMMAND
F106  0CB3                            FDB     CCALL-*
F108  04                              FCB     4
F109  64                              FCC     /d/             ; 'DISPLAY' COMMAND
F10A  0D39                            FDB     CDISP-*
F10C  04                              FCB     4
F10D  44                              FCC     /D/             ; 'DISPLAY' COMMAND
F10E  0D35                            FDB     CDISP-*
F110  04                              FCB     4
F111  65                              FCC     /e/             ; 'ENCODE' COMMAND
F112  0E37                            FDB     CENCDE-*
F114  04                              FCB     4
F115  45                              FCC     /E/             ; 'ENCODE' COMMAND
F116  0E33                            FDB     CENCDE-*
F118  04                              FCB     4
F119  67                              FCC     /g/             ; 'GO' COMMAND
F11A  0C66                            FDB     CGO-*
F11C  04                              FCB     4
F11D  47                              FCC     /G/             ; 'GO' COMMAND
F11E  0C62                            FDB     CGO-*
F120  04                              FCB     4
F121  6C                              FCC     /l/             ; 'LOAD' COMMAND
F122  0D6D                            FDB     CLOAD-*
F124  04                              FCB     4
F125  4C                              FCC     /L/             ; 'LOAD' COMMAND
F126  0D69                            FDB     CLOAD-*
F128  04                              FCB     4
F129  6D                              FCC     /m/             ; 'MEMORY' COMMAND
F12A  0C99                            FDB     CMEM-*
F12C  04                              FCB     4
F12D  4D                              FCC     /M/             ; 'MEMORY' COMMAND
F12E  0C95                            FDB     CMEM-*
F130  04                              FCB     4
F131  6E                              FCC     /n/             ; 'NULLS' COMMAND
F132  0D85                            FDB     CNULLS-*
F134  04                              FCB     4
F135  4E                              FCC     /N/             ; 'NULLS' COMMAND
F136  0D81                            FDB     CNULLS-*
F138  04                              FCB     4
F139  6F                              FCC     /o/             ; 'OFFSET' COMMAND
F13A  0D8E                            FDB     COFFS-*
F13C  04                              FCB     4
F13D  4F                              FCC     /O/             ; 'OFFSET' COMMAND
F13E  0D8A                            FDB     COFFS-*
F140  04                              FCB     4
F141  70                              FCC     /p/             ; 'PUNCH' COMMAND
F142  0D2F                            FDB     CPUNCH-*
F144  04                              FCB     4
F145  50                              FCC     /P/             ; 'PUNCH' COMMAND
F146  0D2B                            FDB     CPUNCH-*
F148  04                              FCB     4
F149  72                              FCC     /r/             ; 'REGISTERS' COMMAND
F14A  0B00                            FDB     CREG-*
F14C  04                              FCB     4
F14D  52                              FCC     /R/             ; 'REGISTERS' COMMAND
F14E  0AFC                            FDB     CREG-*
F150  04                              FCB     4
F151  73                              FCC     /s/             ; 'STLEVEL' COMMAND
F152  0D6A                            FDB     CSTLEV-*
F154  04                              FCB     4
F155  53                              FCC     /S/             ; 'STLEVEL' COMMAND
F156  0D66                            FDB     CSTLEV-*
F158  04                              FCB     4
F159  74                              FCC     /t/             ; 'TRACE' COMMAND
F15A  0D4A                            FDB     CTRACE-*
F15C  04                              FCB     4
F15D  54                              FCC     /T/             ; 'TRACE' COMMAND
F15E  0D46                            FDB     CTRACE-*
F160  04                              FCB     4
F161  76                              FCC     /v/             ; 'VERIFY' COMMAND
F162  0D3F                            FDB     CVER-*
F164  04                              FCB     4
F165  56                              FCC     /V/             ; 'VERIFY' COMMAND
F166  0D3B                            FDB     CVER-*
F168  04                              FCB     4
F169  77                              FCC     /w/             ; 'WINDOW' COMMAND
F16A  0CD4                            FDB     CWINDO-*
F16C  04                              FCB     4
F16D  57                              FCC     /W/             ; 'WINDOW' COMMAND
F16E  0CD0                            FDB     CWINDO-*
F170  08                              FCB     8
F171  6261736963                      FCC     /basic/         ; Init and jump to Tiny Basic
F176  FECD                            FDB     BASICINIT-*
F178  08                              FCB     8
F179  4241534943                      FCC     /BASIC/         ; Init and jump to Tiny Basic
F17E  FEC5                            FDB     BASICINIT-*
F180  FF                              FCB     -1              ; END, CONTINUE WITH THE SECOND
                      
                      *---------------------------------------------------------------------
                      *               MONITOR code
                      *---------------------------------------------------------------------
F181                                  INCLUDE         /assist09.asm/
                      *************************************
                      * COPYRIGHT (C) MOTOROLA, INC. 1979 *
                      *************************************
                      * Adjusted for CPU X-3, by Roger Landen 2025-09-17
                      
                      *************************************
                      * THIS IS THE BASE ASSIST09 ROM.
                      * IT MAY RUN WITH OR WITHOUT THE
                      * EXTENSION ROM WHICH
                      * WHEN PRESENT WILL BE AUTOMATICALLY
                      * INCORPORATED BY THE BLDVTR
                      * SUBROUTINE.
                      *************************************
                      
                      *********************************************
                      * GLOBAL MODULE EQUATES
                      ********************************************
F800                  ROMBEG          EQU     EPROM_4         ; ROM START ASSEMBLY ADDRESS
E700                  RAMOFS          EQU     -$1900          ; ROM OFFSET TO RAM WORK PAGE
0800                  ROMSIZ          EQU     2048            ; ROM SIZE
F000                  ROM2OF          EQU     ROMBEG-ROMSIZ   ; START OF EXTENSION ROM
D006                  ACIA            EQU     ACIA01_Status   ; DEFAULT ACIA ADDRESS
D028                  PTM             EQU     TIMER           ; DEFAULT PTM ADDRESS
0000                  DFTCHP          EQU     0               ; DEFAULT CHARACTER PAD COUNT
0005                  DFTNLP          EQU     5               ; DEFAULT NEW LINE PAD COUNT
003E                  PROMPT          EQU     '>              ; PROMPT CHARACTER
0008                  NUMBKP          EQU     8               ; NUMBER OF BREAKPOINTS
                      *********************************************
                      
                      *********************************************
                      * MISCELANEOUS EQUATES
                      *********************************************
                      ;-EOT           EQU     $04             ; END OF TRANSMISSION
                      ;-BELL          EQU     $07             ; BELL CHARACTER
                      ;-LF            EQU     $0A             ; LINE FEED
                      ;-CR            EQU     $0D             ; CARRIAGE RETURN
                      ;-DLE           EQU     $10             ; DATA LINK ESCAPE
                      ;-CAN           EQU     $18             ; CANCEL (CTL-X)
                      
                      * PTM ACCESS DEFINITIONS
D029                  PTMSTA          EQU     PTM+1           ; READ STATUS REGISTER
D028                  PTMC13          EQU     PTM             ; CONTROL REGISTERS 1 AND 3
D029                  PTMC2           EQU     PTM+1           ; CONTROL REGISTER 2
D02A                  PTMTM1          EQU     PTM+2           ; LATCH 1
D02C                  PTMTM2          EQU     PTM+4           ; LATCH 2
D02E                  PTMTM3          EQU     PTM+6           ; LATCH 3
008C                  SKIP2           EQU     $8C             ; "CMPX #" OPCODE - SKIPS TWO BYTES
                      
                      *******************************************
                      * ASSIST09 MONITOR SWI FUNCTIONS
                      * THE FOLLOWING EQUATES DEFINE FUNCTIONS PROVIDED
                      * BY THE ASSIST09 MONITOR VIA THE SWI INSTRUCTION.
                      ******************************************
0000                  INCHNP          EQU     0               ; INPUT CHAR IN A REG - NO PARITY
0001                  OUTCH           EQU     1               ; OUTPUT CHAR FROM A REG
0002                  PDATA1          EQU     2               ; OUTPUT STRING
0003                  PDATA           EQU     3               ; OUTPUT CR/LF THEN STRING
0004                  OUT2HS          EQU     4               ; OUTPUT TWO HEX AND SPACE
0005                  OUT4HS          EQU     5               ; OUTPUT FOUR HEX AND SPACE
0006                  PCRLF           EQU     6               ; OUTPUT CR/LF
0007                  PSPACE          EQU     7               ; OUTPUT A SPACE
0008                  MONITR          EQU     8               ; ENTER ASSIST09 MONITOR
0009                  VCTRSW          EQU     9               ; VECTOR EXAMINE/SWITCH
000A                  BRKPT           EQU     10              ; USER PROGRAM BREAKPOINT
000B                  PAUSE           EQU     11              ; TASK PAUSE FUNCTION
000B                  NUMFUN          EQU     11              ; NUMBER OF AVAILABLE FUNCTIONS
                      
                      * NEXT SUB-CODES FOR ACCESSING THE VECTOR TABLE.
                      * THEY ARE EQUIVALENT TO OFFSETS IN THE TABLE.
                      * RELATIVE POSITIONING MUST BE MAINTAINED
                      
0000                  _AVTBL          EQU     0               ; ADDRESS OF VECTOR TABLE
0002                  _CMDL1          EQU     2               ; FIRST COMMAND LIST
0004                  _RSVD           EQU     4               ; RESERVED HARDWARE VECTOR
0006                  _SWI3           EQU     6               ; SWI3 ROUTINE
0008                  _SWI2           EQU     8               ; SWI2 ROUTINE
000A                  _FIRQ           EQU     10              ; FIRQ ROUTINE
000C                  _IRQ            EQU     12              ; IRQ ROUTINE
000E                  _SWI            EQU     14              ; SWI ROUTINE
0010                  _NMI            EQU     16              ; NMI ROUTINE
0012                  _RESET          EQU     18              ; RESET ROUTINE
0014                  _CION           EQU     20              ; CONSOLE ON
0016                  _CIDTA          EQU     22              ; CONSOLE INPUT DATA
0018                  _CIOFF          EQU     24              ; CONSOLE INPUT OFF
001A                  _COON           EQU     26              ; CONSOLE OUTPUT ON
001C                  _CODTA          EQU     28              ; CONSOLE OUTPUT DATA
001E                  _COOFF          EQU     30              ; CONSOLE OUTPUT OFF
0020                  _HSDTA          EQU     32              ; HIGH SPEED PRINTDATA
0022                  _BSON           EQU     34              ; PUNCH/LOAD ON
0024                  _BSDTA          EQU     36              ; PUNCH/LOAD DATA
0026                  _BSOFF          EQU     38              ; PUNCH/LOAD OFF
0028                  _PAUSE          EQU     40              ; TASK PAUSE ROUTINE
002A                  _EXPAN          EQU     42              ; EXPRESSION ANALYZER
002C                  _CMDL2          EQU     44              ; SECOND COMMAND LIST
002E                  _ACIA           EQU     46              ; ACIA ADDRESS
0030                  _PAD            EQU     48              ; CHARACTER PAD AND NEW LINE PAD
0032                  _ECHO           EQU     50              ; ECHO/LOAD AND NULL BKPT FLAG
0034                  _PTM            EQU     52              ; PTM ADDRESS
001B                  NUMVTR          EQU     52/2+1          ; NUMBER OF VECTORS
0034                  HIVTR           EQU     52              ; HIGHEST VECTOR OFFSET
                      
                      ******************************************
                      *               WORK AREA
                      * THIS WORK AREA IS ASSIGNED TO THE PAGE ADDRESSED BY
                      * -$1800,PCR FROM THE BASE ADDRESS OF THE ASSIST09
                      * ROM. THE DIRECT PAGE REGISTER DURING MOST ROUTINE
                      * OPERATIONS WILL POINT TO THIS WORK AREA. THE STACK
                      * INITIALLY STARTS UNDER THE RESERVED WORK AREAS AS
                      * DEFINED HEREIN.
                      ******************************************
DF17                                  RAM
                      *-WORKPG        EQU     ROMBEG+RAMOFS   ; SETUP DIRECT PAGE ADDRESS
DF00                  WORKPG          EQU     SYSRAM          ; SETUP DIRECT PAGE ADDRESS
DF17                                  SETDP   WORKPG>>8       ; NOTIFY ASSEMBLER
E000                                  ORG     WORKPG+256      ; READY PAGE DEFINITIONS
                      
                      * THE FOLLOWING THRU BKPTOP MUST RESIDE IN THIS ORDER
                      * FOR PROPER INITIALIZATION
DFFC                                  ORG     *-4
DFFC                  PAUSER          EQU     *               ; PAUSE ROUTINE
DFFB                                  ORG     *-1
DFFB                  SWIBFL          EQU     *               ; BYPASS SWI AS BREAKPOINT FLAG
DFFA                                  ORG     *-1
DFFA                  BKPTCT          EQU     *               ; BREAKPOINT COUNT
DFF8                                  ORG     *-2             ; SLEVEL EQU
DFF8                  SLEVEL          EQU     *               ; STACK TRACE LEVEL
DFC2                                  ORG     -NUMVTR*2+*
DFC2                  VECTAB          EQU     *               ; VECTOR TABLE
DFB2                                  ORG     -2*NUMBKP+*
DFB2                  BKPTBL          EQU     *               ; BREAKPOINT TABLE
DFA2                                  ORG     -2*NUMBKP+*
DFA2                  BKPTOP          EQU     *               ; BREAKPOINT OPCODE TABLE
DFA0                                  ORG     *-2
DFA0                  WINDOW          EQU     *               ; WINDOW
DF9E                                  ORG     *-2
DF9E                  ADDR            EQU     *               ; ADDRESS POINTER VALUE
DF9D                                  ORG     *-1
DF9D                  BASEPG          EQU     *               ; BASE PAGE VALUE
DF9B                                  ORG     *-2
DF9B                  NUMBER          EQU     *               ; BINARY BUILD AREA
DF99                                  ORG     *-2
DF99                  LASTOP          EQU     *               ; LAST OPCODE TRACED
DF97                                  ORG     *-2
DF97                  RSTACK          EQU     *               ; RESET STACK POINTER
DF95                                  ORG     *-2
DF95                  PSTACK          EQU     *               ; COMMAND RECOVERY STACK
DF93                                  ORG     *-2
DF93                  PCNTER          EQU     *               ; LAST PROGRAM COUNTER
DF91                                  ORG     *-2
DF91                  TRACEC          EQU     *               ; TRACE COUNT
DF90                                  ORG     *-1
DF90                  SWICNT          EQU     *               ; TRACE "SWI" NEST LEVEL COUNT
DF8F                                  ORG     *-1             ; (MISFLG MUST FOLLOW SWICNT)
DF8F                  MISFLG          EQU     *               ; LOAD CMD/THRU BREAKPOINT FLAG
DF8E                                  ORG     *-1
DF8E                  DELIM           EQU     *               ; EXPRESSION DELIMITER/WORK BYTE
DF66                                  ORG     *-40
DF66                  ROM2WK          EQU     *               ; EXTENSION ROM RESERVED AREA
DF51                                  ORG     *-21
DE00                  TSTACK          EQU     WORKPG-$100     ; TEMPORARY STACK HOLD
DE00                  STACK           EQU     WORKPG-$100     ; START OF INITIAL STACK
                      
                      ******************************************
                      * DEFAULT THE ROM BEGINNING ADDRESS TO 'ROMBEG'
                      * ASSIST09 IS POSITION ADDRESS INDEPENDENT, HOWEVER
                      * WE ASSEMBLE ASSUMING CONTROL OF THE HARDWARE VECTORS.
                      * NOTE THAT THE WORK RAM PAGE MUST BE 'RAMOFS'
                      * FROM THE ROM BEGINNING ADDRESS.
                      ********************************************
F800                                  ORG     ROMBEG          ; ROM ASSEMBLY/DEFAULT ADDRESS
                      
                      *****************************************************
                      *               BLDVTR - BUILD ASSIST09 VECTOR TABLE
                      * HARDWARE RESET CALLS THIS SUBROUTINE TO BUILD THE
                      * ASSIST09 VECTOR TABLE. THIS SUBROUTINE RESIDES AT
                      * THE FIRST BYTE OF THE ASSIST09 ROM, AND CAN BE
                      * CALLED VIA EXTERNAL CONTROL CODE FOR REMOTE
                      *
                      * ASSIST09 EXECUTION.
                      * INPUT: S->VALID STACK RAM
                      * OUTPUT: U->VECTOR TABLE ADDRESS
                      * DPR->ASSIST09 WORK AREA PAGE
                      * THE VECTOR TABLE AND DEFAULTS ARE INITIALIZED
                      * ALL REGISTERS VOLATILE
                      *************************************************
F800                                  Anrop   /BLDVTR/
F800                  \1              *
                                      EXPORT  \1
F800  308DE7BE                        LEAX    VECTAB,PCR      ; ADDRESS VECTOR TABLE
F804  1F10                            TFR     X,D             ; OBTAIN BASE PAGE ADDRESS
F806  1F8B                            TFR     A,DP            ; SETUP DPR
F808  979D                            STA     <BASEPG         ; STORE FOR QUICK REFERENCE
F80A  3384                            LEAU    ,X              ; RETURN TABLE TO CALLER
F80C  318C35                          LEAY    <INITVT,PCR     ; LOAD FROM ADDR
F80F  EF81                            STU     ,X++            ; INIT VECTOR TABLE ADDRESS
F811  C616                            LDB     #NUMVTR-5       ; NUMBER RELOCATABLE VECTORS
F813  3404                            PSHS    B               ; STORE INDEX ON STACK
F815  1F20            BLD2            TFR     Y,D             ; PREPARE ADDRESS RESOLVE
F817  E3A1                            ADDD    ,Y++            ; TO ABSOLUTE ADDRESS
F819  ED81                            STD     ,X++            ; INTO VECTOR TABLE
F81B  6AE4                            DEC     ,S              ; COUNT DOWN
F81D  26F6                            BNE     BLD2            ; BRANCH IF MORE TO INSERT
F81F  C60D                            LDB     #INTVE-INTVS    ; STATIC VALUE INIT LENGTH
F821  A6A0            BLD3            LDA     ,Y+             ; LOAD NEXT BYTE
F823  A780                            STA     ,X+             ; STORE INTO POSITION
F825  5A                              DECB                    ; COUNT DOWN
F826  26F9                            BNE     BLD3            ; LOOP UNTIL DONE
F828  318DF7D4                        LEAY    ROM2OF,PCR      ; TEST POSSIBLE EXTENSION ROM
F82C  8E20FE                          LDX     #$20FE          ; LOAD "BRA *" FLAG PATTERN
F82F  ACA1                            CMPX    ,Y++            ; ? EXTENDED ROM HERE
F831  2602                            BNE     BLDRTN          ; BRANCH NOT OUR ROM TO RETURN
F833  ADA4                            JSR     ,Y              ; CALL EXTENDED ROM INITIALIZE
F835  3584            BLDRTN          PULS    PC,B            ; RETURN TO INITIALIZER
                      
                      *****************************************************
                      *               RESET ENTRY POINT
                      * HARDWARE RESET ENTERS HERE IF ASSIST09 IS ENABLED
                      * TO RECEIVE THE MC6809 HARDWARE VECTORS. WE CALL
                      * THE BLDVTR SUBROUTINE TO INITIALIZE THE VECTOR
                      * TABLE, STACK, AND THEN FIREUP THE MONITOR VIA SWI
                      * CALL.
                      *******************************************************
F837                                  Anrop   /RESET/
F837                  \1              *
                                      EXPORT  \1
F837  328DE5C5                        LEAS    STACK,PCR       ; SETUP INITIAL STACK
F83B  8DC3                            BSR     BLDVTR          ; BUILD VECTOR TABLE
                      
F83D                                  Anrop   /RESET2/
F83D                  \1              *
                                      EXPORT  \1
F83D  4F                              CLRA                    ; ISSUE STARTUP MESSAGE
F83E  1F8B                            TFR     A,DP            ; DEFAULT TO PAGE ZERO
                      ;               LDB     BASEPG,PCR      ; LOAD DIRECT PAGE HIGH BYTE
                      ;               TFR     B,DP            ; SETUP DIRECT PAGE REGISTER
F840  3F                              SWI                     ; PERFORM MONITOR FIREUP
F841  08                              FCB     MONITR          ; TO ENTER COMMAND PROCESSING
F842  20F9                            BRA     RESET2          ; REENTER MONITOR IF 'CONTINUE'
                      
                      ******************************************************
                      *               INITVT - INITIAL VECTOR TABLE
                      * THIS TABLE IS RELOCATED TO RAM AND REPRESENTS THE
                      * INITIAL STATE OF THE VECTOR TABLE. ALL ADDRESSES
                      * ARE CONVERTED TO ABSOLUTE FORM. THIS TABLE STARTS
                      * WITH THE SECOND ENTRY, ENDS WITH STATIC CONSTANT
                      * INITIALIZATION DATA WHICH CARRIES BEYOND THE TABLE.
                      ************************************************
F844  0158            INITVT          FDB     CMDTBL-*        ; DEFAULT FIRST COMMAND TABLE
F846  0292                            FDB     RSRVDR-*        ; DEFAULT UNDEFINED HARDWARE VECTOR
F848  0290                            FDB     SWI3R-*         ; DEFAULT SWI3
F84A  028E                            FDB     SWI2R-*         ; DEFAULT SWI2
F84C  0270                            FDB     FIRQR-*         ; DEFAULT FIRQ
F84E  028A                            FDB     IRQR-*          ; DEFAULT IRQ ROUTINE
F850  0045                            FDB     SWIR-*          ; DEFAULT SWI ROUTINE
F852  022B                            FDB     NMIR-*          ; DEFAULT NMI ROUTINE
F854  FFE3                            FDB     RESET-*         ; RESTART VECTOR
F856  0290                            FDB     CION-*          ; DEFAULT CION
F858  0284                            FDB     CIDTA-*         ; DEFAULT CIDTA
F85A  0296                            FDB     CIOFF-*         ; DEFAULT CIOFF
F85C  028A                            FDB     COON-*          ; DEFAULT COON
F85E  0293                            FDB     CODTA-*         ; DEFAULT CODTA
F860  0290                            FDB     COOFF-*         ; DEFAULT COOFF
F862  039A                            FDB     HSDTA-*         ; DEFAULT HSDTA
F864  02B7                            FDB     BSON-*          ; DEFAULT BSON
F866  02D2                            FDB     BSDTA-*         ; DEFAULT BSDTA
F868  02BF                            FDB     BSOFF-*         ; DEFAULT BSOFF
F86A  E792                            FDB     PAUSER-*        ; DEFAULT PAUSE ROUTINE
F86C  047D                            FDB     EXP1-*          ; DEFAULT EXPRESSION ANALYZER
F86E  012D                            FDB     CMDTB2-*        ; DEFAULT SECOND COMMAND TABLE
                      * CONSTANTS
F870  D006            INTVS           FDB     ACIA            ; DEFAULT ACIA
F872  0005                            FCB     DFTCHP,DFTNLP   ; DEFAULT NULL PADDS
F874  0000                            FDB     0               ; DEFAULT ECHO
F876  D028                            FDB     PTM             ; DEFAULT PTM
F878  0000                            FDB     0               ; INITIAL STACK TRACE LEVEL
F87A  00                              FCB     0               ; INITIAL BREAKPOINT COUNT
F87B  00                              FCB     0               ; SWI BREAKPOINT LEVEL
F87C  39                              FCB     $39             ; DEFAULT PAUSE ROUTINE (RTS)
F87D                  INTVE           EQU     *
                      *B
                      ***********************************************
                      *               ASSIST09 SWI HANDLER
                      * THE SWI HANDLER PROVIDES ALL INTERFACING NECESSARY
                      * FOR A USER PROGRAM. A FUNCTION BYTE IS ASSUMED TO
                      * FOLLOW THE SWI INSTRUCTION. IT IS BOUND CHECKED
                      * AND THE PROPER ROUTINE IS GIVEN CONTROL. THIS
                      * INVOCATION MAY ALSO BE A BREAKPOINT INTERRUPT.
                      * IF SO, THE BREAKPOINT HANDLER IS ENTERED.
                      * INPUT: MACHINE STATE DEFINED FOR SWI
                      * OUTPUT: VARIES ACCORDING TO FUNCTION CALLED. PC ON
                      * CALLERS STACK INCREMENTED BY ONE IF VALID CALL.
                      * VOLATILE REGISTERS: SEE FUNCTIONS CALLED
                      * STATE: RUNS DISABLED UNLESS FUNCTION CLEARS I FLAG.
                      ************************************************
                      * SWI FUNCTION VECTOR TABLE
F87D                  SWIVTB
F87D  0194                            FDB     ZINCH-SWIVTB    ; INCHNP
F87F  01B1                            FDB     ZOTCH1-SWIVTB   ; OUTCH
F881  01CB                            FDB     ZPDTA1-SWIVTB   ; PDATA1
F883  01C3                            FDB     ZPDATA-SWIVTB   ; PDATA
F885  0175                            FDB     ZOT2HS-SWIVTB   ; OUT2HS
F887  0173                            FDB     ZOT4HS-SWIVTB   ; OUT4HS
F889  01C0                            FDB     ZPCRLF-SWIVTB   ; PCRLF
F88B  0179                            FDB     ZSPACE-SWIVTB   ; SPACE
F88D  0055                            FDB     ZMONTR-SWIVTB   ; MONITR
F88F  017D                            FDB     ZVSWTH-SWIVTB   ; VCTRSW
F891  0256                            FDB     ZBKPNT-SWIVTB   ; BREAKPOINT
F893  01D1                            FDB     ZPAUSE-SWIVTB   ; TASK PAUSE
                      
F895                  SWIR
F895  6A8DE6F7                        DEC     SWICNT,PCR      ; UP "SWI" LEVEL FOR TRACE
F899  170225                          LBSR    LDDP            ; SETUP PAGE AND VERIFY STACK
                      * CHECK FOR BREAKPOINT TRAP
F89C  EE6A                            LDU     10,S            ; LOAD PROGRAM COUNTER
F89E  335F                            LEAU    -1,U            ; BACK TO SWI ADDRESS
F8A0  0DFB                            TST     <SWIBFL         ; ? THIS "SWI" BREAKPOINT
F8A2  2611                            BNE     SWIDNE          ; BRANCH IF SO TO LET THROUGH
F8A4  17069B                          LBSR    CBKLDR          ; OBTAIN BREAKPOINT POINTERS
F8A7  50                              NEGB                    ; OBTAIN POSITIVE COUNT
F8A8  5A              SWILP           DECB                    ; COUNT DOWN
F8A9  2B0A                            BMI     SWIDNE          ; BRANCH WHEN DONE
F8AB  11A3A1                          CMPU    ,Y++            ; ? WAS THIS A BREAKPOINT
F8AE  26F8                            BNE     SWILP           ; BRANCH IF NOT
F8B0  EF6A                            STU     10,S            ; SET PROGRAM COUNTER BACK
F8B2  16021E                          LBRA    ZBKPNT          ; GO DO BREAKPOINT
F8B5  0FFB            SWIDNE          CLR     <SWIBFL         ; CLEAR IN CASE SET
F8B7  3706                            PULU    D               ; OBTAIN FUNCTION BYTE, UP PC
F8B9  C10B                            CMPB    #NUMFUN         ; ? TOO HIGH
F8BB  1022020F                        LBHI    ERROR           ; YES, DO BREAKPOINT
F8BF  EF6A                            STU     10,S            ; BUMP PROGRAM COUNTER PAST SWI
F8C1  58                              ASLB                    ; FUNCTION CODE TIMES TWO
F8C2  338CB8                          LEAU    SWIVTB,PCR      ; OBTAIN VECTOR BRANCH ADDRESS
F8C5  ECC5                            LDD     B,U             ; LOAD OFFSET
F8C7  6ECB                            JMP     D,U             ; JUMP TO ROUTINE
                      
                      **********************************************
                      * REGISTERS TO FUNCTION ROUTINES:
                      *       DP-> WORK AREA PAGE
                      *       D,Y,U=UNRELIABLE                X=AS CALLED FROM USER
                      *       S=AS FROM SWI INTERRUPT
                      *********************************************
                      
                      **************************************************
                      *               [SWI FUNCTION 8]
                      *               MONITOR ENTRY
                      *       FIREUP THE ASSIST09 MONITOR.
                      *       THE STACK WITH ITS VALUES FOR THE DIRECT PAGE
                      *       REGISTER AND CONDITION CODE FLAGS ARE USED AS IS.
                      *       1) INITIALIZE CONSOLE I/O
                      *       2) OPTIONALLY PRINT SIGNON
                      *       3) INITIALIZE PTM FOR SINGLE STEPPING
                      *       4) ENTER COMMAND PROCESSOR
                      * INPUT: A=0 INIT CONSOLE AND PRINT STARTUP MESSAGE
                      *        A#0 OMIT CONSOLE INIT AND STARTUP MESSAGE
                      *************************************************
                      
F8C9  4153534953543039 SIGNON          FCC     /ASSIST09/      ; SIGNON EYE-CATCHER
F8D1  04                              FCB     EOT
                      
F8D2                                  Anrop   /ZMONTR/
F8D2                  \1              *
                                      EXPORT  \1
F8D2  10DF97                          STS     <RSTACK         ; SAVE FOR BAD STACK RECOVERY
F8D5  6D61                            TST     1,S             ; ? INIT CONSOLE AND SEND MSG
F8D7  260D                            BNE     ZMONT2          ; BRANCH IF NOT
F8D9  AD9DE6F9                        JSR     [VECTAB+_CION,PCR]      ; READY CONSOLE INPUT
F8DD  AD9DE6FB                        JSR     [VECTAB+_COON,PCR]      ; READY CONSOLE OUTPUT
F8E1  308CE5                          LEAX    SIGNON,PCR              ; READY SIGNON EYE-CATCHER
F8E4  3F                              SWI                     ; PERFORM
F8E5  03                              FCB     PDATA           ; PRINT STRING
F8E6  9EF6            ZMONT2          LDX     <VECTAB+_PTM    ; LOAD PTM ADDRESS
F8E8  270D                            BEQ     CMD             ; BRANCH IF NOT TO USE A PTM
F8EA  6F02                            CLR     PTMTM1-PTM,X    ; SET LATCH TO CLEAR RESET
F8EC  6F03                            CLR     PTMTM1+1-PTM,X  ; AND SET GATE HIGH
F8EE  CC01A6                          LDD     #$01A6          ; SETUP TIMER 1 MODE
F8F1  A701                            STA     PTMC2-PTM,X     ; SETUP FOR CONTROL REGISTER1
F8F3  E784                            STB     PTMC13-PTM,X    ; SET OUTPUT ENABLED/
                      * SINGLE SHOT/ DUAL 8 BIT/INTERNAL MODE/OPERATE
F8F5  6F01                            CLR     PTMC2-PTM,X     ; SET CR2 BACK TO RESET FORM
                      * FALL INTO COMMAND PROCESSOR
                      
                      ***************************************************
                      *               COMMAND HANDLER
                      *       BREAKPOINTS ARE REMOVED AT THIS TIME.
                      *       PROMPT FOR A COMMAND, AND STORE ALL CHARACTERS
                      *       UNTIL A SEPARATOR ON THE STACK.
                      *       SEARCH FOR FIRST MATCHING COMMAND SUBSET,
                      *       CALL IT OR GIVE '?' RESPONSE.
                      *       DURING COMMAND SEARCH:
                      *               B=OFFSET TO NEXT ENTRY ON X
                      *               U=SAVED S
                      *               U-1=ENTRY SIZE+2
                      *               U-2=VALID NUMBER FLAG (>=0 VALID)/COMPARE CNT
                      *               U-3=CARRIAGE RETURN FLAG (0=CR HAS BEEN DONE)
                      *               U-4=START OF COMMAND STORE
                      *               S+0=END OF COMMAND STORE
                      ***********************************************
                      
F8F7  3F              CMD             SWI                     ; TO NEW LINE
F8F8  06                              FCB     PCRLF           ; FUNCTION
                      * DISARM THE BREAKPOINTS
F8F9  170646          CMDNEP          LBSR    CBKLDR          ; OBTAIN BREAKPOINT POINTERS
F8FC  2A0C                            BPL     CMDNOL          ; BRANCH IF NOT ARMED OR NONE
F8FE  50                              NEGB                    ; MAKE POSITIVE
F8FF  D7FA                            STB     <BKPTCT         ; FLAG AS DISARMED
F901  5A              CMDDDL          DECB                    ; ? FINISHED
F902  2B06                            BMI     CMDNOL          ; BRANCH IF SO
F904  A630                            LDA     -NUMBKP*2,Y     ; LOAD OPCODE STORED
F906  A7B1                            STA     [,Y++]          ; STORE BACK OVER "SWI"
F908  20F7                            BRA     CMDDDL          ; LOOP UNTIL DONE
F90A  AE6A            CMDNOL          LDX     10,S            ; LOAD USERS PROGRAM COUNTER
F90C  9F93                            STX     <PCNTER         ; SAVE FOR EXPRESSION ANALYZER
F90E  863E                            LDA     #PROMPT         ; LOAD PROMPT CHARACTER
F910  3F                              SWI                     ; SEND TO OUTPUT HANDLER
F911  01                              FCB     OUTCH           ; FUNCTION
F912  33E4                            LEAU    ,S              ; REMEMBER STACK RESTORE ADDRESS
F914  DF95                            STU     <PSTACK         ; REMEMBER STACK FOR ERROR USE
F916  4F                              CLRA                    ; PREPARE ZERO
F917  5F                              CLRB                    ; PREPARE ZERO
F918  DD9B                            STD     <NUMBER         ; CLEAR NUMBER BUILD AREA
F91A  DD8F                            STD     <MISFLG         ; CLEAR MISCEL. AND SWICNT FLAGS
F91C  DD91                            STD     <TRACEC         ; CLEAR TRACE COUNT
F91E  C602                            LDB     #2              ; SET D TO TWO
F920  3407                            PSHS    D,CC            ; PLACE DEFAULTS ONTO STACK
                      
                      * CHECK FOR "QUICK" COMMANDS.
F922  170454                          LBSR    READ            ; OBTAIN FIRST CHARACTER
F925  308D0581                        LEAX    CDOT+2,PCR      ; PRESET FOR SINGLE TRACE
F929  812E                            CMPA    #'.             ; ? QUICK TRACE
F92B  275A                            BEQ     CMDXQT          ; BRANCH EQUAL FOR TRACE ONE
F92D  308D04E9                        LEAX    CMPADP+2,PCR    ; READY MEMORY ENTRY POINT
F931  812F                            CMPA    #'/             ; ? OPEN LAST USED MEMORY
F933  2752                            BEQ     CMDXQT          ; BRANCH TO DO IT IF SO
                      
                      * PROCESS NEXT CHARACTER
F935                  CMD2    
F935  8120                            CMPA    #SP             ; ? BLANK OR DELIMITER
F937  2314                            BLS     CMDGOT          ; BRANCH YES, WE HAVE IT
F939  3402                            PSHS    A                       ; BUILD ONTO STACK
F93B  6C5F                            INC     -1,U            ; COUNT THIS CHARACTER
F93D  812F                            CMPA    #'/             ; ? MEMORY COMMAND
F93F  274F                            BEQ     CMDMEM          ; BRANCH IF SO
F941  17040B                          LBSR    BLDHXC          ; TREAT AS HEX VALUE
F944  2702                            BEQ     CMD3            ; BRANCH IF STILL VALID NUMBER
F946  6A5E                            DEC     -2,U            ; FLAG AS INVALID NUMBER
F948  17042E          CMD3            LBSR    READ            ; OBTAIN NEXT CHARACTER
F94B  20E8                            BRA     CMD2            ; TEST NEXT CHARACTER
                              
                      * GOT COMMAND, NOW SEARCH TABLES
F94D                  CMDGOT
F94D  800D                            SUBA    #CR             ; SET ZERO IF CARRIAGE RETURN
F94F  A75D                            STA     -3,U            ; SETUP FLAG
F951  9EC4                            LDX     <VECTAB+_CMDL1  ; START WITH FIRST CMD LIST
F953  E680            CMDSCH          LDB     ,X+             ; LOAD ENTRY LENGTH
F955  2A10                            BPL     CMDSME          ; BRANCH IF NOT LIST END
F957  9EEE                            LDX     <VECTAB+_CMDL2  ; NOW TO SECOND CMD LITS
F959  5C                              INCB                    ; ? TO CONTINUE TO DEFAULT LIST
F95A  27F7                            BEQ     CMDSCH          ; BRANCH IF SO
F95C  10DE95          CMDBAD          LDS     <PSTACK         ; RESTORE STACK
F95F  308D015A                        LEAX    ERRMSG,PCR      ; POINT TO ERROR STRING
F963  3F                              SWI                     ; SEND OUT
F964  02                              FCB     PDATA1          ; TO CONSOLE
F965  2090                            BRA     CMD             ; AND TRY AGAIN
                      * SEARCH NEXT ENTRY
F967  5A              CMDSME          DECB                    ; TAKE ACCOUNT OF LENGTH BYTE
F968  E15F                            CMPB    -1,U            ; ? ENTERED LONGER THAN ENTRY
F96A  2403                            BHS     CMDSIZ          ; BRANCH IF NOT TOO LONG
F96C  3A              CMDFLS          ABX                     ; SKIP TO NEXT ENTRY
F96D  20E4                            BRA     CMDSCH          ; AND TRY NEXT
F96F  315D            CMDSIZ          LEAY    -3,U            ; PREPARE TO COMPARE
F971  A65F                            LDA     -1,U            ; LOAD SIZE+2
F973  8002                            SUBA    #2              ; TO ACTUAL SIZE ENTERED
F975  A75E                            STA     -2,U            ; SAVE SIZE FOR COUNTDOWN
F977  5A              CMDCMP          DECB                    ; DOWN ONE BYTE
F978  A680                            LDA     ,X+             ; NEXT COMMAND CHARACTER
F97A  A1A2                            CMPA    ,-Y             ; ? SAME AS THAT ENTERED
F97C  26EE                            BNE     CMDFLS          ; BRANCH TO FLUSH IF NOT
F97E  6A5E                            DEC     -2,U            ; COUNT DOWN LENGTH OF ENTRY
F980  26F5                            BNE     CMDCMP          ; BRANCH IF MORE TO TEST
F982  3A                              ABX                     ; TO NEXT ENTRY
F983  EC1E                            LDD     -2,X            ; LOAD OFFSET
F985  308B                            LEAX    D,X             ; COMPUTE ROUTINE ADDRESS+2
F987  6D5D            CMDXQT          TST     -3,U            ; SET CC FOR CARRIAGE RETURN TEST
F989  32C4                            LEAS    ,U              ; DELETE STACK WORK AREA
F98B  AD1E                            JSR     -2,X            ; CALL COMMAND
F98D  16FF7A                          LBRA    CMDNOL          ; GO GET NEXT COMMAND
F990  6D5E            CMDMEM          TST     -2,U            ; ? VALID HEX NUMBER ENTERED
F992  2BC8                            BMI     CMDBAD          ; BRANCH ERROR IF NOT
F994  3088AE                          LEAX    <CMEMN-CMPADP,X ; TO DIFFERENT ENTRY
F997  DC9B                            LDD     <NUMBER         ; LOAD NUMBER ENTERED
F999  20EC                            BRA     CMDXQT          ; AND ENTER MEMORY COMMAND
                      
                      ** COMMANDS ARE ENTERED AS A SUBROUTINE WITH:
                      **      DPR->ASSIST09 DIRECT PAGE WORK AREA
                      **      Z=1 CARRIAGE RETURN ENTERED
                      **      Z=0 NON CARRIAGE RETURN DELIMITER
                      **      S=NORMAL RETURN ADDRESS
                      ** THE LABEL "CMDBAD" MAY BE ENTERED TO ISSUE AN
                      ** AN ERROR FLAG (*).
                      **************************************************
                      *       ASSIST09 COMMAND TABLES
                      * THESE ARE THE DEFAULT COMMAND TABLES. EXTERNAL
                      * TABLES OF THE SAME FORMAT MAY EXTEND/REPLACE
                      * THESE BY USING THE VECTOR SWAP FUNCTION.
                      *
                      * ENTRY FORMAT:
                      *       +0...TOTAL SIZE OF ENTRY (INCLUDING THIS BYTE)
                      *       +1...COMMAND STRING
                      *       +N...TWO BYTE OFFSET TO COMMAND (ENTRYADDR-*)
                      *
                      * THE TABLES TERMINATE WITH A ONE BYTE -1 OR -2.
                      * THE -1 CONTINUES THE COMMAND SEARCH WITH THE
                      *       SECOND COMMAND TABLE.
                      * THE -2 TERMINATES COMMAND SEARCHES.
                      *****************************************************
                      
                      * THIS IS THE DEFAULT LIST FOR THE SECOND COMMAND
                      * LIST ENTRY.
                      
F99B  FE              CMDTB2          FCB     -2              ; STOP COMMAND SEARCHES
                      
                      * THIS IS THE DEFAULT LIST FOR THE FIRST COMMAND
                      * LIST ENTRY.
                      
F99C                  CMDTBL          EQU     *               ; MONITOR COMMAND TABLE
F99C  04                              FCB     4
F99D  42                              FCC     /B/             ; 'BREAKPOINT' COMMAND
F99E  054D                            FDB     CBKPT-*
F9A0  04                              FCB     4
F9A1  43                              FCC     /C/             ; 'CALL' COMMAND
F9A2  0417                            FDB     CCALL-*
F9A4  04                              FCB     4
F9A5  44                              FCC     /D/             ; 'DISPLAY' COMMAND
F9A6  049D                            FDB     CDISP-*
F9A8  04                              FCB     4
F9A9  45                              FCC     /E/             ; 'ENCODE' COMMAND
F9AA  059F                            FDB     CENCDE-*
F9AC  04                              FCB     4
F9AD  47                              FCC     /G/             ; 'GO' COMMAND
F9AE  03D2                            FDB     CGO-*
F9B0  04                              FCB     4
F9B1  4C                              FCC     /L/             ; 'LOAD' COMMAND
F9B2  04DD                            FDB     CLOAD-*
F9B4  04                              FCB     4
F9B5  4D                              FCC     /M/             ; 'MEMORY' COMMAND
F9B6  040D                            FDB     CMEM-*
F9B8  04                              FCB     4
F9B9  4E                              FCC     /N/             ; 'NULLS' COMMAND
F9BA  04FD                            FDB     CNULLS-*
F9BC  04                              FCB     4
F9BD  4F                              FCC     /O/             ; 'OFFSET' COMMAND
F9BE  050A                            FDB     COFFS-*
F9C0  04                              FCB     4
F9C1  50                              FCC     /P/             ; 'PUNCH' COMMAND
F9C2  04AF                            FDB     CPUNCH-*
F9C4  04                              FCB     4
F9C5  52                              FCC     /R/             ; 'REGISTERS' COMMAND
F9C6  0284                            FDB     CREG-*
F9C8  04                              FCB     4
F9C9  53                              FCC     /S/             ; 'STLEVEL' COMMAND
F9CA  04F2                            FDB     CSTLEV-*
F9CC  04                              FCB     4
F9CD  54                              FCC     /T/             ; 'TRACE' COMMAND
F9CE  04D6                            FDB     CTRACE-*
F9D0  04                              FCB     4
F9D1  56                              FCC     /V/             ; 'VERIFY' COMMAND
F9D2  04CF                            FDB     CVER-*
F9D4  04                              FCB     4
F9D5  57                              FCC     /W/             ; 'WINDOW' COMMAND
F9D6  0468                            FDB     CWINDO-*
F9D8  FF                              FCB     -1              ; END, CONTINUE WITH THE SECOND
                      
                      *************************************************
                      *               [SWI FUNCTIONS 4 AND 5]
                      *       4 - OUT2HS - DECODE BYTE TO HEX AND ADD SPACE
                      *       5 - OUT4HS - DECODE WORD TO HEX AND ADD SPACE
                      * INPUT: X->BYTE OR WORD TO DECODE
                      * OUTPUT: CHARACTERS SENT TO OUTPUT HANDLER
                      *               X->NEXT BYTE OR WORD
                      *************************************************
F9D9  A680            ZOUT2H          LDA     ,X+             ; LOAD NEXT BYTE
F9DB  3406                            PSHS    D                ; SAVE - DO NOT REREAD
F9DD  C610                            LDB     #16             ; SHIFT BY 4 BITS
F9DF  3D                              MUL                     ; WITH MULTIPLY
F9E0  8D04                            BSR     ZOUTHX          ; SEND OUT AS HEX
F9E2  3506                            PULS    D                ; RESTORE BYTES
F9E4  840F                            ANDA    #$0F            ; ISOLATE RIGHT HEX
F9E6  8B90            ZOUTHX          ADDA    #$90            ; PREPARE A-F ADJUST
F9E8  19                              DAA                     ; ADJUST
F9E9  8940                            ADCA    #$40            ; PREPARE CHARACTER BITS
F9EB  19                              DAA                     ; ADJUST
F9EC  6E9DE5EE        SEND            JMP     [VECTAB+_CODTA,PCR] ; SEND TO OUT HANDLER
                      
F9F0  8DE7            ZOT4HS          BSR     ZOUT2H          ; CONVERT FIRST BYTE
F9F2  8DE5            ZOT2HS          BSR     ZOUT2H          ; CONVERT BYTE TO HEX
F9F4  AF64                            STX     4,S             ; UPDATE USERS X REGISTER
                      * FALL INTO SPACE ROUTINE
                      
                      *************************************************
                      *               [SWI FUNCTION 7]
                      *               SPACE - SEND BLANK TO OUTPUT HANDLER
                      * INPUT: NONE
                      * OUTPUT: BLANK SEND TO CONSOLE HANDLER
                      *************************************************
F9F6  8620            ZSPACE          LDA     #SP             ; LOAD BLANK
F9F8  203D                            BRA     ZOTCH2          ; SEND AND RETURN
                      
                      ***********************************************
                      *               [SWI FUNCTION 9]
                      *               SWAP VECTOR TABLE ENTRY
                      * INPUT: A=VECTOR TABLE CODE (OFFSET)
                      * X=0 OR REPLACEMENT VALUE
                      * OUTPUT: X=PREVIOUS VALUE
                      ***********************************************
F9FA  A661            ZVSWTH          LDA     1,S             ; LOAD REQUESTERS A
F9FC  8134                            CMPA    #HIVTR          ; ? SUB-CODE TOO HIGH
F9FE  2239                            BHI     ZOTCH3          ; IGNORE CALL IF SO
FA00  109EC2                          LDY     <VECTAB+_AVTBL  ; LOAD VECTOR TABLE ADDRESS
FA03  EEA6                            LDU     A,Y             ; U=OLD ENTRY
FA05  EF64                            STU     4,S             ; RETURN OLD VALUE TO CALLERS X
FA07  AF7E                            STX     -2,S            ; ? X=0
FA09  272E                            BEQ     ZOTCH3          ; YES, DO NOT CHANGE ENTRY
FA0B  AFA6                            STX     A,Y             ; REPLACE ENTRY
FA0D  202A                            BRA     ZOTCH3          ; RETURN FROM SWI
                      *D
                      
                      ************************************************
                      *               [SWI FUNCTION 0]
                      *       INCHNP - OBTAIN INPUT CHAR IN A (NO PARITY)
                      * NULLS AND RUBOUTS ARE IGNORED.
                      * AUTOMATIC LINE FEED IS SENT UPON RECEIVING A
                      * CARRIAGE RETURN.
                      * UNLESS WE ARE LOADING FROM TAPE.
                      ************************************************
FA0F  8D5D            ZINCHP          BSR     XQPAUS          ; RELEASE PROCESSOR
FA11  8D5F            ZINCH           BSR     XQCIDT          ; CALL INPUT DATA APPENDAGE
FA13  24FA                            BCC     ZINCHP          ; LOOP IF NONE AVAILABLE
FA15  4D                              TSTA                    ; ? TEST FOR NULL
FA16  27F9                            BEQ     ZINCH           ; IGNORE NULL
FA18  817F                            CMPA    #$7F            ; ? RUBOUT
FA1A  27F5                            BEQ     ZINCH           ; BRANCH YES TO IGNORE
FA1C  A761                            STA     1,S             ; STORE INTO CALLERS A
FA1E  0D8F                            TST     <MISFLG         ; ? LOAD IN PROGRESS
FA20  2617                            BNE     ZOTCH3          ; BRANCH IF SO TO NOT ECHO
FA22  810D                            CMPA    #CR             ; ? CARRIAGE RETURN
FA24  2604                            BNE     ZIN2            ; NO, TEST ECHO BYTE
FA26  860A                            LDA     #LF             ; LOAD LINE FEED
FA28  8DC2                            BSR     SEND            ; ALWAYS ECHO LINE FEED
FA2A  0DF4            ZIN2            TST     <VECTAB+_ECHO   ; ? ECHO DESIRED
FA2C  260B                            BNE     ZOTCH3          ; NO, RETURN
                      * FALL THROUGH TO OUTCH
                      ************************************************
                      *               [SWI FUNCTION 1]
                      *       OUTCH - OUTPUT CHARACTER FROM A
                      * INPUT: NONE
                      * OUTPUT: IF LINEFEED IS THE OUTPUT CHARACTER THEN
                      * C=0 NO CTL-X RECEIVED, C=1 CTL-X RECEIVED
                      ************************************************
FA2E  A661            ZOTCH1          LDA     1,S             ; LOAD CHARACTER TO SEND
FA30  308C09                          LEAX    <ZPCRLS,PCR     ; DEFAULT FOR LINE FEED
FA33  810A                            CMPA    #LF             ; ? LINE FEED
FA35  270F                            BEQ     ZPDTLP          ; BRANCH TO CHECK PAUSE IF SO
FA37  8DB3            ZOTCH2          BSR     SEND            ; SEND TO OUTPUT ROUTINE
FA39  0C90            ZOTCH3          INC     <SWICNT         ; BUMP UP "SWI" TRACE NEST LEVEL
FA3B  3B                              RTI                     ; RETURN FROM "SWI" FUNCTION
                      
                      **************************************************
                      * [SWI FUNCTION 6]
                      * PCRLF - SEND CR/LF TO CONSOLE HANDLER
                      * INPUT: NONE
                      * OUTPUT: CR AND LF SENT TO HANDLER
                      * C=0 NO CTL-X, C=1 CTL-X RECEIVED
                      **************************************************
FA3C  04              ZPCRLS          FCB     EOT             ; NULL STRING
FA3D  308CFC          ZPCRLF          LEAX    ZPCRLS,PCR      ; READY CR,LF STRING
                      * FALL INTO CR/LF CODE
                      
                      **************************************************
                      * [SWI FUNCTION 3]
                      * PDATA - OUTPUT CR/LF AND STRING
                      * INPUT: X->STRING
                      * OUTPUT: CR/LF AND STRING SENT TO OUTPUT CONSOLE
                      * HANDLER.
                      * C=0 NO CTL-X, C=1 CTL-X RECEIVED
                      * NOTE: LINE FEED MUST FOLLOW CARRIAGE RETURN FOR
                      * PROPER PUNCH DATA.
                      **************************************************
                      
FA40  860D            ZPDATA          LDA     #CR             ; LOAD CARRIAGE RETURN
FA42  8DA8                            BSR     SEND            ; SEND IT
FA44  860A                            LDA     #LF             ; LOAD LINE FEED
                      * FALL INTO PDATA1
                      
                      *************************************************
                      * [SWI FUNCTION 2]
                      * PDATA1 - OUTPUT STRING TILL EOT ($04)
                      * THIS ROUTINE PAUSES IF AN INPUT BYTE BECOMES
                      * AVAILABLE DURING OUTPUT TRANSMISSION UNTIL A
                      * SECOND IS RECEIVED.
                      * INPUT: X->STRING
                      * OUTPUT: STRING SENT TO OUTPUT CONSOLE DRIVER
                      * C=0 NO CTL-X, C=1 CTL-X RECEIVED
                      *************************************************
                      
FA46  8DA4            ZPDTLP          BSR     SEND            ; SEND CHARACTER TO DRIVER
FA48  A680            ZPDTA1          LDA     ,X+             ; LOAD NEXT CHARACTER
FA4A  8104                            CMPA    #EOT            ; ? EOT
FA4C  26F8                            BNE     ZPDTLP          ; LOOP IF NOT
                      * FALL INTO PAUSE CHECK FUNCTION
                      
                      ********************************************
                      * [SWI FUNCTION 12]
                      * PAUSE - RETURN TO TASK DISPATCHING AND CHECK
                      * FOR FREEZE CONDITION OR CTL-X BREAK
                      * THIS FUNCTION ENTERS THE TASK PAUSE HANDLER SO
                      * OPTIONALLY OTHER 6809 PROCESSES MAY GAIN CONTROL.
                      * UPON RETURN, CHECK FOR A 'FREEZE' CONDITION
                      * WITH A RESULTING WAIT LOOP, OR CONDITION CODE
                      * RETURN IF A CONTROL-X IS ENTERED FROM THE INPUT
                      * HANDLER.
                      * OUTPUT: C=1 IF CTL-X HAS ENTERED, C=0 OTHERWISE
                      ******************************************
                      
FA4E  8D1E            ZPAUSE          BSR     XQPAUS          ; RELEASE CONTROL AT EVERY LINE
FA50  8D06                            BSR     CHKABT          ; CHECK FOR FREEZE OR ABORT
FA52  1FA9                            TFR     CC,B            ; PREPARE TO REPLACE CC
FA54  E7E4                            STB     ,S              ; OVERLAY OLD ONE ON STACK
FA56  20E1                            BRA     ZOTCH3          ; RETURN FROM "SWI"
                      
                      * CHKABT - SCAN FOR INPUT PAUSE/ABORT DURING OUTPUT
                      * OUTPUT: C=0 OK, C=1 ABORT (CTL-X ISSUED)
                      * VOLATILE: U,X,D
FA58  8D18            CHKABT          BSR     XQCIDT          ; ATTEMPT INPUT
FA5A  2405                            BCC     CHKRTN          ; BRANCH NO TO RETURN
FA5C  8118                            CMPA    #CAN            ; ? CTL-X FOR ABORT
FA5E  2602                            BNE     CHKWT           ; BRANCH NO TO PAUSE
FA60  53              CHKSEC          COMB                    ; SET CARRY
FA61  39              CHKRTN          RTS                     ; RETURN TO CALLER WITH CC SET
FA62  8D0A            CHKWT           BSR     XQPAUS          ; PAUSE FOR A MOMENT
FA64  8D0C                            BSR     XQCIDT          ; ? KEY FOR START
FA66  24FA                            BCC     CHKWT           ; LOOP UNTIL RECEIVED
FA68  8118                            CMPA    #CAN            ; ? ABORT SIGNALED FROM WAIT
FA6A  27F4                            BEQ     CHKSEC          ; BRANCH YES
FA6C  4F                              CLRA                    ; SET C=0 FOR NO ABORT
FA6D  39                              RTS                     ; AND RETURN
                      
                      * SAVE MEMORY WITH JUMPS
FA6E  6E9DE578        XQPAUS          JMP     [VECTAB+_PAUSE,PCR] ; TO PAUSE ROUTINE
FA72  AD9DE562        XQCIDT          JSR     [VECTAB+_CIDTA,PCR] ; TO INPUT ROUTINE
FA76  847F                            ANDA    #$7F            ; STRIP PARITY
FA78  39                              RTS                     ; RETURN TO CALLER
                      
                      ********************************************
                      * NMI DEFAULT INTERRUPT HANDLER
                      * THE NMI HANDLER IS USED FOR TRACING INSTRUCTIONS.
                      * TRACE PRINTOUTS OCCUR ONLY AS LONG AS THE STACK
                      * TRACE LEVEL IS NOT BREACHED BY FALLING BELOW IT.
                      * TRACING CONTINUES UNTIL THE COUNT TURNS ZERO OR
                      * A CTL-X IS ENTERED FROM THE INPUT CONSOLE DEVICE.
                      *********************************************
                      
FA79  4F502D04        MSHOWP          FCB     'O,'P,'-,EOT    ; OPCODE PREP
                      
FA7D                  NMIR    
FA7D  8D42                            BSR     LDDP            ; LOAD PAGE AND VERIFY STACK
FA7F  0D8F                            TST     <MISFLG         ; ? THRU A BREAKPOINT
FA81  2634                            BNE     NMICON          ; BRANCH IF SO TO CONTINUE
FA83  0D90                            TST     <SWICNT         ; ? INHIBIT "SWI" DURING TRACE
FA85  2B29                            BMI     NMITRC          ; BRANCH YES
FA87  306C                            LEAX    12,S            ; OBTAIN USERS STACK POINTER
FA89  9CF8                            CMPX    <SLEVEL         ; ? TO TRACE HERE
FA8B  2523                            BLO     NMITRC          ; BRANCH IF TOO LOW TO DISPLAY
FA8D  308CE9                          LEAX    MSHOWP,PCR      ; LOAD OP PREP
FA90  3F                              SWI                     ; SEND TO CONSOLE
FA91  02                              FCB     PDATA1          ; FUNCTION
FA92  098E                            ROL     <DELIM          ; SAVE CARRY BIT
FA94  308DE501                        LEAX    LASTOP,PCR      ; POINT TO LAST OP
FA98  3F                              SWI                     ; SEND OUT AS HEX
FA99  05                              FCB     OUT4HS          ; FUNCTION
FA9A  8D17                            BSR     REGPRS          ; FOLLOW MEMORY WITH REGISTERS
FA9C  2537                            BCS     ZBKCMD          ; BRANCH IF "CANCEL"
FA9E  068E                            ROR     <DELIM          ; RESTORE CARRY BIT
FAA0  2533                            BCS     ZBKCMD          ; BRANCH IF "CANCEL"
FAA2  9E91                            LDX     <TRACEC         ; LOAD TRACE COUNT
FAA4  272F                            BEQ     ZBKCMD          ; IF ZERO TO COMMAND HANDLER
FAA6  301F                            LEAX    -1,X            ; MINUS ONE
FAA8  9F91                            STX     <TRACEC         ; REFRESH
FAAA  2729                            BEQ     ZBKCMD          ; STOP TRACE WHEN ZERO
FAAC  8DAA                            BSR     CHKABT          ; ? ABORT THE TRACE
FAAE  2525                            BCS     ZBKCMD          ; BRANCH YES TO COMMAND HANDLER
FAB0  1603F7          NMITRC          LBRA    CTRCE3          ; NO, TRACE ANOTHER INSTRUCTION
                      
FAB3  1701B9          REGPRS          LBSR    REGPRT          ; PRINT REGISTERS AS FROM COMMAND
FAB6  39                              RTS                     ; RETURN TO CALLER
                      
                      * JUST EXECUTED THRU A BRKPNT. NOW CONTINUE NORMALLY
                      
FAB7  0F8F            NMICON          CLR     <MISFLG ; CLEAR THRU FLAG
FAB9  1702EB                          LBSR    ARMBK2          ; ARM BREAKPOINTS
FABC  3B              RTI             RTI                     ; AND CONTINUE USERS PROGRAM
                      
                      * LDDP - SETUP DIRECT PAGE REGISTER, VERIFY STACK.
                      * AN INVALID STACK CAUSES A RETURN TO THE COMMAND
                      * HANDLER.
                      * INPUT: FULLY STACKED REGISTERS FROM AN INTERRUPT
                      * OUTPUT: DPR LOADED TO WORK PAGE
                      
FABD  3F3F3F04        ERRMSG          FCB     "???",EOT       ; ERROR RESPONSE
                      
FAC1  E68DE4D8        LDDP            LDB     BASEPG,PCR      ; LOAD DIRECT PAGE HIGH BYTE
FAC5  1F9B                            TFR     B,DP            ; SETUP DIRECT PAGE REGISTER
FAC7  A163                            CMPA    3,S             ; ? IS STACK VALID
FAC9  2725                            BEQ     RTS             ; YES, RETURN
FACB  10DE97                          LDS     <RSTACK         ; RESET TO INITIAL STACK POINTER
FACE  308CEC          ERROR           LEAX    ERRMSG,PCR      ; LOAD ERROR REPORT
FAD1  3F                              SWI                     ; SEND OUT BEFORE REGISTERS
FAD2  03                              FCB     PDATA           ; ON NEXT LINE
                      * FALL INTO BREAKPOINT HANDLER
                      
                      **********************************************
                      * [SWI FUNCTION 10]
                      * BREAKPOINT PROGRAM FUNCTION
                      * PRINT REGISTERS AND GO TO COMMAND HANLER
                      ***********************************************
                      
FAD3  8DDE            ZBKPNT          BSR     REGPRS          ; PRINT OUT REGISTERS
FAD5  16FE21          ZBKCMD          LBRA    CMDNEP          ; NOW ENTER COMMAND HANDLER
                      
                      ********************************************
                      * IRQ, RESERVED, SWI2 AND SWI3 INTERRUPT HANDLERS
                      * THE DEFAULT HANDLING IS TO CAUSE A BREAKPOINT.
                      ********************************************
FAD8                  SWI2R           EQU     *               ; SWI2 ENTRY
FAD8                  SWI3R           EQU     *               ; SWI3 ENTRY
FAD8                  IRQR            EQU     *               ; IRQ ENTRY
FAD8                  RSRVDR  
FAD8  8DE7                            BSR     LDDP            ; SET BASE PAGE, VALIDATE STACK
FADA  20F7                            BRA     ZBKPNT          ; FORCE A BREAKPOINT
                      
                      ******************************************
                      * FIRQ HANDLER
                      * JUST RETURN FOR THE FIRQ INTERRUPT
                      ******************************************
FABC                  FIRQR           EQU     RTI             ; IMMEDIATE RETURN
                      
                      **************************************************
                      * DEFAULT I/O DRIVERS
                      **************************************************
                      * CIDTA - RETURN CONSOLE INPUT CHARACTER
                      * OUTPUT: C=0 IF NO DATA READY, C=1 A=CHARACTER
                      * U VOLATILE
                      
FADC  DEF0            CIDTA           LDU     <VECTAB+_ACIA   ; LOAD ACIA ADDRESS
FADE  A6C4                            LDA     ,U              ; LOAD STATUS REGISTER
FAE0  44                              LSRA                    ; TEST RECEIVER REGISTER FLAG
FAE1  2402                            BCC     CIRTN           ; RETURN IF NOTHING
FAE3  A641                            LDA     1,U             ; LOAD DATA BYTE
FAE5  39              CIRTN           RTS                     ; RETURN TO CALLER
                      
                      * CION - INPUT CONSOLE INITIALIZATION
                      * COON - OUTPUT CONSOLE INITIALIZATION
                      * A,X VOLATILE
FAE6                  CION            EQU     *
FAE6  8613            COON            LDA     #$13            ; RESET ACIA CODE
FAE8  9EF0                            LDX     <VECTAB+_ACIA   ; LOAD ACIA ADDRESS
FAEA  A784                            STA     ,X              ; STORE INTO STATUS REGISTER
FAEC  8615                            LDA     #$15            ; SET CONTROL
FAEE  A784                            STA     ,X              ; REGISTER UP
FAF0  39              RTS             RTS                     ; RETURN TO CALLER
                      
                      * THE FOLLOWING HAVE NO DUTIES TO PERFORM
FAF0                  CIOFF           EQU     RTS             ; CONSOLE INPUT OFF
FAF0                  COOFF           EQU     RTS             ; CONSOLE OUTPUT OFF
                      
                      * CODTA - OUTPUT CHARACTER TO CONSOLE DEVICE
                      * INPUT: A=CHARACTER TO SEND
                      * OUTPUT: CHAR SENT TO TERMINAL WITH PROPER PADDING
                      * ALL REGISTERS TRANSPARENT
                      
FAF1  3447            CODTA           PSHS    U,D,CC          ; SAVE REGISTERS,WORK BYTE
FAF3  DEF0                            LDU     <VECTAB+_ACIA   ; ADDRESS ACIA
FAF5  8D1B                            BSR     CODTAO          ; CALL OUTPUT CHAR SUBROUTINE
FAF7  8110                            CMPA    #DLE            ; ? DATA LINE ESCAPE
FAF9  2712                            BEQ     CODTRT          ; YES, RETURN
FAFB  D6F2                            LDB     <VECTAB+_PAD    ; DEFAULT TO CHAR PAD COUNT
FAFD  810D                            CMPA    #CR             ; ? CR
FAFF  2602                            BNE     CODTPD          ; BRANCH NO
FB01  D6F3                            LDB     <VECTAB+_PAD+1  ; LOAD NEW LINE PAD COUNT
FB03  4F              CODTPD          CLRA                    ; CREATE NULL
FB04  E7E4                            STB     ,S              ; SAVE COUNT
FB06  8C                              FCB     SKIP2           ; ENTER LOOP
FB07  8D09            CODTLP          BSR     CODTAO          ; SEND NULL
FB09  6AE4                            DEC     ,S              ; ? FINISHED
FB0B  2AFA                            BPL     CODTLP          ; NO, CONTINUE WITH MORE
FB0D  35C7            CODTRT          PULS    PC,U,D,CC       ; RESTORE REGISTERS AND RETURN
                      
FB0F  17FF5C          CODTAD          LBSR    XQPAUS          ; TEMPORARY GIVE UP CONTROL
FB12  E6C4            CODTAO          LDB     ,U              ; LOAD ACIA CONTROL REGISTER
FB14  C502                            BITB    #$02            ; ? TX REGISTER CLEAR >LSAB FIXME
FB16  27F7                            BEQ     CODTAD          ; RELEASE CONTROL IF NOT
FB18  A741                            STA     1,U             ; STORE INTO DATA REGISTER
FB1A  39                              RTS                     ; RETURN TO CALLER
                      *E
                      
                      * BSON - TURN ON READ/VERIFY/PUNCH MECHANISM
                      * A IS VOLATILE
                      
FB1B  8611            BSON            LDA     #$11            ; SET READ CODE
FB1D  6D66                            TST     6,S             ; ? READ OR VERIFY
FB1F  2601                            BNE     BSON2           ; BRANCH YES
FB21  4C                              INCA                    ; SET TO WRITE
FB22  3F              BSON2           SWI                     ; PERFORM OUTPUT
FB23  01                              FCB     OUTCH           ; FUNCTION
FB24  0C8F                            INC     <MISFLG         ; SET LOAD IN PROGRESS FLAG
FB26  39                              RTS                     ; RETURN TO CALLER
                      
                      * BSOFF - TURN OFF READ/VERIFY/PUNCH MECHANISM
                      * A,X VOLATILE
                      
FB27  8614            BSOFF           LDA     #$14            ; TO DC4 - STOP
FB29  3F                              SWI                     ; SEND OUT
FB2A  01                              FCB     OUTCH           ; FUNCTION
FB2B  4A                              DECA                    ; CHANGE TO DC3 (X-OFF)
FB2C  3F                              SWI                     ; SEND OUT
FB2D  01                              FCB     OUTCH           ; FUNCTION
FB2E  0A8F                            DEC     <MISFLG         ; CLEAR LOAD IN PROGRESS FLAG
FB30  8E61A8                          LDX     #25000          ; DELAY 1 SECOND (2MHZ CLOCK)
FB33  301F            BSOFLP          LEAX    -1,X            ; COUNT DOWN
FB35  26FC                            BNE     BSOFLP          ; LOOP TILL DONE
FB37  39                              RTS                     ; RETURN TO CALLER
                      
                      * BSDTA - READ/VERIFY/PUNCH HANDLER
                      * INPUT: S+6=CODE BYTE, VERIFY(-1),PUNCH(0),LOAD(1)
                      * S+4=START ADDRESS
                      * S+2=STOP ADDRESS
                      * S+0=RETURN ADDRESS
                      * OUTPUT: Z=1 NORMAL COMPLETION, Z=0 INVALID LOAD/VER
                      * REGISTERS ARE VOLATILE
FB38  EE62            BSDTA           LDU     2,S             ; U=TO ADDRESS OR OFFSET
FB3A  6D66                            TST     6,S             ; ? PUNCH
FB3C  2754                            BEQ     BSDPUN          ; BRANCH YES
                      
                      * DURING READ/VERIFY: S+2=MSB ADDRESS SAVE BYTE
                      * S+1=BYTE COUNTER
                      * S+0=CHECKSUM
                      * U HOLDS OFFSET
FB3E  327D                            LEAS    -3,S            ; ROOM FOR WORK/COUNTER/CHECKSUM
FB40  3F              BSDLD1          SWI                     ; GET NEXT CHARACTER
FB41  00                              FCB     INCHNP          ; FUNCTION
FB42  8153            BSDLD2          CMPA    #'S             ; ? START OF S1/S9
FB44  26FA                            BNE     BSDLD1          ; BRANCH NOT
FB46  3F                              SWI                     ; GET NEXT CHARACTER
FB47  00                              FCB     INCHNP          ; FUNCTION
FB48  8139                            CMPA    #'9             ; ? HAVE S9
FB4A  2722                            BEQ     BSDSRT          ; YES, RETURN GOOD CODE
FB4C  8131                            CMPA    #'1             ; ? HAVE NEW RECORD
FB4E  26F2                            BNE     BSDLD2          ; BRANCH IF NOT
FB50  6FE4                            CLR     ,S              ; CLEAR CHECKSUM
FB52  8D21                            BSR     BYTE            ; OBTAIN BYTE COUNT
FB54  E761                            STB     1,S             ; SAVE FOR DECREMENT
                      
                      * READ ADDRESS
FB56  8D1D                            BSR     BYTE            ; OBTAIN HIGH VALUE
FB58  E762                            STB     2,S             ; SAVE IT
FB5A  8D19                            BSR     BYTE            ; OBTAIN LOW VALUE
FB5C  A662                            LDA     2,S             ; MAKE D=VALUE
FB5E  31CB                            LEAY    D,U             ; Y=ADDRESS+OFFSET
                      * STORE TEXT
FB60  8D13            BSDNXT          BSR     BYTE            ; NEXT BYTE
FB62  270C                            BEQ     BSDEOL          ; BRANCH IF CHECKSUM
FB64  6D69                            TST     9,S             ; ? VERIFY ONLY
FB66  2B02                            BMI     BSDCMP          ; YES, ONLY COMPARE
FB68  E7A4                            STB     ,Y              ; STORE INTO MEMORY
FB6A  E1A0            BSDCMP          CMPB    ,Y+             ; ? VALID RAM
FB6C  27F2                            BEQ     BSDNXT          ; YES, CONTINUE READING
FB6E  3592            BSDSRT          PULS    PC,X,A          ; RETURN WITH Z SET PROPER
FB70  4C              BSDEOL          INCA                    ; ? VALID CHECKSUM
FB71  27CD                            BEQ     BSDLD1          ; BRANCH YES
FB73  20F9                            BRA     BSDSRT          ; RETURN Z=0 INVALID
                      
                      * BYTE BUILDS 8 BIT VALUE FROM TWO HEX DIGITS IN
FB75  8D12            BYTE            BSR     BYTHEX          ; OBTAIN FIRST HEX
FB77  C610                            LDB     #16             ; PREPARE SHIFT
FB79  3D                              MUL                     ; OVER TO A
FB7A  8D0D                            BSR     BYTHEX          ; OBTAIN SECOND HEX
FB7C  3404                            PSHS    B               ; SAVE HIGH HEX
FB7E  ABE0                            ADDA    ,S+             ; COMBINE BOTH SIDES
FB80  1F89                            TFR     A,B             ; SEND BACK IN B
FB82  AB62                            ADDA    2,S             ; COMPUTE NEW CHECKSUM
FB84  A762                            STA     2,S             ; STORE BACK
FB86  6A63                            DEC     3,S             ; DECREMENT BYTE COUNT
FB88  39              BYTRTS          RTS                     ; RETURN TO CALLER
                      
FB89  3F              BYTHEX          SWI                     ; GET NEXT HEX
FB8A  00                              FCB     INCHNP          ; CHARACTER
FB8B  1701D4                          LBSR    CNVHEX          ; CONVERT TO HEX
FB8E  27F8                            BEQ     BYTRTS          ; RETURN IF VALID HEX
FB90  35F2                            PULS    PC,U,Y,X,A      ; RETURN TO CALLER WITH Z=0
                      
                      * PUNCH STACK USE:      S+8=TO ADDRESS
                      *                       S+6=RETURN ADDRESS
                      *                       S+4=SAVED PADDING VALUES
                      *                       S+2 FROM ADDRESS
                      *                       S+1=FRAME COUNT/CHECKSUM
                      *                       S+0=BYTE COUNT
                      
FB92  DEF2            BSDPUN          LDU     <VECTAB+_PAD    ; LOAD PADDING VALUES
FB94  AE64                            LDX     4,S             ; X=FROM ADDRESS
FB96  3456                            PSHS    U,X,D           ; CREATE STACK WORK AREA
FB98  CC0018                          LDD     #24             ; SET A=0, B=24
FB9B  D7F2                            STB     <VECTAB+_PAD    ; SETUP 24 CHARACTER PADS
FB9D  3F                              SWI                     ; SEND NULLS OUT
FB9E  01                              FCB     OUTCH           ; FUNCTION
FB9F  C604                            LDB     #4              ; SETUP NEW LINE PAD TO 4
FBA1  DDF2                            STD     <VECTAB+_PAD    ; SETUP PUNCH PADDING
                      * CALCULATE SIZE
FBA3  EC68            BSPGO           LDD     8,S             ; LOAD TO
FBA5  A362                            SUBD    2,S             ; MINUS FROM=LENGTH
FBA7  10830018                        CMPD    #24             ; ? MORE THAN 23
FBAB  2502                            BLO     BSPOK           ; NO, OK
FBAD  C617                            LDB     #23             ; FORCE TO 23 MAX
FBAF  5C              BSPOK           INCB                    ; PREPARE COUNTER
FBB0  E7E4                            STB     ,S              ; STORE BYTE COUNT
FBB2  CB03                            ADDB    #3              ; ADJUST TO FRAME COUNT
FBB4  E761                            STB     1,S             ; SAVE
                      
                      *PUNCH CR,LF,NULS,S,1
FBB6  308C33                          LEAX    <BSPSTR,PCR     ; LOAD START RECORD HEADER
FBB9  3F                              SWI                     ; SEND OUT
FBBA  03                              FCB     PDATA           ; FUNCTION
                      * SEND FRAME COUNT
FBBB  5F                              CLRB                    ; INITIALIZE CHECKSUM
FBBC  3061                            LEAX    1,S             ; POINT TO FRAME COUNT AND ADDR
FBBE  8D27                            BSR     BSPUN2          ; SEND FRAME COUNT
                      *DATA ADDRESS
FBC0  8D25                            BSR     BSPUN2          ; SEND ADDRESS HI
FBC2  8D23                            BSR     BSPUN2          ; SEND ADDRESS LOW
                      *PUNCH DATA
FBC4  AE62                            LDX     2,S             ; LOAD START DATA ADDRESS
FBC6  8D1F            BSPMRE          BSR     BSPUN2          ; SEND OUT NEXT BYTE
FBC8  6AE4                            DEC     ,S              ; ? FINAL BYTE
FBCA  26FA                            BNE     BSPMRE          ; LOOP IF NOT DONE
FBCC  AF62                            STX     2,S             ; UPDATE FROM ADDRESS VALUE
                      *PUNCH CHECKSUM
FBCE  53                              COMB                    ; COMPLEMENT
FBCF  E761                            STB     1,S             ; STORE FOR SENDOUT
FBD1  3061                            LEAX    1,S             ; POINT TO IT
FBD3  8D14                            BSR     BSPUNC          ; SEND OUT AS HEX
FBD5  AE68                            LDX     8,S             ; LOAD TOP ADDRESS
FBD7  AC62                            CMPX    2,S             ; ? DONE
FBD9  24C8                            BHS     BSPGO           ; BRANCH NOT
FBDB  308C11                          LEAX    <BSPEOF,PCR     ; PREPARE END OF FILE
FBDE  3F                              SWI                     ; SEND OUT STRING
FBDF  03                              FCB     PDATA           ; FUNCTION
FBE0  EC64                            LDD     4,S             ; RECOVER PAD COUNTS
FBE2  DDF2                            STD     <VECTAB+_PAD    ; RESTORE
FBE4  4F                              CLRA                    ; SET Z=1 FOR OK RETURN
FBE5  35D6                            PULS    PC,U,X,D        ; RETURN WITH OK CODE
FBE7  EB84            BSPUN2          ADDB    ,X              ; ADD TO CHECKSUM
FBE9  16FDED          BSPUNC          LBRA    ZOUT2H          ; SEND OUT AS HEX AND RETURN
                      
FBEC  530104          BSPSTR          FCB     'S,1,EOT        ; CR,LF,NULLS,S,1
FBEF  53393033303030304643 BSPEOF          FCC     /S9030000FC/            ; EOF STRING
FBF9  0D0A04                          FCB     CR,LF,EOT
                      
                      ********************************************************************************
                      * HSDTA - HIGH SPEED PRINT MEMORY
                      * INPUT: S+4=START ADDRESS
                      * S+2=STOP ADDRESS
                      * S+0=RETURN ADDRESS
                      * X,D VOLATILE
                      ********************************************************************************
                      
                      * SEND TITLE
                      
                      *       "Skip" Address Head TXT
FBFC  3F              HSDTA           SWI                     ; SEND NEW LINE
FBFD  06                              FCB     PCRLF           ; FUNCTION
FBFE  C606                            LDB     #6              ; PREPARE 6 SPACES
FC00  3F              HSBLNK          SWI                     ; SEND BLANK
FC01  07                              FCB     PSPACE          ; FUNCTION
FC02  5A                              DECB                    ; COUNT DOWN
FC03  26FB                            BNE     HSBLNK          ; LOOP IF MORE
                      
                      *       Print (#0-#F) Byte Head TXT
FC05  5F                              CLRB                    ; SETUP BYTE COUNT
FC06  1F98            HSHTTL          TFR     B,A             ; PREPARE FOR CONVERT
FC08  17FDDB                          LBSR    ZOUTHX          ; CONVERT TO A HEX DIGIT
FC0B  3F                              SWI                     ; SEND BLANK
FC0C  07                              FCB     PSPACE          ; FUNCTION
FC0D  3F                              SWI                     ; SEND ANOTHER
FC0E  07                              FCB     PSPACE          ; BLANK
FC0F  5C                              INCB                    ; UP ANOTHER
FC10  C110                            CMPB    #$10            ; ? PAST 'F'
FC12  25F2                            BLO     HSHTTL          ; LOOP UNTIL SO
                      
                      *       Print Line of data bytes (#0-#F)
FC14  3F              HSHLNE          SWI                     ; TO NEXT LINE
FC15  06                              FCB     PCRLF           ; FUNCTION
FC16  252F                            BCS     HSDRTN          ; RETURN IF USER ENTERED CTL-X
                      *       Prt Line Address
FC18  3064                            LEAX    4,S             ; POINT AT ADDRESS TO CONVERT
FC1A  3F                              SWI                     ; PRINT OUT ADDRESS
FC1B  05                              FCB     OUT4HS          ; FUNCTION
                      *       Prt data bytes HEX
FC1C  AE64                            LDX     4,S             ; LOAD ADDRESS PROPER
FC1E  C610                            LDB     #16             ; NEXT SIXTEEN
FC20  3F              HSHNXT          SWI                     ; CONVERT BYTE TO HEX AND SEND
FC21  04                              FCB     OUT2HS          ; FUNCTION
FC22  5A                              DECB                    ; COUNT DOWN
FC23  26FB                            BNE     HSHNXT          ; LOOP IF NOT SIXTEENTH
                      
FC25  3F                              SWI                     ; SEND BLANK
FC26  07                              FCB     PSPACE          ; FUNCTION
                      *       Prt data bytes ASCII
FC27  AE64                            LDX     4,S             ; RELOAD FROM ADDRESS
FC29  C610                            LDB     #16             ; COUNT
FC2B  A680            HSHCHR          LDA     ,X+             ; NEXT BYTE
FC2D  2B04                            BMI     HSHDOT          ; TOO LARGE, TO A DOT
FC2F  8120                            CMPA    #SP             ; ? LOWER THAN A BLANK
FC31  2402                            BHS     HSHCOK          ; NO, BRANCH OK
FC33  862E            HSHDOT          LDA     #'.             ; CONVERT INVALID TO A BLANK
FC35  3F              HSHCOK          SWI                     ; SEND CHARACTER
FC36  01                              FCB     OUTCH           ; FUNCTION
FC37  5A                              DECB                    ; ? DONE
FC38  26F1                            BNE     HSHCHR          ; BRANCH NO
                      *       End of Dump
FC3A  AC62                            CMPX    2,S             ; ? PAST LAST ADDRESS
FC3C  2409                            BHS     HSDRTN          ; QUIT IF SO
FC3E  AF64                            STX     4,S             ; UPDATE FROM ADDRESS
FC40  A665                            LDA     5,S             ; LOAD LOW BYTE ADDRESS
FC42  48                              ASLA                    ; ? TO SECTION BOUNDARY
FC43  26CF                            BNE     HSHLNE          ; BRANCH IF NOT
FC45  20B5                            BRA     HSDTA           ; BRANCH IF SO
FC47  3F              HSDRTN          SWI                     ; SEND NEW LINE
FC48  06                              FCB     PCRLF           ; FUNCTION
FC49  39                              RTS                     ; RETURN TO CALLER
                      *F
                      
                      ***********************************************
                      *       A S S I S T 0 9 C O M M A N D S
                      ***********************************************
                      
                      *************REGISTERS - DISPLAY AND CHANGE REGISTERS
FC4A  8D23            CREG            BSR     REGPRT          ; PRINT REGISTERS
FC4C  4C                              INCA                    ; SET FOR CHANGE FUNCTION
FC4D  8D21                            BSR     REGCHG          ; GO CHANGE, DISPLAY REGISTERS
FC4F  39                              RTS                     ; RETURN TO COMMAND PROCESSOR
                      
                      ********************************************
                      * REGPRT - PRINT/CHANGE REGISTERS SUBROUTINE
                      * WILL ABORT TO 'CMDBAD' IF OVERFLOW DETECTED DURING
                      * A CHANGE OPERATION. CHANGE DISPLAYS REGISTERS WHEN
                      * DONE.
                      
                      * REGISTER MASK LIST CONSISTS OF:
                      * A) CHARACTERS DENOTING REGISTER
                      * B) ZERO FOR ONE BYTE, -1 FOR TWO
                      * C) OFFSET ON STACK TO REGISTER POSITION
                      * INPUT: SP+4=STACKED REGISTERS
                      * A=0 PRINT, A#0 PRINT AND CHANGE
                      * OUTPUT: (ONLY FOR REGISTER DISPLAY)
                      * C=1 CONTROL-X ENTERED, C=0 OTHERWISE
                      * VOLATILE: D,X (CHANGE)
                      * B,X (DISPLAY)
                      *******************************************
                      
FC50  5043FF13        REGMSK          FCB     'P,'C,-1,19     ; PC REG
FC54  41000A                          FCB     'A,0,10         ; A REG
FC57  42000B                          FCB     'B,0,11         ; B REG
FC5A  58FF0D                          FCB     'X,-1,13        ; X REG
FC5D  59FF0F                          FCB     'Y,-1,15        ; Y REG
FC60  55FF11                          FCB     'U,-1,17        ; U REG
FC63  53FF01                          FCB     'S,-1,1         ; S REG
FC66  43430009                        FCB     'C,'C,0,9       ; CC REG
FC6A  4450000C                        FCB     'D,'P,0,12      ; DP REG
FC6E  00                              FCB     0               ; END OF LIST
                      
FC6F  4F              REGPRT          CLRA                    ; SETUP PRINT ONLY FLAG
FC70  30E810          REGCHG          LEAX    4+12,S          ; READY STACK VALUE
FC73  3432                            PSHS    Y,X,A           ; SAVE ON STACK WITH OPTION
FC75  318CD8                          LEAY    REGMSK,PCR      ; LOAD REGISTER MASK
FC78  ECA0            REGP1           LDD     ,Y+             ; LOAD NEXT CHAR OR <=0
FC7A  4D                              TSTA                    ; ? END OF CHARACTERS
FC7B  2F04                            BLE     REGP2           ; BRANCH NOT CHARACTER
FC7D  3F                              SWI                     ; SEND TO CONSOLE
FC7E  01                              FCB     OUTCH           ; FUNCTION BYTE
FC7F  20F7                            BRA     REGP1           ; CHECK NEXT
FC81  862D            REGP2           LDA     #'-             ; READY '-'
FC83  3F                              SWI                     ; SEND OUT
FC84  01                              FCB     OUTCH           ; WITH OUTCH
FC85  30E5                            LEAX    B,S             ; X->REGISTER TO PRINT
FC87  6DE4                            TST     ,S              ; ? CHANGE OPTION
FC89  2612                            BNE     REGCNG          ; BRANCH YES
FC8B  6D3F                            TST     -1,Y            ; ? ONE OR TWO BYTES
FC8D  2703                            BEQ     REGP3           ; BRANCH ZERO MEANS ONE
FC8F  3F                              SWI                     ; PERFORM WORD HEX
FC90  05                              FCB     OUT4HS          ; FUNCTION
FC91  8C                              FCB     SKIP2           ; SKIP BYTE PRINT
FC92  3F              REGP3           SWI                     ; PERFORM BYTE HEX
FC93  04                              FCB     OUT2HS          ; FUNCTION
FC94  ECA0            REG4            LDD     ,Y+             ; TO FRONT OF NEXT ENTRY
FC96  5D                              TSTB                    ; ? END OF ENTRIES
FC97  26DF                            BNE     REGP1           ; LOOP IF MORE
FC99  3F                              SWI                     ; FORCE NEW LINE
FC9A  06                              FCB     PCRLF           ; FUNCTION
FC9B  35B2            REGRTN          PULS    PC,Y,X,A        ; RESTORE STACK AND RETURN
                      
FC9D  8D40            REGCNG          BSR     BLDNNB          ; INPUT BINARY NUMBER
FC9F  2710                            BEQ     REGNXC          ; IF CHANGE THEN JUMP
FCA1  810D                            CMPA    #CR             ; ? NO MORE DESIRED
FCA3  271E                            BEQ     REGAGN          ; BRANCH NOPE
FCA5  E63F                            LDB     -1,Y            ; LOAD SIZE FLAG
FCA7  5A                              DECB                    ; MINUS ONE
FCA8  50                              NEGB                    ; MAKE POSITIVE
FCA9  58                              ASLB                    ; TIMES TWO (=2 OR =4)
FCAA  3F              REGSKP          SWI                     ; PERFORM SPACES
FCAB  07                              FCB     PSPACE                  ; FUNCTION
FCAC  5A                              DECB
FCAD  26FB                            BNE     REGSKP          ; LOOP IF MORE
FCAF  20E3                            BRA     REG4            ; CONTINUE WITH NEXT REGISTER
FCB1  A7E4            REGNXC          STA     ,S              ; SAVE DELIMITER IN OPTION
                      *                                       ; (ALWAYS > 0)
FCB3  DC9B                            LDD     <NUMBER         ; OBTAIN BINARY RESULT
FCB5  6D3F                            TST     -1,Y            ; ? TWO BYTES WORTH
FCB7  2602                            BNE     REGTWO          ; BRANCH YES
FCB9  A682                            LDA     ,-X             ; SETUP FOR TWO
FCBB  ED84            REGTWO          STD     ,X              ; STORE IN NEW VALUE
FCBD  A6E4                            LDA     ,S              ; RECOVER DELIMITER
FCBF  810D                            CMPA    #CR             ; ? END OF CHANGES
FCC1  26D1                            BNE     REG4            ; NO, KEEP ON TRUCK'N
                      * MOVE STACKED DATA TO NEW STACK IN CASE STACK
                      * POINTER HAS CHANGED
FCC3  308DE139        REGAGN          LEAX    TSTACK,PCR      ; LOAD TEMP AREA
FCC7  C615                            LDB     #21             ; LOAD COUNT
FCC9  3502            REGTF1          PULS    A               ; NEXT BYTE
FCCB  A780                            STA     ,X+             ; STORE INTO TEMP
FCCD  5A                              DECB                    ; COUNT DOWN
FCCE  26F9                            BNE     REGTF1          ; LOOP IF MORE
FCD0  10EE88EC                        LDS     -20,X           ; LOAD NEW STACK POINTER
FCD4  C615                            LDB     #21             ; LOAD COUNT AGAIN
FCD6  A682            REGTF2          LDA     ,-X             ; NEXT TO STORE
FCD8  3402                            PSHS    A               ; BACK ONTO NEW STACK
FCDA  5A                              DECB                    ; COUNT DOWN
FCDB  26F9                            BNE     REGTF2          ; LOOP IF MORE
FCDD  20BC                            BRA     REGRTN          ; GO RESTART COMMAND
                      
                      *********************************************
                      * BLDNUM - BUILDS BINARY VALUE FROM INPUT HEX
                      * THE ACTIVE EXPRESSION HANDLER IS USED.
                      * INPUT: S=RETURN ADDRESS
                      * OUTPUT: A=DELIMITER WHICH TERMINATED VALUE
                      * (IF DELM NOT ZERO)
                      * "NUMBER"=WORD BINARY RESULT
                      * Z=1 IF INPUT RECEIVED, Z=0 IF NO HEX RECEIVED
                      * REGISTERS ARE TRANSPARENT
                      **********************************************
                      * EXECUTE SINGLE OR EXTENDED ROM EXPRESSION HANDLER
                      *
                      * THE FLAG "DELIM" IS USED AS FOLLOWS:
                      * DELIM=0 NO LEADING BLANKS, NO FORCED TERMINATOR
                      * DELIM=CHR ACCEPT LEADING 'CHR'S, FORCED TERMINATOR
FCDF  4F              BLDNNB          CLRA                    ; NO DYNAMIC DELIMITER
FCE0  8C                              FCB     SKIP2           ; SKIP NEXT INSTRUCTION
                      * BUILD WITH LEADING BLANKS
FCE1  8620            BLDNUM          LDA     #SP             ; ALLOW LEADING BLANKS
FCE3  978E                            STA     <DELIM          ; STORE AS DELIMITER
FCE5  6E9DE303                        JMP     [VECTAB+_EXPAN,PCR]     ; TO EXP ANALYZER
                      * THIS IS THE DEFAULT SINGLE ROM ANALYZER. WE ACCEPT:
                      * 1) HEX INPUT
                      * 2) 'M' FOR LAST MEMORY EXAMINE ADDRESS
                      * 3) 'P' FOR PROGRAM COUNTER ADDRESS
                      * 4) 'W' FOR WINDOW VALUE
                      * 5) '@' FOR INDIRECT VALUE
                      
FCE9  3414            EXP1            PSHS    X,B             ; SAVE REGISTERS
FCEB  8D5C            EXPDLM          BSR     BLDHXI          ; CLEAR NUMBER, CHECK FIRST CHAR
FCED  2718                            BEQ     EXP2            ; IF HEX DIGIT CONTINUE BUILDING
                      * SKIP BLANKS IF DESIRED
FCEF  918E                            CMPA    <DELIM          ; ? CORRECT DELIMITER
FCF1  27F8                            BEQ     EXPDLM          ; YES, IGNORE IT
                      * TEST FOR M OR P
FCF3  9E9E                            LDX     <ADDR           ; DEFAULT FOR 'M'
FCF5  814D                            CMPA    #'M             ; ? MEMORY EXAMINE ADDR WANTED
FCF7  2716                            BEQ     EXPTDL          ; BRANCH IF SO
FCF9  9E93                            LDX     <PCNTER         ; DEFAULT FOR 'P'
FCFB  8150                            CMPA    #'P             ; ? LAST PROGRAM COUNTER WANTED
FCFD  2710                            BEQ     EXPTDL          ; BRANCH IF SO
FCFF  9EA0                            LDX     <WINDOW         ; DEFAULT TO WINDOW
FD01  8157                            CMPA    #'W             ; ? WINDOW WANTED
FD03  270A                            BEQ     EXPTDL
                      
FD05  3594            EXPRTN          PULS    PC,X,B          ; RETURN AND RESTORE REGISTERS
                      * GOT HEX, NOW CONTINUE BUILDING
FD07  8D44            EXP2            BSR     BLDHEX          ; COMPUTE NEXT DIGIT
FD09  27FC                            BEQ     EXP2            ; CONTINUE IF MORE
FD0B  200A                            BRA     EXPCDL          ; SEARCH FOR +/-
                      * STORE VALUE AND CHECK IF NEED DELIMITER
FD0D  AE84            EXPTDI          LDX     ,X              ; INDIRECTION DESIRED
FD0F  9F9B            EXPTDL          STX     <NUMBER         ; STORE RESULT
FD11  0D8E                            TST     <DELIM          ; ? TO FORCE A DELIMITER
FD13  27F0                            BEQ     EXPRTN          ; RETURN IF NOT WITH VALUE
FD15  8D62                            BSR     READ            ; OBTAIN NEXT CHARACTER
                      * TEST FOR + OR -
FD17  9E9B            EXPCDL          LDX     <NUMBER         ; LOAD LAST VALUE
FD19  812B                            CMPA    #'+             ; ? ADD OPERATOR
FD1B  260E                            BNE     EXPCHM          ; BRANCH NOT
FD1D  8D23                            BSR     EXPTRM          ; COMPUTE NEXT TERM
FD1F  3402                            PSHS    A                ; SAVE DELIMITER
FD21  DC9B                            LDD     <NUMBER         ; LOAD NEW TERM
FD23  308B            EXPADD          LEAX    D,X             ; ADD TO X
FD25  9F9B                            STX     <NUMBER         ; STORE AS NEW RESULT
FD27  3502                            PULS    A                ; RESTORE DELIMITER
FD29  20EC                            BRA     EXPCDL          ; NOW TEST IT
FD2B  812D            EXPCHM          CMPA    #'-             ; ? SUBTRACT OPERATOR
FD2D  2707                            BEQ     EXPSUB          ; BRANCH IF SO
FD2F  8140                            CMPA    #'@             ; ? INDIRECTION DESIRED
FD31  27DA                            BEQ     EXPTDI          ; BRANCH IF SO
FD33  5F                              CLRB                    ; SET DELIMITER RETURN
FD34  20CF                            BRA     EXPRTN          ; AND RETURN TO CALLER
FD36  8D0A            EXPSUB          BSR     EXPTRM          ; OBTAIN NEXT TERM
FD38  3402                            PSHS    A                ; SAVE DELIMITER
FD3A  DC9B                            LDD     <NUMBER         ; LOAD UP NEXT TERM
FD3C  40                              NEGA                    ; NEGATE A
FD3D  50                              NEGB                    ; NEGATE B
FD3E  8200                            SBCA    #0              ; CORRECT FOR A
FD40  20E1                            BRA     EXPADD          ; GO ADD TO EXPRESSION
                      * COMPUTE NEXT EXPRESSION TERM
                      * OUTPUT: X=OLD VALUE
                      * 'NUMBER'=NEXT TERM
FD42  8D9D            EXPTRM          BSR     BLDNUM          ; OBTAIN NEXT VALUE
FD44  2732                            BEQ     CNVRTS          ; RETURN IF VALID NUMBER
FD46  16FC13          BLDBAD          LBRA    CMDBAD          ; ABORT COMMAND IF INVALID
                      
                      *********************************************
                      * BUILD BINARY VALUE USING INPUT CHARACTERS.
                      * INPUT: A=ASCII HEX VALUE OR DELIMITER
                      * SP+0=RETURN ADDRESS
                      * SP+2=16 BIT RESULT AREA
                      * OUTPUT: Z=1 A=BINARY VALUE
                      * Z=0 IF INVALID HEX CHARACTER (A UNCHANGED)
                      * VOLATILE: D
                      ****************************************
FD49  0F9B            BLDHXI          CLR     <NUMBER         ; CLEAR NUMBER
FD4B  0F9C                            CLR     <NUMBER+1       ; CLEAR NUMBER
FD4D  8D2A            BLDHEX          BSR     READ            ; GET INPUT CHARACTER
FD4F  8D11            BLDHXC          BSR     CNVHEX          ; CONVERT AND TEST CHARACTER
FD51  2625                            BNE     CNVRTS          ; RETURN IF NOT A NUMBER
FD53  C610                            LDB     #16             ; PREPARE SHIFT
FD55  3D                              MUL                     ; BY FOUR PLACES
FD56  8604                            LDA     #4              ; ROTATE BINARY INTO VALUE
FD58  58              BLDSHF          ASLB                    ; OBTAIN NEXT BIT
FD59  099C                            ROL     <NUMBER+1       ; INTO LOW BYTE
FD5B  099B                            ROL     <NUMBER         ; INTO HI BYTE
FD5D  4A                              DECA                    ; COUNT DOWN
FD5E  26F8                            BNE     BLDSHF          ; BRANCH IF MORE TO DO
FD60  2014                            BRA     CNVOK           ; SET GOOD RETURN CODE
                      
                      ****************************************
                      * CONVERT ASCII CHARACTER TO BINARY BYTE
                      * INPUT: A=ASCII
                      * OUTPUT: Z=1 A=BINARY VALUE
                      * Z=0 IF INVALID
                      * ALL REGISTERS TRANSPARENT
                      * (A UNALTERED IF INVALID HEX)
                      **************************************
FD62  8130            CNVHEX          CMPA    #'0             ; ? LOWER THAN A ZERO
FD64  2512                            BLO     CNVRTS          ; BRANCH NOT VALUE
FD66  8139                            CMPA    #'9             ; ? POSSIBLE A-F
FD68  2F0A                            BLE     CNVGOT          ; BRANCH NO TO ACCEPT
FD6A  8141                            CMPA    #'A             ; ? LESS THEN TEN
FD6C  250A                            BLO     CNVRTS          ; RETURN IF MINUS (INVALID)
FD6E  8146                            CMPA    #'F             ; ? NOT TOO LARGE
FD70  2206                            BHI     CNVRTS          ; NO, RETURN TOO LARGE
FD72  8007                            SUBA    #7              ; DOWN TO BINARY
FD74  840F            CNVGOT          ANDA    #$0F            ; CLEAR HIGH HEX
FD76  1A04            CNVOK           ORCC    #4              ; FORCE ZERO ON FOR VALID HEX
FD78  39              CNVRTS          RTS                     ; RETURN TO CALLER
                      
                      * GET INPUT CHAR, ABORT COMMAND IF CONTROL-X (CANCEL)
FD79  3F              READ            SWI                     ; GET NEXT CHARACTER
FD7A  00                              FCB     INCHNP          ; FUNCTION
FD7B  8118                            CMPA    #CAN            ; ? ABORT COMMAND
FD7D  27C7                            BEQ     BLDBAD          ; BRANCH TO ABORT IF SO
FD7F  39                              RTS                     ; RETURN TO CALLER
                      *G
                      
                      ***************GO - START PROGRAM EXECUTION
FD80  8D01            CGO             BSR     GOADDR          ; BUILD ADDRESS IF NEEDED
FD82  3B                              RTI                     ; START EXECUTING
                      
                      * FIND OPTIONAL NEW PROGRAM COUNTER. ALSO ARM THE
                      * BREAKPOINTS.
FD83  3530            GOADDR          PULS    Y,X             ; RECOVER RETURN ADDRESS
FD85  3410                            PSHS    X               ; STORE RETURN BACK
FD87  2619                            BNE     GONDFT          ; IF NO CARRIAGE RETURN THEN NEW PC
                      
                      * DEFAULT PROGRAM COUNTER, SO FALL THROUGH IF
                      * IMMEDIATE BREAKPOINT.
FD89  1701B6                          LBSR    CBKLDR          ; SEARCH BREAKPOINTS
FD8C  AE6C                            LDX     12,S            ; LOAD PROGRAM COUNTER
FD8E  5A              ARMBLP          DECB                    ; COUNT DOWN
FD8F  2B16                            BMI     ARMBK2          ; DONE, NONE TO SINGLE TRACE
FD91  A630                            LDA     -NUMBKP*2,Y     ; PRE-FETCH OPCODE
FD93  ACA1                            CMPX    ,Y++            ; ? IS THIS A BREAKPOINT
FD95  26F7                            BNE     ARMBLP          ; LOOP IF NOT
FD97  813F                            CMPA    #$3F            ; ? SWI BREAKPOINTED
FD99  2602                            BNE     ARMNSW          ; NO, SKIP SETTING OF PASS FLAG
FD9B  97FB                            STA     <SWIBFL         ; SHOW UPCOMING SWI NOT BRKPNT
FD9D  0C8F            ARMNSW          INC     <MISFLG         ; FLAG THRU A BREAKPOINT
FD9F  160106                          LBRA    CDOT            ; DO SINGLE TRACE W/O BREAKPOINTS
                      
                      * OBTAIN NEW PROGRAM COUNTER
FDA2  1700BB          GONDFT          LBSR    CDNUM           ; OBTAIN NEW PROGRAM COUNTER
FDA5  ED6C                            STD     12,S            ; STORE INTO STACK
FDA7  170198          ARMBK2          LBSR    CBKLDR          ; OBTAIN TABLE
FDAA  00FA                            NEG     <BKPTCT         ; COMPLEMENT TO SHOW ARMED
FDAC  5A              ARMLOP          DECB                    ; ? DONE
FDAD  2BC9                            BMI     CNVRTS          ; RETURN WHEN DONE
FDAF  A6B4                            LDA     [,Y]            ; LOAD OPCODE
FDB1  A730                            STA     -NUMBKP*2,Y     ; STORE INTO OPCODE TABLE
FDB3  863F                            LDA     #$3F            ; READY "SWI" OPCODE
FDB5  A7B1                            STA     [,Y++]          ; STORE AND MOVE UP TABLE
FDB7  20F3                            BRA     ARMLOP          ; AND CONTINUE
                      
                      *******************CALL - CALL ADDRESS AS SUBROUTINE
FDB9  8DC8            CCALL           BSR     GOADDR          ; FETCH ADDRESS IF NEEDED
FDBB  357F                            PULS    U,Y,X,DP,D,CC   ; RESTORE USERS REGISTERS
FDBD  ADF1                            JSR     [,S++]          ; CALL USER SUBROUTINE
FDBF  3F              CGOBRK          SWI                     ; PERFORM BREAKPOINT
FDC0  0A                              FCB     BRKPT           ; FUNCTION
FDC1  20FC                            BRA     CGOBRK          ; LOOP UNTIL USER CHANGES PC
                      
                      ****************MEMORY - DISPLAY/CHANGE MEMORY
                      * CMEMN AND CMPADP ARE DIRECT ENTRY POINTS FROM
                      * THE COMMAND HANDLER FOR QUICK COMMANDS
FDC3  17009A          CMEM            LBSR    CDNUM           ; OBTAIN ADDRESS
FDC6  DD9E            CMEMN           STD     <ADDR           ; STORE DEFAULT
FDC8  9E9E            CMEM2           LDX     <ADDR           ; LOAD POINTER
FDCA  17FC0C                          LBSR    ZOUT2H          ; SEND OUT HEX VALUE OF BYTE
FDCD  862D                            LDA     #'-             ; LOAD DELIMITER
FDCF  3F                              SWI                     ; SEND OUT
FDD0  01                              FCB     OUTCH           ; FUNCTION
FDD1  17FF0B          CMEM4           LBSR    BLDNNB          ; OBTAIN NEW BYTE VALUE
FDD4  270A                            BEQ     CMENUM          ; BRANCH IF NUMBER
                      * COMA - SKIP BYTE
FDD6  812C                            CMPA    #',             ; ? COMMA
FDD8  260E                            BNE     CMNOTC          ; BRANCH NOT
FDDA  9F9E                            STX     <ADDR           ; UPDATE POINTER
FDDC  3001                            LEAX    1,X             ; TO NEXT BYTE
FDDE  20F1                            BRA     CMEM4           ; AND INPUT IT
FDE0  D69C            CMENUM          LDB     <NUMBER+1       ; LOAD LOW BYTE VALUE
FDE2  8D47                            BSR     MUPDAT          ; GO OVERLAY MEMORY BYTE
FDE4  812C                            CMPA    #',             ; ? CONTINUE WITH NO DISPLAY
FDE6  27E9                            BEQ     CMEM4           ; BRANCH YES
                      * QUOTED STRING
FDE8  8127            CMNOTC          CMPA    #$27            ; ? QUOTED STRING
FDEA  260C                            BNE     CMNOTQ          ; BRANCH NO
FDEC  8D8B            CMESTR          BSR     READ            ; OBTAIN NEXT CHARACTER
FDEE  8127                            CMPA    #$27            ; ? END OF QUOTED STRING
FDF0  270C                            BEQ     CMSPCE          ; YES, QUIT STRING MODE
FDF2  1F89                            TFR     A,B             ; TO B FOR SUBROUTINE
FDF4  8D35                            BSR     MUPDAT          ; GO UPDATE BYTE
FDF6  20F4                            BRA     CMESTR          ; GET NEXT CHARACTER
                      * BLANK - NEXT BYTE
FDF8  8120            CMNOTQ          CMPA    #$20            ; ? BLANK FOR NEXT BYTE
FDFA  2606                            BNE     CMNOTB          ; BRANCH NOT
FDFC  9F9E                            STX     <ADDR           ; UPDATE POINTER
FDFE  3F              CMSPCE          SWI                     ; GIVE SPACE
FDFF  07                              FCB     PSPACE                  ; FUNCTION
FE00  20C6                            BRA     CMEM2           ; NOW PROMPT FOR NEXT
                      
                      * LINE FEED - NEXT BYTE WITH ADDRESS
FE02  810A            CMNOTB          CMPA    #LF             ; ? LINE FEED FOR NEXT BYTE
FE04  2608                            BNE     CMNOTL          ; BRANCH NO
FE06  860D                            LDA     #CR             ; GIVE CARRIAGE RETURN
FE08  3F                              SWI                     ; TO CONSOLE
FE09  01                              FCB     OUTCH           ; HANDLER
FE0A  9F9E                            STX     <ADDR           ; STORE NEXT ADDRESS
FE0C  200A                            BRA     CMPADP          ; BRANCH TO SHOW
                      
                      * UP ARROW - PREVIOUS BYTE AND ADDRESS
FE0E  815E            CMNOTL          CMPA    #'^             ; ? UP ARROW FOR PREVIOUS BYTE
FE10  260A                            BNE     CMNOTU          ; BRANCH NOT
FE12  301E                            LEAX    -2,X            ; DOWN TO PREVIOUS BYTE
FE14  9F9E                            STX     <ADDR           ; STORE NEW POINTER
FE16  3F              CMPADS          SWI                     ; FORCE NEW LINE
FE17  06                              FCB     PCRLF           ; FUNCTION
FE18  8D07            CMPADP          BSR     PRTADR          ; GO PRINT ITS VALUE
FE1A  20AC                            BRA     CMEM2           ; THEN PROMPT FOR INPUT
                      
                      * SLASH - NEXT BYTE WITH ADDRESS
FE1C  812F            CMNOTU          CMPA    #'/             ; ? SLASH FOR CURRENT DISPLAY
FE1E  27F6                            BEQ     CMPADS          ; YES, SEND ADDRESS
FE20  39                              RTS                     ; RETURN FROM COMMAND
                      
                      * PRINT CURRENT ADDRESS
FE21  9E9E            PRTADR          LDX     <ADDR           ; LOAD POINTER VALUE
FE23  3410                            PSHS    X                ; SAVE X ON STACK
FE25  30E4                            LEAX    ,S              ; POINT TO IT FOR DISPLAY
FE27  3F                              SWI                     ; DISPLAY POINTER IN HEX
FE28  05                              FCB     OUT4HS          ; FUNCTION
FE29  3590                            PULS    PC,X            ; RECOVER POINTER AND RETURN
                      
                      * UPDATE BYTE
FE2B  9E9E            MUPDAT          LDX     <ADDR           ; LOAD NEXT BYTE POINTER
FE2D  E780                            STB     ,X+             ; STORE AND INCREMENT X
FE2F  E11F                            CMPB    -1,X            ; ? SUCCESFULL STORE
FE31  2603                            BNE     MUPBAD          ; BRANCH FOR '?' IF NOT
FE33  9F9E                            STX     <ADDR           ; STORE NEW POINTER VALUE
FE35  39                              RTS                     ; BACK TO CALLER
FE36  3402            MUPBAD          PSHS    A               ; SAVE A REGISTER
FE38  863F                            LDA     #'?             ; SHOW INVALID
FE3A  3F                              SWI                     ; SEND OUT
FE3B  01                              FCB     OUTCH           ; FUNCTION
FE3C  3582                            PULS    PC,A            ; RETURN TO CALLER
                      
                      ********************WINDOW - SET WINDOW VALUE
FE3E  8D20            CWINDO          BSR     CDNUM           ; OBTAIN WINDOW VALUE
FE40  DDA0                            STD     <WINDOW         ; STORE IT IN
FE42  39                              RTS                     ; END COMMAND
                      
                      ******************DISPLAY - HIGH SPEED DISPLAY MEMORY
FE43  8D1B            CDISP           BSR     CDNUM           ; FETCH ADDRESS
FE45  C4F0                            ANDB    #$F0            ; FORCE TO 16 BOUNDARY
FE47  1F02                            TFR     D,Y             ; SAVE IN Y
FE49  302F                            LEAX    15,Y            ; DEFAULT LENGTH
FE4B  2504                            BCS     CDISPS          ; BRANCH IF END OF INPUT
FE4D  8D11                            BSR     CDNUM           ; OBTAIN COUNT
FE4F  30AB                            LEAX    D,Y             ; ASSUME COUNT, COMPUTE END ADDR
FE51  3430            CDISPS          PSHS    Y,X             ; SETUP PARAMETERS FOR HSDATA
FE53  10A362                          CMPD    2,S             ; ? WAS IT COUNT
FE56  2302                            BLS     CDCNT           ; BRANCH YES
FE58  EDE4                            STD     ,S              ; STORE HIGH ADDRESS
FE5A  AD9DE184        CDCNT           JSR     [VECTAB+_HSDTA,PCR] ; CALL PRINT ROUTINE
FE5E  35E0                            PULS    PC,U,Y          ; CLEAN STACK AND END COMMAND
                      
                      * OBTAIN NUMBER - ABORT IF NONE
                      * ONLY DELIMITERS OF CR, BLANK, OR '/' ARE ACCEPTED
                      * OUTPUT: D=VALUE, C=1 IF CARRIAGE RETURN DELMITER,
                      * ELSE C=0
FE60  17FE7E          CDNUM           LBSR    BLDNUM          ; OBTAIN NUMBER
FE63  2609                            BNE     CDBADN          ; BRANCH IF INVALID
FE65  812F                            CMPA    #'/             ; ? VALID DELIMITER
FE67  2205                            BHI     CDBADN          ; BRANCH IF NOT FOR ERROR
FE69  810E                            CMPA    #CR+1           ; LEAVE COMPARE FOR CARRIAGE RET
FE6B  DC9B                            LDD     <NUMBER         ; LOAD NUMBER
FE6D  39                              RTS                     ; RETURN WITH COMPARE
FE6E  16FAEB          CDBADN          LBRA    CMDBAD          ; RETURN TO ERROR MECHANISM
                      
                      *****************PUNCH - PUNCH MEMORY IN S1-S9 FORMAT
FE71  8DED            CPUNCH          BSR     CDNUM           ; OBTAIN START ADDRESS
FE73  1F02                            TFR     D,Y             ; SAVE IN Y
FE75  8DE9                            BSR     CDNUM           ; OBTAIN END ADDRESS
FE77  6FE2                            CLR     ,-S             ; SETUP PUNCH FUNCTION CODE
FE79  3426                            PSHS    Y,D             ; STORE VALUES ON STACK
FE7B  AD9DE165        CCALBS          JSR     [VECTAB+_BSON,PCR] ; INITIALIZE HANDLER
FE7F  AD9DE163                        JSR     [VECTAB+_BSDTA,PCR] ; PERFORM FUNCTION
FE83  3401                            PSHS    CC              ; SAVE RETURN CODE
FE85  AD9DE15F                        JSR     [VECTAB+_BSOFF,PCR] ; TURN OFF HANDLER
FE89  3501                            PULS    CC              ; OBTAIN CONDITION CODE SAVED
FE8B  26E1                            BNE     CDBADN          ; BRANCH IF ERROR
FE8D  35B2                            PULS    PC,Y,X,A         ; RETURN FROM COMMAND
                      
                      *****************LOAD - LOAD MEMORY FROM S1-S9 FORMAT
FE8F  8D01            CLOAD           BSR     CLVOFS          ; CALL SETUP AND PASS CODE
FE91  01                              FCB     1                ; LOAD FUNCTION CODE FOR PACKET
                      
FE92  33F1            CLVOFS          LEAU    [,S++]          ; LOAD CODE IN HIGH BYTE OF U
FE94  33D4                            LEAU    [,U]            ; NOT CHANGING CC AND RESTORE S
FE96  2703                            BEQ     CLVDFT          ; BRANCH IF CARRIAGE RETURN NEXT
FE98  8DC6                            BSR     CDNUM           ; OBTAIN OFFSET
FE9A  8C                              FCB     SKIP2           ; SKIP DEFAULT OFFSET
FE9B  4F              CLVDFT          CLRA                    ; CREATE ZERO OFFSET
FE9C  5F                              CLRB                    ; AS DEFAULT
FE9D  344E                            PSHS    U,DP,D          ; SETUP CODE, NULL WORD, OFFSET
FE9F  20DA                            BRA     CCALBS          ; ENTER CALL TO BS ROUTINES
                      
                      ******************VERIFY - COMPARE MEMORY WITH FILES
FEA1  8DEF            CVER            BSR     CLVOFS          ; COMPUTE OFFSET IF ANY
FEA3  FF                              FCB     -1              ; VERIFY FNCTN CODE FOR PACKET
                      
                      *******************TRACE - TRACE INSTRUCTIONS
                      ******************* . - SINGLE STEP TRACE
FEA4  8DBA            CTRACE          BSR     CDNUM           ; OBTAIN TRACE COUNT
FEA6  DD91                            STD     <TRACEC         ; STORE COUNT
FEA8  3262            CDOT            LEAS    2,S             ; RID COMMAND RETURN FROM STACK
FEAA  EEF80A          CTRCE3          LDU     [10,S]          ; LOAD OPCODE TO EXECUTE
FEAD  DF99                            STU     <LASTOP         ; STORE FOR TRACE INTERRUPT
FEAF  DEF6                            LDU     <VECTAB+_PTM    ; LOAD PTM ADDRESS
FEB1  CC0701                          LDD     #$0701          ; 7,1 CYCLES DOWN+CYCLES UP
FEB4  ED42                            STD     PTMTM1-PTM,U    ; START NMI TIMEOUT
FEB6  3B                              RTI                     ; RETURN FOR ONE INSTRUCTION
                      
                      *************NULLS      -       SET NEW LINE AND CHAR PADDING
FEB7  8DA7            CNULLS          BSR     CDNUM           ; OBTAIN NEW LINE PAD
FEB9  DDF2                            STD     <VECTAB+_PAD    ; RESET VALUES
FEBB  39                              RTS                     ; END COMMAND
                      
                      ******************STLEVEL - SET STACK TRACE LEVEL
FEBC  2705            CSTLEV          BEQ     STLDFT          ; TAKE DEFAULT
FEBE  8DA0                            BSR     CDNUM           ; OBTAIN NEW STACK LEVEL
FEC0  DDF8                            STD     <SLEVEL         ; STORE NEW ENTRY
FEC2  39                              RTS                     ; TO COMMAND HANDLER
FEC3  306E            STLDFT          LEAX    14,S            ; COMPUTE NMI COMPARE
FEC5  9FF8                            STX     <SLEVEL         ; AND STORE IT
FEC7  39                              RTS                     ; END COMMAND
                      
                      ******************OFFSET - COMPUTE SHORT AND LONG
                      ******************                      BRANCH OFFSETS
FEC8  8D96            COFFS           BSR     CDNUM           ; OBTAIN INSTRUCTION ADDRESS
FECA  1F01                            TFR     D,X             ; USE AS FROM ADDRESS
FECC  8D92                            BSR     CDNUM           ; OBTAIN TO ADDRESS
                      * D=TO INSTRUCTION, X=FROM INSTRUCTION OFFSET BYTE(S)
FECE  3001                            LEAX    1,X             ; ADJUST FOR *+2 SHORT BRANCH
FED0  3430                            PSHS    Y,X             ; STORE WORK WORD AND VALUE ON S
FED2  A3E4                            SUBD    ,S              ; FIND OFFSET
FED4  EDE4                            STD     ,S              ; SAVE OVER STACK
FED6  3061                            LEAX    1,S             ; POINT FOR ONE BYTE DISPLAY
FED8  1D                              SEX                     ; SIGN EXTEND LOW BYTE
FED9  A1E4                            CMPA    ,S              ; ? VALID ONE BYTE OFFSET
FEDB  2602                            BNE     COFNO1          ; BRANCH IF NOT
FEDD  3F                              SWI                     ; SHOW ONE BYTE OFFSET
FEDE  04                              FCB     OUT2HS          ; FUNCTION
FEDF  EEE4            COFNO1          LDU     ,S              ; RELOAD OFFSET
FEE1  335F                            LEAU    -1,U            ; CONVERT TO LONG BRANCH OFFSET
FEE3  EF84                            STU     ,X              ; STORE BACK WHERE X POINTS NOW
FEE5  3F                              SWI                     ; SHOW TWO BYTE OFFSET
FEE6  05                              FCB     OUT4HS          ; FUNCTION
FEE7  3F                              SWI                     ; FORCE NEW LINE
FEE8  06                              FCB     PCRLF           ; FUNCTION
FEE9  3596                            PULS    PC,X,D          ; RESTORE STACK AND END COMMAND
                      *H
                      
                      *************BREAKPOINT - DISPLAY/ENTER/DELETE/CLEAR
                      *************           BREAKPOINTS
FEEB  2723            CBKPT           BEQ     CBKDSP          ; BRANCH DISPLAY OF JUST 'B'
FEED  17FDF1                          LBSR    BLDNUM          ; ATTEMPT VALUE ENTRY
FEF0  272C                            BEQ     CBKADD          ; BRANCH TO ADD IF SO
FEF2  812D                            CMPA    #'-             ; ? CORRECT DELIMITER
FEF4  263F                            BNE     CBKERR          ; NO, BRANCH FOR ERROR
FEF6  17FDE8                          LBSR    BLDNUM          ; ATTEMPT DELETE VALUE
FEF9  2703                            BEQ     CBKDLE          ; GOT ONE, GO DELETE IT
FEFB  0FFA                            CLR     <BKPTCT         ; WAS 'B -', SO ZERO COUNT
FEFD  39              CBKRTS          RTS                     ; END COMMAND
                      * DELETE THE ENTRY
FEFE  8D40            CBKDLE          BSR     CBKSET          ; SETUP REGISTERS AND VALUE
FF00  5A              CBKDLP          DECB                    ; ? ANY ENTRIES IN TABLE
FF01  2B32                            BMI     CBKERR          ; BRANCH NO, ERROR
FF03  ACA1                            CMPX    ,Y++            ; ? IS THIS THE ENTRY
FF05  26F9                            BNE     CBKDLP          ; NO, TRY NEXT
                      * FOUND, NOW MOVE OTHERS UP IN ITS PLACE
FF07  AEA1            CBKDLM          LDX     ,Y++            ; LOAD NEXT ONE UP
FF09  AF3C                            STX     -4,Y            ; MOVE DOWN BY ONE
FF0B  5A                              DECB                    ; ? DONE
FF0C  2AF9                            BPL     CBKDLM          ; NO, CONTINUE MOVE
FF0E  0AFA                            DEC     <BKPTCT         ; DECREMENT BREAKPOINT COUNT
FF10  8D2E            CBKDSP          BSR     CBKSET          ; SETUP REGISTERS AND LOAD VALUE
FF12  27E9                            BEQ     CBKRTS          ; RETURN IF NONE TO DISPLY
FF14  30A1            CBKDSL          LEAX    ,Y++            ; POINT TO NEXT ENTRY
FF16  3F                              SWI                     ; DISPLAY IN HEX
FF17  05                              FCB     OUT4HS          ; FUNCTION
FF18  5A                              DECB                    ; COUNT DOWN
FF19  26F9                            BNE     CBKDSL          ; LOOP IF NGABLE RAM
FF1B  3F                              SWI                     ; SKIP TO NEW LINK
FF1C  06                              FCB     PCRLF           ; FUNCTIONRTS
FF1D  39                              RTS
                      
                      *       ADD NEW ENTRY
FF1E  8D20            CBKADD          BSR     CBKSET          ; SETUP REGISTERS
FF20  C108                            CMPB    #NUMBKP         ; ? ALREADY FULL
FF22  2711                            BEQ     CBKERR          ; BRANCH ERROR IF SO
FF24  A684                            LDA     ,X              ; LOAD BYTE TO TRAP
FF26  E784                            STB     ,X              ; TRY TO CHANGE
FF28  E184                            CMPB    ,X              ; ? CHANGEABLE RAM
FF2A  2609                            BNE     CBKERR          ; BRANCH ERROR IF NOT
FF2C  A784                            STA     ,X              ; RESTORE BYTE
FF2E  5A              CBKADL          DECB                    ; COUNT DOWN
FF2F  2B07                            BMI     CBKADT          ; BRANCH IF DONE TO ADD IT
FF31  ACA1                            CMPX    ,Y++            ; ? ENTRY ALREADY HERE
FF33  26F9                            BNE     CBKADL          ; LOOP IF NOT
FF35  16FA24          CBKERR          LBRA    CMDBAD          ; RETURN TO ERROR PRODUCE
FF38  AFA4            CBKADT          STX     ,Y              ; ADD THIS ENTRY
FF3A  6F31                            CLR     -NUMBKP*2+1,Y   ; CLEAR OPTIONAL BYTE
FF3C  0CFA                            INC     <BKPTCT         ; ADD ONE TO COUNT
FF3E  20D0                            BRA     CBKDSP          ; AND NOW DISPLAY ALL OF 'EM
                      *       SETUP REGISTERS FOR SCAN
FF40  9E9B            CBKSET          LDX     <NUMBER         ; LOAD VALUE DESIRED
FF42  318DE06C        CBKLDR          LEAY    BKPTBL,PCR      ; LOAD START OF TABLE
FF46  D6FA                            LDB     <BKPTCT         ; LOAD ENTRY COUNT
FF48  39                              RTS                     ; RETURN
                      
                      *************** ENCODE  -       ENCODE A POSTBYTE
FF49  6FE2            CENCDE          CLR     ,-S             ; DEFAULT TO NOT INDIRECT
FF4B  5F                              CLRB                    ; ZERO POSTBYTE VALUE
FF4C  308C3F                          LEAX    <CONV1,PCR      ; START TABLE SEARCH
FF4F  3F                              SWI                     ; OBTAIN FIRST CHARACTER
FF50  00                              FCB     INCHNP          ; FUNCTION
FF51  815B                            CMPA    #'[             ; ? INDIRECT HERE
FF53  2606                            BNE     CEN2            ; BRANCH IF NOT
FF55  8610                            LDA     #$10            ; SET INDIRECT BIT ON
FF57  A7E4                            STA     ,S              ; SAVE FOR LATER
FF59  3F              CENGET          SWI                     ; OBTAIN NEXT CHARACTER
FF5A  00                              FCB     INCHNP          ; FUNCTION
FF5B  810D            CEN2            CMPA    #CR             ; ? END OF ENTRY
FF5D  270C                            BEQ     CEND1           ; BRANCH YES
FF5F  6D84            CENLP1          TST     ,X              ; ? END OF TABLE
FF61  2BD2                            BMI     CBKERR          ; BRANCH ERROR IF SO
FF63  A181                            CMPA    ,X++            ; ? THIS THE CHARACTER
FF65  26F8                            BNE     CENLP1          ; BRANCH IF NOT
FF67  EB1F                            ADDB    -1,X            ; ADD THIS VALUE
FF69  20EE                            BRA     CENGET          ; GET NEXT INPUT
FF6B  308C49          CEND1           LEAX    <CONV2,PCR      ; POINT AT TABLE 2
FF6E  1F98                            TFR     B,A             ; SAVE COPY IN A
FF70  8460                            ANDA    #$60            ; ISOLATE REGISTER MASK
FF72  AAE4                            ORA     ,S              ; ADD IN INDIRECTION BIT
FF74  A7E4                            STA     ,S              ; SAVE BACK AS POSTBYTE SKELETON
FF76  C49F                            ANDB    #$9F            ; CLEAR REGISTER BITS
FF78  6D84            CENLP2          TST     ,X              ; ? END OF TABLE
FF7A  27B9                            BEQ     CBKERR          ; BRANCH ERROR IF SO
FF7C  E181                            CMPB    ,X++            ; ? SAME VALUE
FF7E  26F8                            BNE     CENLP2          ; LOOP IF NOT
FF80  E61F                            LDB     -1,X            ; LOAD RESULT VALUE
FF82  EAE4                            ORB     ,S              ; ADD TO BASE SKELETON
FF84  E7E4                            STB     ,S              ; SAVE POSTBYTE ON STACK
FF86  30E4                            LEAX    ,S              ; POINT TO IT
FF88  3F                              SWI                     ; SEND OUT AS HEX
FF89  04                              FCB     OUT2HS          ; FUNCTION
FF8A  3F                              SWI                     ; TO NEXT LINE
FF8B  06                              FCB     PCRLF           ; FUNCTION
FF8C  3584                            PULS    PC,B            ; END OF COMMAND
                      
                      * TABLE ONE DEFINES VALID INPUT IN SEQUENCE
FF8E                  CONV1
FF8E  4104420544064801                 FCB     'A,$04,'B,$05,'D,$06,'H,$01
FF96  4801480148002C00                 FCB     'H,$01,'H,$01,'H,$00,',,$00
FF9E  2D092D0153705930                 FCB     '-,$09,'-,$01,'S,$70,'Y,$30
FFA6  555058102B072B01                 FCB     'U,$50,'X,$10,'+,$07,'+,$01
FFAE  5080430052005D00                 FCB     'P,$80,'C,$00,'R,$00,'],$00
FFB6  FF                              FCB     $FF             ; END OF TABLE
                      
                      * CONV2 USES ABOVE CONVERSION TO SET POSTBYTE
                      * BIT SKELETON.
FFB7                  CONV2
FFB7  10841100                        FDB     $1084,$1100             ; R,    H,R
FFBB  12881389                        FDB     $1288,$1389             ; HH,R  HHHH,R
FFBF  14861585                        FDB     $1486,$1585             ; A,R   B,R
FFC3  168B1780                        FDB     $168B,$1780             ; D,R   ,R+
FFC7  18811982                        FDB     $1881,$1982             ; ,R++  ,-R
FFCB  1A83828C                        FDB     $1A83,$828C             ; ,--R  HH,PCR
FFCF  838D039F                        FDB     $838D,$039F             ; HHHH,PCR [HHHH]
FFD3  00                              FCB     0                       ; END OF TABLE
                      
                      ************************************************************************
                      *               DEFAULT INTERRUPT TRANSFERS                             *
                      ************************************************************************
FFD4  6E9DDFEE        RSRVD           JMP     [VECTAB+_RSVD,PCR]      ; RESERVED VECTOR
FFD8  6E9DDFEC        SWI3            JMP     [VECTAB+_SWI3,PCR]      ; SWI3 VECTOR
FFDC  6E9DDFEA        SWI2            JMP     [VECTAB+_SWI2,PCR]      ; SWI2 VECTOR
FFE0  6E9DDFE8        FIRQ            JMP     [VECTAB+_FIRQ,PCR]      ; FIRQ VECTOR
FFE4  6E9DDFE6        IRQ             JMP     [VECTAB+_IRQ,PCR]       ; IRQ VECTOR
FFE8  6E9DDFE4        SWI             JMP     [VECTAB+_SWI,PCR]       ; SWI VECTOR
FFEC  6E9DDFE2        NMI             JMP     [VECTAB+_NMI,PCR]       ; NMI VECTOR
                      
                      *               HW INTerupt Vector section
                      *               ===============================
                      ************************************************************************
                      *               ASSIST09 HARDWARE VECTOR TABLE
                      * THIS TABLE IS USED IF THE ASSIST09 ROM ADDRESSES
                      * THE MC6809 HARDWARE VECTORS.
                      ************************************************************************
FFF0                                  ORG     ROMBEG+ROMSIZ-16        ; SETUP HARDWARE VECTORS
FFF0  FFD4                            FDB     RSRVD                   ; RESERVED SLOT
FFF2  FFD8                            FDB     SWI3                    ; SOFTWARE INTERRUPT 3
FFF4  FFDC                            FDB     SWI2                    ; SOFTWARE INTERRUPT 2
FFF6  FFE0                            FDB     FIRQ                    ; FAST INTERRUPT REQUEST
FFF8  FFE4                            FDB     IRQ                     ; INTERRUPT REQUEST
FFFA  FFE8                            FDB     SWI                     ; SOFTWARE INTERRUPT
FFFC  FFEC                            FDB     NMI                     ; NON-MASKABLE INTERRUPT
FFFE  F837                            FDB     RESET                   ; RESTART
F181                                  END
